var IFB=IFB||{};IFB.VERSION=IFB.VERSION||{};IFB.VERSION.CORE="0.0.0";IFB.Services=IFB.Services||{};IFB.Services.Streaming=IFB.Services.Streaming||{};IFB.Services.Streaming.CONNECTION=null;IFB.Services.Domain="infobolsa.es";IFB.Services.baseURL="http://wtst.infobolsa.es/WTRest";IFB.Services.ExternalUsersUrl="http://wtst.infobolsa.es/ExternalUsers";IFB.Services.StreamingBaseUrl="http://ifbwtsptest.infobolsa.es/WTServerRT";IFB.Services.PortfolioUrl="http://ifbwtsptest.infobolsa.es/WTPF/WTPF/Portfolio";IFB.Services.AUTH_TOKEN="TEMPORARYTOKEN";IFB.Services.Session="";IFB.Services.Profile="";IFB.Services.RetryLimit=1;IFB.Services.AnswerError='{"status": {"ok": false, "reason": "The maximum retry count has been exceeded with no response"}}';IFB.Router=IFB.Router||{};IFB.Models=IFB.Models||{};IFB.Collections=IFB.Collections||{};IFB.Views=IFB.Views||{};IFB.Views.HighStock=IFB.Views.HighStock||{};IFB.Renderers=IFB.Renderers||{};IFB.Utils=IFB.Utils||{};IFB.Pages=IFB.Pages||{};IFB.Components=IFB.Components||{};IFB.Templates=IFB.Templates||{};IFB.Templates.baseURL="../../templates";IFB.Templates.Versioned=false;IFB.Product="";IFB.Language="";IFB.ClientConfiguration=null;IFB.Events={};_.extend(IFB.Events,Backbone.Events);IFB.Urls=IFB.Urls||{};IFB.Urls.CompanyLogos="http://www.infobolsa.es/img/logos/96/";IFB.Urls.InteractiveChartBaseUrl="http://ifbwtsptest.infobolsa.es";IFB.Settings=IFB.Settings||{};IFB.Settings.GmtOffset=0;var Highcharts=Highcharts||{};if(Highcharts.setOptions){Highcharts.setOptions({lang:{months:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],weekdays:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],shortMonths:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]},credits:{enabled:false}})}IFB.Utils=IFB.Utils||{};IFB.Class=function(Parent,props){if(!Parent){Parent=Object}var hasOwn=Object.prototype.hasOwnProperty;var Child=function(){Child.prototype.initialize.apply(this,arguments)};var F=function(){};F.prototype=Parent.prototype;Child.prototype=new F;Child.parent=Parent.prototype;Child.prototype.constructor=Child;var prop;for(prop in props){if(props.hasOwnProperty(prop)){Child.prototype[prop]=props[prop]}}return Child};IFB.ActivityManager={activityManagerInfobolsa:undefined,activityManagerProduct:undefined,activitySourcePage:undefined,COMPONENT:{APPLICATION:"APLIC",INSTRUMENT_DETAIL:"VVALOR",BOLETA:"BOLETA",TRADING_ORDERS_BOOK:"LO",TRADING_POSITION:"PO"},ACTION:{LOGOUT:"LOGOUT",LOGIN:"LOGIN",BUY:"COMPRAR",SELL:"VENDER",MODIFY_BUY:"MODIFICARCOMPRA",MODIFY_SELL:"MODIFICARVENTA",PERQUOTE:"PERQUOTE",INSTRUMENT_DETAIL_OPEN_TAB:"VVALOR_SOLAPA",CANCEL_BUY:"CANCELAR_COMPRA",CANCEL_SELL:"CANCELAR_VENTA",CANCEL_ALL_BUY:"CANCELAR_TODAS_COMPRAS",CANCEL_ALL_SELL:"CANCELAR_TODAS_VENTAS",LOAD_ORDER_BOOK:"CONSULTA_LIBRO_ORDENES",LOAD_OPEN_POSITION:"CONSULTA_POSICION_ABIERTA",LOAD_ACCOUNTS:"CONSULTA_CUENTAS"},SOURCE:{BROWSER:"NAVEGADOR",APPLICATION:"APLIC",MENU:"MENU",VALUES_LIST:"LV",INSTRUMENT_DETAIL:"VVALOR",TRADING_ORDERS_BOOK:"LO",TRADING_POSITION:"POS",FILE:"FICH",GRAPHIC:"GRAF",SEARCH:"BUSCADOR",HOME:"HOME",BOLETA:"BOLETA",FAVORITES:"FAVORITOS",ERRORS:"ERRORES",NEWSDETAIL:"NOTICIA",NEWSRANGE:"NOTICIA",NEWSCRITERIA:"NOTICIA"},initialize:function(options){var dataGeneral=IFB.Utils.ProductConfig.getGeneral();if(dataGeneral.Actividad){var activityInfobolsa=dataGeneral.Actividad.Infobolsa;if(activityInfobolsa){var configInfobolsa=this.getConfigRequest(activityInfobolsa,options.eventsTrace);configInfobolsa.isActivityInfobolsa=true;this.activityManagerInfobolsa=new IFB.Services.Activity(configInfobolsa)}var activityProduct=dataGeneral.Actividad.Producto;if(activityProduct){var configProduct=this.getConfigRequest(activityProduct,options.eventsTrace);this.activityManagerProduct=new IFB.Services.Activity(configProduct)}}},getConfigRequest:function(activityData,eventsTrace){return{Url:activityData.Url,Params:activityData.Parametros,responseFormatJson:false,eventsTrace:eventsTrace}},notify:function(component,action,params,source){source=source||this.activitySourcePage;if(this.activityManagerInfobolsa){this.activityManagerInfobolsa.notify(component,action,params,source)}if(this.activityManagerProduct){this.activityManagerProduct.notify(component,action,params,source)}}};IFB.TraderClass=IFB.Class(null,{defaults:{},enable:false,sessionID:"",server:"",baseURL:"",streamingBaseURL:"",configTrader:{},accounts:[],ordersAlerted:[],ordersStatusNotifications:undefined,registeredOrders:false,tradableMarkets:[],orderStatus:{ORDER_NEW:"0",ORDER_REJECTED:"8",ORDER_STOPPED_VT:"Z",ORDER_PARTIAL_FILL:"1",ORDER_FILLED:"2",ORDER_DONEFORDAY:"3",ORDER_CANCELED:"4",ORDER_PENDING_CANCEL:"6",ORDER_STOPPED:"7",ORDER_SUSPENDED:"9",ORDER_PENDING_NEW:"A",ORDER_CALCULATED:"B",ORDER_EXPIRED:"C",ORDER_ACCEPTED_FOR_BIDDING:"D",ORDER_PENDING_REPLACE:"E",ORDER_WAITING:"W"},statusNotifications:{NONE:"1",ALL:"2",INMARKET:"3"},orderTypeOptions:{LIMIT:{text:"Limitada",value:"2"},MARKET:{text:"Mercado",value:"1"},MARKET_TO_LIMIT:{text:"Por lo mejor",value:"K"},STOP:{text:"Stop mercado",value:"3"},STOP_LIMIT:{text:"Stop Limitada",value:"4"},STOP_MARKET:{text:"Stop por lo mejor",value:"5"}},sideOptions:{BUY:{text:"Comprar",value:"1"},SELL:{text:"Vender",value:"2"}},webTraderConnected:function(context){var self=context;if(self.ordersStatusNotifications!==self.statusNotifications.NONE){self.registerOrders()}},initialize:function(options){this.server=options.baseURL||"wtst.infobolsa.es";this.streamingServer=options.streamingBaseURL||"streamingst.infobolsa.es";this.baseURL="//"+this.server+"/WTServerTD/ServiceTrader.svc";this.streamingBaseURL="//"+this.streamingServer+"/WTServerTD/ServiceTrader.svc";this.setAccounts(options.accounts);this.sessionID=options.session;this.startTrading(options)},getFirstTradableAccount:function(){return _.find(this.accounts,function(account){return account.tradable===true})},getFirstTradableAccountID:function(){var firstTradable=this.getFirstTradableAccount();if(firstTradable){return firstTradable.id}},getFirstTradableAccountName:function(){var firstTradable=this.getFirstTradableAccount();if(firstTradable){return firstTradable.name}},setAccounts:function(queryAccounts){var self=this;if(queryAccounts){var arrayAccounts=queryAccounts.split(";");_.each(arrayAccounts,function(account){var parameters=account.split(":");var jsonAccount={id:parameters[0],name:self.getNameFromParameters(parameters),tradable:parameters.length===1||parameters.length>1&&parameters[1]==="1"};self.accounts.push(jsonAccount)})}},getNameFromParameters:function(parameters){var name=parameters.length>2?parameters[2]:parameters[0];name=parameters.length>1&&parameters[1]!=="1"?name+" (no operable)":name;return name},getAccountFromName:function(accountName){return _.find(this.accounts,function(account){return account.name===accountName})},getIdAccount:function(accountName){var account=this.getAccountFromName(accountName);if(account){return account.id}return},getAccountNameFromId:function(accountID){var findAccount=_.find(this.accounts,function(account){return account.id===accountID});if(findAccount){return findAccount.name}return},getAccountsList:function(index){return this.getAccountsArray().join(",")},getAccountsOrderBook:function(index){return this.getAccountsList()},getAccountsArray:function(index){var accounts=[];_.each(this.accounts,function(account){accounts.push(account.id)});return accounts},startTrading:function(options){var mgService=new IFB.Services.Management;mgService.getProfile({session:this.sessionID,canalessubcanales:"2902"},{_function:this.callbackProfileTrading,params:options.callbackInitialize},this)},callbackProfileTrading:function(response,context,callbackInit){var self=context;var responseJson=JSON.parse(response);if(responseJson.status.ok&&responseJson.answer!=="0"){if(responseJson.answer.PROFILE!==undefined){if(responseJson.answer.PROFILE.CS!==null){if(responseJson.answer.PROFILE.CS.CS2902==="1"){self.enable=true}}}}self.getConfigTrader(callbackInit)},getNotifications:function(){var notifications=this.statusNotifications.INMARKET;if(this.configTrader.Notificaciones&&this.configTrader.Notificaciones.EstadoOrden){notifications=this.configTrader.Notificaciones.EstadoOrden}return notifications},getPath:function(){var path="/WTServerTD";if(this.configTrader.Servidor&&this.configTrader.Servidor.Ruta){path=this.configTrader.Servidor.Ruta}return path},getConfigTrader:function(callbackInit){this.configTrader=IFB.Utils.ProductConfig.getContratacion();this.fillTradableMarket(IFB.Utils.ProductConfig.getAcciones());this.ordersStatusNotifications=this.getNotifications();var ruta=this.getPath();this.baseURL="//"+this.server+ruta+"/ServiceTrader.svc";this.streamingBaseURL="//"+this.streamingServer+ruta+"/ServiceTrader.svc";this.startStreamingTrading();if(callbackInit&&"function"===typeof callback){callbackInit()}},fillTradableMarket:function(actions){var actionBuy=_.find(actions.Accion,function(action){return action.Tipo="Comprar"});if(actionBuy){this.tradableMarkets=actionBuy.LM.split(",")}},startStreamingTrading:function(){IFB.Services.Trading.CONNECTION=new IFB.Services.Trading({baseURL:this.baseURL||"",streamingBaseURL:this.streamingBaseURL||"",session:this.sessionID,serverLinkOrders:this.configTrader.Enlaces.Ordenes,serverLinkRisks:this.configTrader.Enlaces.Carteras});IFB.Services.Trading.CONNECTION.initCall({callback:this.callbackInit},this)},callbackInit:function(response,context){var self=context;IFB.Services.Trading.CONNECTION.startStreaming(self.webTraderConnected,self)},getTraderEnabledCls:function(){return this.enable?"":"hide"},getAccounts:function(){return this.accounts.join(",")},getBaseURL:function(){return this.baseURL},getOrderTypeText:function(orderType){var orderTypeText=this._findOrderType(orderType);return orderTypeText.text},getOrderType:function(orderType){var orderTypeText=this._findOrderType(orderType);return orderTypeText.value},_findOrderType:function(orderType){var orderTypeText=_.find(this.orderTypeOptions,function(orderTypeElement){return orderTypeElement.value===orderType},this);return orderTypeText},getSideText:function(side){var sideText=_.find(this.sideOptions,function(sideElement){return sideElement.value===side},this);return sideText.text},registerOrders:function(){var accountsTradables=this.getAccountsOrderBook();if(IFB.Services.Trading.CONNECTION){if(this.registeredOrders===true){IFB.Services.Trading.CONNECTION.unregisterEvents({accounts:accountsTradables,informationType:IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS,callback:this.onUpdateDataTrader,context:this})}IFB.Services.Trading.CONNECTION.registerRT({accounts:accountsTradables,descriptors:this.getDescriptorsRegisterOrders(),informationType:IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS,context:this,callback:this.onUpdateDataTrader});this.registeredOrders=true;IFB.Services.Trading.CONNECTION.getOrderBook({accounts:accountsTradables,descriptors:this.getDescriptorsRegisterOrders(),informationType:IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS,history:"N",context:this,callback:this.callbackGetOrders})}},getDescriptorsRegisterOrders:function(){return["6024","6204","6217","6035","6214","6205"]},callbackGetOrders:function(response,context){var self=context;if(response!==undefined&&response.status&&response.answer!==undefined){var orderID;var orderStatus;_.each(response.answer,function(order){if(order!==undefined){orderID=order[IFB.Descriptors.Trader.Key.descriptor];orderStatus=order[IFB.Descriptors.Trader.OrderStatusFIX.descriptor];switch(this.ordersStatusNotifications){case this.statusNotifications.INMARKET:if(orderStatus===self.orderStatus.ORDER_REJECTED||orderStatus===self.orderStatus.ORDER_NEW||orderStatus===self.orderStatus.ORDER_STOPPED_VT){self.ordersAlerted.push(orderID)}break;case this.ordersStatusNotifications.ALL:break}}})}},unregisterOrders:function(){this.domElementsMap={};if(IFB.Services.Trading.CONNECTION){IFB.Services.Trading.CONNECTION.unregisterRT({accounts:IFB.Trader.getAccountsList(),informationType:streamingType,callback:this.onUpdateDataTrader})}},onUpdateDataTrader:function(order,key){if(this.notifyAvailable(order)){this.showNotify(order)}},notifyAvailable:function(order){switch(this.ordersStatusNotifications){case this.statusNotifications.INMARKET:{var orderId=order[IFB.Descriptors.Trader.Key.descriptor];var orderStatus=order[IFB.Descriptors.Trader.OrderStatusFIX.descriptor];var orderType=order[IFB.Descriptors.Trader.OrderTypeFIX.descriptor];if(orderStatus===this.orderStatus.ORDER_REJECTED){this.ordersAlerted.push(orderId);return true}else if(orderStatus===this.orderStatus.ORDER_NEW&&orderType!==this.orderTypeOptions.STOP.value&&orderType!==this.orderTypeOptions.STOP_MARKET.value&&orderType!==this.orderTypeOptions.STOP_LIMIT.value||orderStatus===this.orderStatus.ORDER_STOPPED_VT&&(orderType===this.orderTypeOptions.STOP.value||orderType===this.orderTypeOptions.STOP_MARKET.value||orderType===this.orderTypeOptions.STOP_LIMIT.value)){var orderExistsInArray=_.find(this.ordersAlerted,function(orderIdInArray){return orderId===orderIdInArray});if(!orderExistsInArray){this.ordersAlerted.push(orderId);return true}}}break;case this.statusNotifications.ALL:return true}return false},showNotify:function(order){var status=order[IFB.Descriptors.Trader.OrderStatusFIX.descriptor];var rejectReason=order[IFB.Descriptors.Trader.RejectReason.descriptor];var rejectCodeFIX=order[IFB.Descriptors.Trader.RejectCodeFIX.descriptor];switch(status){case this.orderStatus.ORDER_REJECTED:this.showOrderRejected(rejectCodeFIX,rejectReason);break;default:this.showOrderStatusNotifications(status);break}},showOrderStatusNotifications:function(status){var text="";switch(status){case this.orderStatus.ORDER_NEW:text="Orden enviada al Mercado.";break;case this.orderStatus.ORDER_PARTIAL_FILL:text="Orden parcialmente ejecutada";break;case this.orderStatus.ORDER_FILLED:text="Orden ejecutada";break;case this.orderStatus.ORDER_DONEFORDAY:text="Orden validez de dia caducada";break;case this.orderStatus.ORDER_CANCELED:text="Orden cancelada";break;case this.orderStatus.ORDER_PENDING_CANCEL:text="Orden pendiente de cancelar";break;case this.orderStatus.ORDER_STOPPED:text="Orden parada";break;case this.orderStatus.ORDER_SUSPENDED:text="Orden suspendida";break;case this.orderStatus.ORDER_PENDING_NEW:text="Orden enviada";break;case this.orderStatus.ORDER_CALCULATED:text="Orden completada";break;case this.orderStatus.ORDER_EXPIRED:text="Orden expirada";break;case this.orderStatus.ORDER_ACCEPTED:text="Orden aceptada y evaluandose";break;case this.orderStatus.ORDER_PENDING_REPLACE:text="Orden pendiente de modificar";break;case this.orderStatus.ORDER_WAITING:text="Orden esperando confirmación";break;case this.orderStatus.ORDER_STOPPED_VT:text="Orden retenida";break;default:text="Estado de la orden a "+status;break}this.showNotification(text)},showOrderRejected:function(code,reason){if($.noty){this.showNotification('Su orden ha sido rechazada.<br/><b><a href="#!/errors/'+code+'" onclick="$.noty.closeAll();">'+reason+"</a>")}else{this.showNotification('Su orden ha sido rechazada.<br/><b><a href="#!/errors/'+code+'">'+reason+"</a>")}},showNotification:function(text){var buttons=[{text:"Aceptar"}];IFB.Utils.Helper.showNotification("information",text,true,buttons)},isTradable:function(MV){if(this.enable){var index=_.indexOf(this.tradableMarkets,MV.substring(0,2));return index>=0}return false},showWindowConfirmationOrderCV:function(){return this.configTrader.BoletaConfirmarCV!=="0"},showWindowConfirmationOrderModify:function(){return this.configTrader.BoletaConfirmarModificar!=="0"},showWindowConfirmationOrderBookCancel:function(){return this.configTrader.LOConfirmarCancelar!=="0"}});IFB.Utils.Analytics=function(){function _getTrackEventURL(session,userType,component,action,value,extraParam1){var root=IFB.Services.baseURL.replace("WTRest","");var url=root+"WTServerMG/Evento.srf?";url+="sesion="+session;url+="&tipoUsuario="+userType.substr(0,5);url+="&componente="+component.substr(0,5);url+="&accion="+action.substr(0,1);url+="&valor="+value.substr(0,15);url+="&param1="+extraParam1.substr(0,1);url+="&_dc="+(new Date).getTime();return url}function trackEvent(userType,component,action,value,extraParam1){var src=_getTrackEventURL(IFB.Services.Session,userType,component,action,value,extraParam1);var oImg=document.createElement("img");oImg.setAttribute("src",src);oImg.setAttribute("height","0");oImg.setAttribute("width","0");oImg.setAttribute("style","position:absolute; visibility:hidden");return}return{trackEvent:trackEvent}}();IFB.Utils.Colors=function(){function hex2rgb(hex,opacity){if(!hex){return""}var rgb=hex.replace("#","").match(/(.{2})/g);var i=3;while(i--){rgb[i]=parseInt(rgb[i],16)}if(typeof opacity==="undefined"){return"rgb("+rgb.join(", ")+")"}return"rgba("+rgb.join(", ")+", "+opacity+")"}return{hex2rgb:hex2rgb}}();var IFB=IFB||{};IFB.Constants={Highcharts:{ChartTypes:{}}};getHighchartsTypes();function getHighchartsTypes(){if(!Highcharts.getOptions){return}_.each(Highcharts.getOptions().plotOptions,function(value,key,list){IFB.Constants.Highcharts.ChartTypes[key]=key})}var IFB=IFB||{};IFB.Defaults={Components:{InstrumentDetail:{serviceParams:{type:"GET",data:{type:"6",header:"80,240,420,250,60,70,390,410,1147,370,380,642,856,9565",rt:"1",sort:"-1"}}},TopFlopActive:{serviceParams:{type:"GET",data:{header:"10305,80,420,250,370,390,410,1147,10307",rt:"1",numVals:"3"}}},ChartDaily:{serviceParams:{type:"GET",data:{dateStart:moment().add("years",-1).format("YYYYMMDD"),dateEnd:moment().format("YYYYMMDD"),frequency:"d",type:"6"}}},ChartIntraday:{serviceParams:{type:"GET",data:{date:moment().format("YYYYMMDD"),compressionMult:"5",isSession:"1",type:"6"}}},Bubbles:{serviceParams:{type:"GET",data:{type:"1",header:"250",rt:"1",sort:"-1"}}},SignificantFactNearby:{serviceParams:{type:"GET",data:{type:"4"}}},Dividends:{serviceParams:{type:"GET",data:{dateStart:moment().add("years",-1).format("YYYYMMDD"),dateEnd:moment().add("years",1).format("YYYYMMDD"),type:"4"}}},InstrumentList:{serviceParams:{type:"GET",data:{type:"1",header:"420,250,3002,670,9469,9472,1838,10307,642,1147",rt:"1",sort:"10307"}}},News:{serviceParams:{type:"GET",data:{numberOfItems:50}}},NewsCriteria:{serviceParams:{type:"GET",numberOfItems:50,data:{detailFormat:0}}},NewsRange:{serviceParams:{type:"GET",data:{fechaDesde:moment().format("YYYYMMDD"),fechaHasta:moment().format("YYYYMMDD")}}},OrdersBook:{serviceParams:{url:"//wtst.infobolsa.es",type:"POST",data:{descriptorsTrader:"6009,6017,6024,6027,6031,6033,6035,6043,6201,6202,6203,6204,6205,6206,6208,6209,6212,6211,6213,6214,6216,6217,6098,6084"}}},OpenPosition:{serviceParams:{url:"//wtst.infobolsa.es",type:"POST",data:{descriptorsTrader:"6052,6303,6301,6302,6305,6306,6307",type:"6",header:"420",rt:"1",sort:"-1"}}},Accounts:{serviceParams:{url:"//wtst.infobolsa.es",type:"POST",data:{descriptorsTrader:"Cuenta,EfectivoInicial,EfectivoCompra,EfectivoVenta,EfectivoDisponible"}}},Balances:{serviceParams:{url:"//wtst.infobolsa.es",type:"POST",data:{}}},ConsensusEvolution:{serviceParams:{type:"GET",data:{type:"2",param:"0;49;{MV},29(02)-29(04)-29(27)-29(28)-29(29)-29(30)-29(31)-29(32)-29(26),{DATE_INIT},{PERIOD}",tipoBusqueda:"F"},table:"T29"}},Positions:{serviceParams:{type:"GET",data:{type:"4",header:"735,350,740,330,340,750,360,642",numVals:"10"}}},AlertList:{serviceParams:{type:"POST",data:{}}},Transactions:{serviceParams:{type:"POST",data:{}}},Columnado:{serviceParams:{type:"POST",data:{tipo:"1",defecto:"0",agrupado:"1"}}}}};var IFB=IFB||{};IFB.Descriptors={_3MonthReturnClose:{descriptor:"D9470"},_12MonthsReturnClose:{descriptor:"D9472"},_2YearsReturnClose:{descriptor:"D9473"},_3YearsReturn:{descriptor:"D1118"},_3YearsReturnClose:{descriptor:"D9474"},_4YearsReturnClose:{descriptor:"D9499"},_5YearsReturnClose:{descriptor:"D2129"},_52WeeksDateHigh:{descriptor:"D5101"},_52WeeksDateLow:{descriptor:"D5102"},_52WeeksHigh:{descriptor:"D568"},_52WeeksLow:{descriptor:"D591"},_3T13:{descriptor:"D4223"},AskOrders:{descriptor:"D360"},AskPrice:{descriptor:"D340"},AskVolume:{descriptor:"D750"},AssetType:{descriptor:"D9558"},AverageDailyVolume_1Mouth:{descriptor:"D91"},Bancomer_Accion_CancelarOrden:{descriptor:"D1585"},Bancomer_Accion_DetalleOrden:{descriptor:"D1589"},Bancomer_Capitalization:{descriptor:"D936"},Bancomer_Estado:{descriptor:"D1572",sortType:"string"},Bancomer_Folio:{descriptor:"D1565"},Bancomer_Operacion:{descriptor:"D1567",sortType:"string"},Bancomer_Titulos:{descriptor:"D1577"},Bancomer_Ultimo:{descriptor:"D1538"},Bancomer_ValorHoyEstimado:{descriptor:"D1571"},BidOrders:{descriptor:"D350"},BidPrice:{descriptor:"D330"},BidVolume:{descriptor:"D740"},BPA:{descriptor:"D1610"},Bursatility:{descriptor:"D9839"},Buy:{descriptor:"D1291"},CA_FundKIID:{descriptor:"D3014"},CA_FundProspectus:{descriptor:"D3011"},CA_FundQuarterlyReport:{descriptor:"D3013"},CA_FundReporting:{descriptor:"D3012"},CA_FundRules:{descriptor:"D3009"},CA_FundType:{descriptor:"D3005"},Capitalization:{descriptor:"D935"},Cash:{descriptor:"D670"},Category:{descriptor:"D9875"},Center:{descriptor:"D27"},Change:{descriptor:"D240"},ChangePercent:{descriptor:"D250"},ChangePercent_CurrentYear:{descriptor:"D64"},ChangePercent_CurrentYear_TR:{descriptor:"D1776"},ChangePercent_LastYear:{descriptor:"D2271"},ChangePercent_2YearsAgo:{descriptor:"D2272"},ChangePercent_3YearsAgo:{descriptor:"D2273"},ChangePercent_4YearsAgo:{descriptor:"D2274"},ClientInstrumentTicker:{descriptor:"D10305",sortType:"string"},ClientInstrumentType:{descriptor:"D10311"},ClientIsin:{descriptor:"D10303"},Close:{descriptor:"D370"},ConstituentsCode:{descriptor:"D856"},Country:{descriptor:"D9565"},CorporateName:{descriptor:"D9833"},Coupon:{descriptor:"D9830"},Currency:{descriptor:"D133"},Date:{descriptor:"D60"},DateLastUpdate:{descriptor:"D1562"},DateOrTime:{descriptor:"D3002",sortType:"string"},DateOrTimeSituationMessage:{descriptor:"D3004",sortType:"string"},DayAvgVolume:{descriptor:"D1210"},Decimals:{descriptor:"D1147"},Dividend_FiscalYear:{descriptor:"D1940"},Dividend_GrossValue:{descriptor:"D2120"},Dividend_PaymentDate:{descriptor:"D1990",sortType:"string"},Dividend_Type:{descriptor:"D1820",sortType:"string"},DividendYield:{descriptor:"D1420"},EBITDA_Previous:{descriptor:"D4241"},EBITDA_3T13:{descriptor:"D4240"},EBITDA_Percent:{descriptor:"D4225"},Emisora:{descriptor:"D9828",sortType:"string"},EqualCount:{descriptor:"D8780"},ETF_Benchmark:{descriptor:"D9770",sortType:"string"},ETF_Geographic_Area:{descriptor:"D9773"},ETF_Sector:{descriptor:"D9774"},ETF_Style:{descriptor:"D9772",sortType:"string"},ETF_Type:{descriptor:"D9771",sortType:"string"},ETF_Description:{descriptor:"D9523",sortType:"string"},ExpiryDate:{descriptor:"D9857"},FACTSET_Capitalization:{descriptor:"D9776"},FACTSET_DividendYield:{descriptor:"D1838"},FACTSET_DividendYield_NextYear:{descriptor:"D1839"},FACTSET_DividendYield_Next2Year:{descriptor:"D1841"},FACTSET_DividendYield_Next3Year:{descriptor:"D1842"},FACTSET_DividendYield_PreviousYear:{descriptor:"D1837"},FACTSET_EBITDA:{descriptor:"D1866"},FACTSET_EBITDA_NextYear:{descriptor:"D1867"},FACTSET_EBITDA_Next2Year:{descriptor:"D1868"},FACTSET_EBITDA_Next3Year:{descriptor:"D1869"},FACTSET_EBITDA_PreviousYear:{descriptor:"D1865"},FACTSET_EPS:{descriptor:"D1811"},FACTSET_EPS_NextYear:{descriptor:"D1812"},FACTSET_EPS_Next2Year:{descriptor:"D1823"},FACTSET_EPS_Next3Year:{descriptor:"D1824"},FACTSET_EPS_PreviousYear:{descriptor:"D1809"},FACTSET_EstimationPeriod:{descriptor:"D1796"},FACTSET_EstimationPeriod_NextYear:{descriptor:"D1797"},FACTSET_EstimationPeriod_Next1Year:{descriptor:"D1798"},FACTSET_EstimationPeriod_Next2Year:{descriptor:"D1799"},FACTSET_EstimationPeriod_PreviousYear:{descriptor:"D1794"},FACTSET_NetDividend:{descriptor:"D1833"},FACTSET_NetDividend_NextYear:{descriptor:"D1834"},FACTSET_NetDividend_Next2Year:{descriptor:"D1835"},FACTSET_NetDividend_Next3Year:{descriptor:"D1836"},FACTSET_NetDividend_PreviousYear:{descriptor:"D1832"},FACTSET_PER:{descriptor:"D1849"},FACTSET_PER_NextYear:{descriptor:"D1851"},FACTSET_PER_Next2Year:{descriptor:"D1852"},FACTSET_PER_Next3Year:{descriptor:"D1853"},FACTSET_PER_PreviousYear:{descriptor:"D1848"},FACTSET_PriceBook:{descriptor:"D1965"},FACTSET_PriceBook_NextYear:{descriptor:"D1966"},FACTSET_PriceBook_Nex2tYear:{descriptor:"D1967"},FACTSET_PriceBook_PreviousYear:{descriptor:"D1964"},FACTSET_PriceCashFlow:{descriptor:"D1877"},FACTSET_PriceCashFlow_NextYear:{descriptor:"D1878"},FACTSET_PriceCashFlow_Nex2tYear:{descriptor:"D1879"},FACTSET_PriceCashFlow_Nex3tYear:{descriptor:"D1881"},FACTSET_PriceCashFlow_PreviousYear:{descriptor:"D1876"},FACTSET_Period:{descriptor:"D5400"},FACTSET_Period_NextYear:{descriptor:"D5401"},FACTSET_Recommendation:{descriptor:"D5570"},FACTSET_RecommendationDate:{descriptor:"D5420"},FACTSET_Recommendation_1Month_Buy:{descriptor:"D1949"},FACTSET_Recommendation_1Month_Overweight:{descriptor:"D1951"},FACTSET_Recommendation_1Month_Hold:{descriptor:"D1952"},FACTSET_Recommendation_1Month_Underweight:{descriptor:"D1953"},FACTSET_Recommendation_1Month_Sell:{descriptor:"D1954"},FACTSET_Recommendation_1Month_Total:{descriptor:"D1955"},FACTSET_RecurrentEarnings:{descriptor:"D1912"},FACTSET_RecurrentEarnings_NextYear:{descriptor:"D1913"},FACTSET_RecurrentEarnings_Next2Year:{descriptor:"D1914"},FACTSET_RecurrentEarnings_Next3Year:{descriptor:"D1915"},FACTSET_RecurrentEarnings_PreviousYear:{descriptor:"D1911"},FACTSET_ROE:{descriptor:"D1872"},FACTSET_ROE_NextYear:{descriptor:"D1873"},FACTSET_ROE_Next2Year:{descriptor:"D1874"},FACTSET_ROE_Next3Year:{descriptor:"D1875"},FACTSET_ROE_PreviousYear:{descriptor:"D1871"},FACTSET_TargetPrice:{descriptor:"D5575"},FACTSET_TargetPriceChangePercent:{descriptor:"D5576"},FACTSET_TargetPriceGap:{descriptor:"D5577"},FlopCount:{descriptor:"D8770"},FONDSMD_ISIN:{descriptor:"D9504"},FriendlyName:{descriptor:"D9563",sortType:"string"},FundChangePercentCurrentYear:{descriptor:"D346"},FundComission:{descriptor:"D9515"},FundCurreny:{descriptor:"D6700"},FundDividendDistribution:{descriptor:"D9708"},FundIssuer:{descriptor:"D9656"},FundLastDate:{descriptor:"D6400"},FundLongName:{descriptor:"D6530"},FundManager:{descriptor:"D955"},FundManagerCode:{descriptor:"D950"},FundType:{descriptor:"D2401"},FundValuationDate:{descriptor:"D281"},HistCash:{descriptor:"D10670"},HistChange:{descriptor:"D10240"},HistChangePercent:{descriptor:"D10250"},HistClose:{descriptor:"D10370"},HistLast:{descriptor:"D10420"},HistOpen:{descriptor:"D10380"},HistSessionLow:{descriptor:"D10410"},HistSessionHigh:{descriptor:"D10390"},HistVolume:{descriptor:"D10710"},IFBLongName:{descriptor:"D10104",sortType:"string"},IFBMarketName:{descriptor:"D25"},IFBShortName:{descriptor:"D10103",sortType:"string"},Index_Consituents_Risers:{descriptor:"D8760"},Index_Consituents_Neutrals:{descriptor:"D8780"},Index_Consituents_Fallers:{descriptor:"D8770"},Industry:{descriptor:"D9758"},InstrumentTicker:{descriptor:"D30",sortType:"string"},InstrumentType:{descriptor:"D9558"},InstrumentSubtype:{descriptor:"D9559"},InstrumentYesterday:{descriptor:"D9837"},Isin:{descriptor:"D40",sortType:"string"},Issuance:{descriptor:"D9838"},IssuedCapital_I:{descriptor:"D9835"},IssuedCapital_II:{descriptor:"D9836"},Issuer:{descriptor:"D9828",sortType:"string"},Last:{descriptor:"D420"},MarketCodeClient:{descriptor:"D10304"},MarketDepth:{descriptor:"D735"},MarketName:{descriptor:"D10314",sortType:"string"},MarketType:{descriptor:"D9846"},MIC:{descriptor:"D9557"},MonthReturn:{descriptor:"D1117"},MonthReturnClose:{descriptor:"D9469"},NetAssetValue:{descriptor:"D6420"},Noesis_RecommendationLong:{descriptor:"D9783"},Noesis_RecommendationLongTerm:{descriptor:"D1071",sortType:"string"},Noesis_RecommendationMedium:{descriptor:"D9782"},Noesis_RecommendationMediumTerm:{descriptor:"D1072"},Noesis_RecommendationShort:{descriptor:"D9781"},Noesis_RecommendationShortTerm:{descriptor:"D1069"},Noesis_ResistancePrimary:{descriptor:"D1055"},Noesis_ResistanceSecondary:{descriptor:"D1056"},Noesis_SupportPrimary:{descriptor:"D1067"},Noesis_SupportSecondary:{descriptor:"D1068"},Noesis_TechnicalSituation:{descriptor:"D899"},Noesis_TechnicalSituationDate:{descriptor:"D926"},Noesis_GeneralAnalysis:{descriptor:"D954"},Noesis_GeneralAnalysisDate:{descriptor:"D956"},Noesis_Shares_Var30:{descriptor:"D2708"},Noesis_Shares_Var30Pct:{descriptor:"D2712"},Noesis_Shares_Var30Text:{descriptor:"D2710"},Noesis_Shares_Var30Class:{descriptor:"D2797"},Noesis_Shares_Beta30:{descriptor:"D2722"},Noesis_Shares_Beta30Text:{descriptor:"D2724"},Noesis_Shares_Beta30Class:{descriptor:"D2727"},Noesis_Shares_Volatility30:{descriptor:"D2750"},Noesis_Shares_Volatility30Text:{descriptor:"D2752"},Noesis_Shares_Volatility30Class:{descriptor:"D2755"},Nominal:{descriptor:"D706"},NominalValue:{descriptor:"D1120"},ON_Previous:{descriptor:"D4231"},ON_3T13:{descriptor:"D4230"},ON_Percent:{descriptor:"D4234"},Open:{descriptor:"D380"},Operations:{descriptor:"D9754"},Operativity:{descriptor:"D9841"},PER:{descriptor:"D1710"},Performance_CalculationDate:{descriptor:"D289"},Placement:{descriptor:"D9886"},PreviousYearClosingPrice:{descriptor:"D1230"},PriceBook:{descriptor:"D1720"},PriceCashFlow:{descriptor:"D1700"},ProfitPerShare:{descriptor:"D1811"},P_FLEPA_Main:{descriptor:"D716"},P_FLEPA_Factor1:{descriptor:"D676"},P_FLEPA_Factor2:{descriptor:"D677"},P_FEPA_Main:{descriptor:"D717"},P_FEPA_Factor1:{descriptor:"D678"},P_FEPA_Factor2:{descriptor:"D679"},P_U_Main:{descriptor:"D683"},P_U_Factor1:{descriptor:"D684"},P_U_Factor2:{descriptor:"D686"},P_VL_Main:{descriptor:"D687"},P_VL_Factor1:{descriptor:"D688"},P_VL_Factor2:{descriptor:"D689"},ReferenceIndex:{descriptor:"D638"},Research_Date:{descriptor:"D5001"},Research_Title:{descriptor:"D5004"},Research_Sector:{descriptor:"D5006"},Research_Subdirection:{descriptor:"D5008"},Rotation:{descriptor:"D1195"},Sales_Previous:{descriptor:"D4221"},Sales_3T13:{descriptor:"D4220"},Sales_Percentage:{descriptor:"D4224"},SampleIndicator:{descriptor:"D9845"},Sector:{descriptor:"D9757"},Sell:{descriptor:"D1292"},Serie:{descriptor:"D9829",sortType:"string"},SERIE_InstrumentType:{descriptor:"D9840"},SessionAverage:{descriptor:"D400"},SessionHigh:{descriptor:"D390"},SessionLow:{descriptor:"D410"},ShareType:{descriptor:"D9827"},SharesToday:{descriptor:"D9860"},ShortName:{descriptor:"D10307",sortType:"string"},Source:{descriptor:"D9834"},Stakeholders:{descriptor:"D6435"},Strike:{descriptor:"D9881"},SubIndustry:{descriptor:"D9759"},SubSector:{descriptor:"D9912"},Symbol:{descriptor:"D9825"},Time:{descriptor:"D70"},TirAverage:{descriptor:"D160"},TirHigh:{descriptor:"D150"},TimeLastUpdate:{descriptor:"D356"},TirLow:{descriptor:"D170"},TopCount:{descriptor:"D8760"},TradedCash:{descriptor:"D8730"},TradingState:{descriptor:"D147"},Trend:{descriptor:"D642"},Underlying:{descriptor:"D9872"},UN_Previous:{descriptor:"D4233"},UN_3T13:{descriptor:"D4232"},UN_Percent:{descriptor:"D4235"},VE_UAIIDA_Main:{descriptor:"D718"},VE_UAIIDA_Factor1:{descriptor:"D681"},VE_UAIIDA_Factor2:{descriptor:"D682"},Volume:{descriptor:"D710"},WeekHigh:{descriptor:"D561"},WeekLow:{descriptor:"D578"},WeekReturnClose:{descriptor:"D9468"},YearHigh:{descriptor:"D1245"},YearLow:{descriptor:"D1255"},YearReturn:{descriptor:"D1114"},YearReturnClose:{descriptor:"D9472"},YearVolume:{descriptor:"D1270"},ClientTradeable:{descriptor:"D10312"},ClientDecimals:{descriptor:"D10313"},OpenPercent:{descriptor:"D3765"},MaxPercent:{descriptor:"D3835"},MedPercent:{descriptor:"D3885"},MinPercent:{descriptor:"D3865"},LastExPercent:{descriptor:"D3785"},MaxAnnPercent:{descriptor:"D3800"},MinAnnPercent:{descriptor:"D3820"},CurrencyVolumes:{descriptor:"D136"},MarketCode:{descriptor:"D20"}};IFB.Descriptors.Trader={AccountFIX:{descriptor:"@D6205"},Assessment:{descriptor:"@D6047"},AssessmentClient:{descriptor:"@D6103"},AssessmentFIX:{descriptor:"@D6126"},AssetType:{descriptor:"@D6136"},AvgPrice:{descriptor:"@D6033"},BalanceAccount:{descriptor:"@D6069"},BalanceCurrency:{descriptor:"@D6068",sortType:"string"},BalanceDescription:{descriptor:"@D6066"},BalanceQuantity:{descriptor:"@D6067"},BORRADO:{descriptor:"@D6134"},CalculatedAssesment:{descriptor:"@D6148"},CancelOrder:{descriptor:"@D6017"},CancelOrderFIX:{descriptor:"@D6215"},CancelQuantity:{descriptor:"@D6045"},CompensationPrice:{descriptor:"@D6064"},CumQuantity:{descriptor:"@D6044"},ExecTypeFIX:{descriptor:"@D6209"},ExpireDateFIX:{descriptor:"@D6208"},Fixing:{descriptor:"@D6133"},FixingCost:{descriptor:"@D6147"},Multiplier:{descriptor:"@D6146"},IntradayFIX:{descriptor:"@D6084"},ISIN:{descriptor:"@D6046"},IsinFIX:{descriptor:"@D6201"},Key:{descriptor:"@D6024"},MaxFloorFIX:{descriptor:"@D6212"},MinQuantityFIX:{descriptor:"@D6211"},ModifyOrder:{descriptor:"@D6054"},MVFIX:{descriptor:"@D6203"},OrderAdmin:{descriptor:"@D6098"},OrderIntraday:{descriptor:"@D6084"},OrderStatus:{descriptor:"@D6029"},OrderStatusFIX:{descriptor:"@D6204",sortType:"string"},OrderTypeFIX:{descriptor:"@D6214"},OrderUserOrigin:{descriptor:"@D6221"},PendingVolume:{descriptor:"@D6032"},PendingVolumeFIX:{descriptor:"@D6216"},PortfolioAccount:{descriptor:"@D6302"},PortfolioBuyPriceFIX:{descriptor:"@D6048"},PortfolioBuyShares:{descriptor:"@D6304"},PortfolioBuyTrade:{descriptor:"@D6306"},PortfolioInitialTrade:{descriptor:"@D6305"},PortfolioKey:{descriptor:"@D6303"},PortfolioMV:{descriptor:"@D6301"},PortfolioSellPriceFIX:{descriptor:"@D6049"},PortfolioSellTrade:{descriptor:"@D6307"},PortfolioShortName:{descriptor:"@D6052",sortType:"string"},PortfolioTitlesFIX:{descriptor:"@D6063"},PortfolioLastPriceSFB:{descriptor:"@D6135"},Price:{descriptor:"@D6043"},PriceBuyClient:{descriptor:"@D6161"},PriceFIX:{descriptor:"@D6207"},ProfitLoss:{descriptor:"@D6065"},Quantity:{descriptor:"@D6031"},QuantityFIX:{descriptor:"@D6206"},Reason:{descriptor:"@D6014"},RejectCodeFIX:{descriptor:"@D6217"},RejectReason:{descriptor:"@D6035"},ShortName:{descriptor:"@D6027",sortType:"string"},Side:{descriptor:"@D6026"},SideFIX:{descriptor:"@D6202",sortType:"string"},State:{descriptor:"@D6009"},StopPriceFIX:{descriptor:"@D6213"},TransactionConcept:{descriptor:"@D6066"},TransactionDate:{descriptor:"@D6076"},TransactionQuantityH:{descriptor:"@D6124"},TransactionBalance:{descriptor:"@D6081"},TransactionQuantityD:{descriptor:"@D6123"},TransactionDH:{descriptor:"@D6083"}};IFB.Descriptors.Trader.Cuentas={Account:{descriptor:"Cuenta"},CashBuy:{descriptor:"EfectivoCompra"},CashAvailable:{descriptor:"EfectivoDisponible"},CashInitial:{descriptor:"EfectivoInicial"},CashSell:{descriptor:"EfectivoVenta"}};IFB.Utils.Favorites={DEFAULT_MV_LENGTH:7,favorites:[],defaults:{loadOnInitialize:true,file:"_~FAVORITOS",type:"GRP",replace:"1",waitForSaveMillis:500,transform:"1"},initialize:function(options,next){_.defaults(this,options||{},this.defaults);_.extend(this,Backbone.Events);this.favorites=[];this.mgService=new IFB.Services.Management({});this.save=this.waitForSaveMillis>0?_.debounce(this._save,this.waitForSaveMillis):this._save;if(this.loadOnInitialize){this.load(next)}else{next(null,this)}},load:function(next){var self=this;this.mgService.loadFile({session:this.session||IFB.Services.Session,file:this.file,type:this.type,transform:this.transform},function(response){try{self.readFavoritesFromFile(response,self);if(_.isFunction(next)){next(null,self,response)}}catch(error){if(_.isFunction(next)){next(error,self,response)}}})},_save:function(next){var self=this;this.mgService.saveFile({session:this.session||IFB.Services.Session,file:this.file,type:this.type,replace:this.replace,content:this.formatContent(this.toString()),transform:this.transform},function(response){if(_.isFunction(next)){next(null,self,response)}})},formatContent:function(favorites){throw new Error("This method must be overrided")},unformatContent:function(content){throw new Error("This method must be overrided")},getAll:function(){return this.favorites||[]},has:function(mv){return this.favorites.indexOf(this.normalize(mv))!==-1},add:function(mv,disableSave){mv=this.normalize(mv);if(!this.has(mv)){this.favorites.push(mv);if(!disableSave){this.save(this.onAddFavorite);this.trigger("add",mv,this.getAll())}}},remove:function(mv,disableSave){mv=this.normalize(mv);if(this.has(mv)){this.favorites=_.without(this.favorites,mv);if(!disableSave){this.save(this.onRemoveFavorite);this.trigger("remove",mv,this.getAll())}}},toggle:function(mv,disableSave){mv=this.normalize(mv);if(this.has(mv)){this.favorites=_.without(this.favorites,mv)}else{this.favorites.push(mv)}if(!disableSave){this.save()}},reset:function(favorites,disableSave){var self=this;this.favorites=[];if(favorites){_.each(_.isArray(favorites)?favorites:[favorites],function(mv){self.add(mv,true)})}if(!disableSave){this.save()}},toString:function(char){return this.favorites.join(char||",")},splitLength:function(s,length){var self=this;length=length||this.DEFAULT_MV_LENGTH;if(s.indexOf(",")!==-1){return _.map(s.split(","),function(mv){return self.normalize(mv)})}else if(s.length<=length){return[this.normalize(s)]}else{var result=[];var i=0;for(i=0;i+length<=s.length;i+=length){result.push(s.substring(i,i+length))}return result}},normalize:function(s,length,char){length=length||this.DEFAULT_MV_LENGTH;return s+(new Array(length+1-s.length)).join(char||" ")},readFavoritesFromFile:function(response,self){var responseJson=JSON.parse(response);if(!IFB.Utils.Helper.getObjectValueIfExists(responseJson,"status.ok")){throw new Error("Invalid response")}self.favorites=self.unformatContent(responseJson.answer)},onAddFavorite:function(){return},onRemoveFavorite:function(){return}};(function(){var format={asNumber:function(value,decimals,zeroValue,positiveSign){var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},stringFormat:function(inputString,params){var args=params;return inputString.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!=="undefined"?args[number]:match})}};IFB.Utils.Format=format})();(function(){var helpers={userInfo:undefined,getQueryStringParam:function(param){param=param.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+param+"=([^&#]*)";var regex=new RegExp(regexS);var value=regex.exec(window.location.search);var result;if(value===null){result=""}else{result=decodeURIComponent(value[1].replace(/\+/g," "))}return result},initializeCulture:function(){if(moment){moment.lang("es")}if(accounting){accounting.settings={currency:{symbol:"€",format:"%v %s",decimal:",",thousand:".",precision:2},number:{precision:0,thousand:".",decimal:","}}}},clone:function(item){var self=this;if(!item){return item}var types=[Number,String,Boolean],result;types.forEach(function(type){if(item instanceof type){result=type(item)}});if(typeof result==="undefined"){if(Object.prototype.toString.call(item)==="[object Array]"){result=[];item.forEach(function(child,index,array){result[index]=IFB.Utils.Helper.clone(child)})}else if(typeof item==="object"){if(item.nodeType&&typeof item.cloneNode==="function"){result=item.cloneNode(true)}else if(!item.prototype){if(item instanceof Date){result=new Date(item)}else{result={};for(var i in item){result[i]=IFB.Utils.Helper.clone(item[i])}}}else{if(false&&item.constructor){result=new item.constructor}else{result=item}}}else{result=item}}return result},serializeObject:function(object){"use strict";var a={};var b=function(b,c){var d=a[c.name];"undefined"!==typeof d&&d!==null?$.isArray(d)?d.push(c.value):a[c.name]=[d,c.value]:a[c.name]=c.value};return $.each(object.serializeArray(),b),a},chartIntradayTooltipFormatter:function(view){return""},chartDailyTooltipFormatter:function(view){return""},getConstituentsCode:function(isin){return isin},translateMarketCode:function(market){return market},getPreOpeningDiffMinutes:function(market){return-30},getFACTSETDescriptorsManager:function(){return undefined},getHistoricDescriptorsConverter:function(){return undefined},showNotification:function(params){},showNotificationTemplate:function(params){},showNotificationConfirmOrder:function(params){},showNotificationCancellationOrder:function(params){},showNotificationReconnecting:function(params){},getUserInfo:function(params){},isIOS:function(){return["iPad","iPhone","iPod","iPad Simulator","iPhone Simulator","iPod Simulator"].indexOf(navigator.platform)!==-1},onBeforeUnload:function(){return IFB.Utils.Helper.callbackOnBeforeUnload()},callbackOnBeforeUnload:function(){},getAndroidVersion:function(ua1){var ua=ua1||navigator.userAgent;var match=ua.match(/Android\s([0-9\.]*)/);return match?match[1]:false},getObjectValueIfExists:function(object,keyPath){if(object){var keys=keyPath.split(".");_.each(keys,function(key){if(object&&object[key]){object=object[key]}else{object=undefined}})}return object},isMobileWidth:function(){return $(window).width()<768},getClickOnDocumentsFixedParams:function(){return},isTabletWidth:function(){return $(window).width()>=768&&$(window).width()<948},hash:function(s,raw,hexcase,chrsz){raw=raw||false;hexcase=hexcase||false;chrsz=chrsz||8;function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function bit_rol(num,cnt){return num<<cnt|num>>>32-cnt}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)}function core_md5(x,len){x[len>>5]|=128<<len%32;x[(len+64>>>9<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd)}return[a,b,c,d]}function str2binl(str){var bin=[];var mask=(1<<chrsz)-1;for(var i=0;i<str.length*chrsz;i+=chrsz){bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<i%32}return bin}function binl2str(bin){var str="";var mask=(1<<chrsz)-1;for(var i=0;i<bin.length*32;i+=chrsz){str+=String.fromCharCode(bin[i>>5]>>>i%32&mask)}return str}function binl2hex(binarray){var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var str="";for(var i=0;i<binarray.length*4;i++){str+=hex_tab.charAt(binarray[i>>2]>>i%4*8+4&15)+hex_tab.charAt(binarray[i>>2]>>i%4*8&15)}return str}return raw?binl2str(core_md5(str2binl(s),s.length*chrsz)):binl2hex(core_md5(str2binl(s),s.length*chrsz))},UTF8_decode:function(str){var output="";var i=c=c1=c2=0;while(i<str.length){c=str.charCodeAt(i);if(c<128){output+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=str.charCodeAt(i+1);output+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=str.charCodeAt(i+1);c3=str.charCodeAt(i+2);output+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return output},UTF8_encode:function(str){var output="";str=str.replace(/\r\n/g,"\n");for(var n=0;n<str.length;n++){var c=str.charCodeAt(n);if(c<128)output+=String.fromCharCode(c);else if(c>127&&c<2048){output+=String.fromCharCode(c>>6|192);output+=String.fromCharCode(c&63|128)}else{output+=String.fromCharCode(c>>12|224);output+=String.fromCharCode(c>>6&63|128);output+=String.fromCharCode(c&63|128)}}return output},getInteractiveChartLanguage:function(iso2LettersCode){switch(iso2LettersCode){case"en":return"en_US";case"ca":return"ca_ES";case"es":return"es_ES";case"fr":return"fr_FR";default:return"es_ES"}},padRight:function(string,length,text){try{return string+Array(length-string.length+1).join(text||" ")}catch(e){return string}}};IFB.Utils.Helper=helpers;window.onbeforeunload=IFB.Utils.Helper.onBeforeUnload})();(function(){defaults={pageSize:10,pageGroup:5,currentPage:undefined,totalPages:undefined,collection:[]};IFB.Utils.Pager=Pager=function(options){_.extend(this,this.config(options))};Pager.prototype={config:function(options){var opts=_.extend(_.defaults({},defaults),options);opts.collection=_.isArray(opts.collection)?opts.collection:[];opts.totalPages=Math.ceil(opts.collection.length/opts.pageSize);opts.currentPage=opts.totalPages>0?1:undefined;return opts},getCurrentPage:function(){return this.currentPage},isFirstPage:function(){return this.currentPage===1},isLastPage:function(){return this.currentPage===this.totalPages},getPrevPage:function(){return this.currentPage-1},getNextPage:function(){return this.currentPage+1},getCurrentPageGroup:function(page){page=page||this.currentPage;totalPages=this.totalPages;var from=Math.floor((page-1)/this.pageGroup)*this.pageGroup+1;var to=Math.min(totalPages,from+this.pageGroup-1);return{from:from,to:to,isFirst:function(){return this.from===1},isLast:function(){return this.to===totalPages}}},isFirstGroup:function(){return this.getCurrentPageGroup().isFirst()},isLastGroup:function(){return this.getCurrentPageGroup().isLast()},getPrevGroupPage:function(){return this.getCurrentPageGroup().from-1},getNextGroupPage:function(){return this.getCurrentPageGroup().to+1},getContent:function(currentPage){currentPage=currentPage||this.currentPage;var from=this.pageSize*(this.currentPage-1);var to=from+Math.min(this.collection.length-from,this.pageSize);return this.collection.slice(from,to)},goToPage:function(page){if(page<1||page>this.totalPages||page===this.currentPage){return false}this.currentPage=page;return true},enumAllPages:function(){var pages=[];var i=1;for(;i<=this.totalPages;i+=1){pages.push(i)}return pages},enumGroupPages:function(){var pages=[];var group=this.getCurrentPageGroup();var i=group.from;for(;i<=group.to;i+=1){pages.push(i)}return pages}}})();IFB.Utils.ProductConfig={productConfiguration:undefined,initializeProductConfig:function(session,callback){var self=this;var mgService=new IFB.Services.Management;mgService.getProductConfig({session:session},function(response){self._readProductConfig(response,callback)},this)},_readProductConfig:function(response,callback){var responseJson=JSON.parse(response);if(responseJson.status.ok&&responseJson.answer!=="0"){if(responseJson.answer!==undefined){this.productConfiguration=responseJson.answer.Configuracion}}if(_.isFunction(callback)){callback()}},getGeneral:function(){return this.productConfiguration.General||{}},getApariencia:function(){return this.productConfiguration.Apariencia||{}},getBuscador:function(){return this.productConfiguration.Buscador||{}},getBuscadorHT:function(){return this.productConfiguration.BuscadorHT||{}},getChart:function(){return this.productConfiguration.Chart||{}},getCE:function(){return this.productConfiguration.CE||{}},getAcciones:function(){return this.productConfiguration.Acciones||{}},getContratacion:function(){return this.productConfiguration.Contratacion||{}},getBuscadorHTPattern:function(){return this.productConfiguration&&this.productConfiguration.BuscadorHT?this.productConfiguration.BuscadorHT.Criterios:{}}};IFB.Utils.ReadStatusConfig={sources:"",sessionDate:undefined,groups:{},DATE_FORMAT:"YYYYMMDD",defaults:{loadOnInitialize:true,file:"MensajesSesionLeidos",type:"NOTIF",replace:"1",waitForSaveMillis:500,transform:"1"},initialize:function(options,next){_.defaults(this,options||{},this.defaults);this.mgService=new IFB.Services.Management({});this.save=this.waitForSaveMillis>0?_.debounce(this._save,this.waitForSaveMillis):this._save;this.sessionDate=this.getDate();if(this.loadOnInitialize){this.load(next)}else{next(null,this)}},load:function(next){var self=this;this.mgService.loadFile({session:this.session||IFB.Services.Session,file:this.file,type:this.type,transform:this.transform},function(response){try{self.onLoadFile(response,self);if(_.isFunction(next)){next(null,self,response)}}catch(error){if(_.isFunction(next)){next(error,self,response)}}})},onLoadFile:function(response){var responseJson=JSON.parse(response);if(!responseJson.status||!responseJson.status.ok){console.log("No se ha podido cargar estado: "+this.file)}else{this.setJsonState(responseJson.answer)}},markAsRead:function(type,id,date){this.checkSessionDate();var sources=type;var group=this.getGroup(type),index=this.findInGroup(group,id);if(index===-1){group.push(id);this.save(date);IFB.Events.trigger("newsMarkedAsRead",{source:type,key:id,date:date},this)}},isRead:function(type,id){var group=this.getGroup(type);var index=this.findInGroup(group,id);return index>-1},getReadItems:function(type){return this.getGroup(type)||[]},_save:function(date,next){var self=this;this.mgService.saveFile({session:this.session||IFB.Services.Session,file:this.file,type:this.type,replace:this.replace,content:JSON.stringify(this.getJsonState()),transform:this.transform},function(response){if(_.isFunction(next)){next(null,self,response)}})},getJsonState:function(){var state={NOT:{FECHA:this.sessionDate,FUENTES:[]}};_.each(this.groups,function(value,key){state.NOT.FUENTES.push({TIPO:key,ITEMS:value})});return state},setJsonState:function(state){var groups=[],items=[],groupsMap={};if(!state.NOT){return}if(!_.isArray(state.NOT.FUENTES)){groups=[state.NOT.FUENTES]}else{groups=state.NOT.FUENTES}_.each(groups,function(group){if(!_.isArray(group.ITEMS)){items=[group.ITEMS]}else{items=group.ITEMS}groupsMap[group.TIPO]=items||[]},this);this.groups=groupsMap;if(state.NOT.FECHA){this.sessionDate=state.NOT.FECHA}},checkSessionDate:function(){var date=this.getDate();if(Number(date)>Number(this.sessionDate)){this.sessionDate=date;this.groups={}}},getGroup:function(type){if(!_.has(this.groups,type)){this.groups[type]=[]}return this.groups[type]},findInGroup:function(group,name){return _.indexOf(group,name)},getDate:function(){return moment().format(this.DATE_FORMAT)}};IFB.Utils.ReversePolishNotation={OPERATOR_ADD:"+",OPERATOR_SUBTRACT:"-",OPERATOR_MULTIPLY:"*",OPERATOR_DIVIDE:"/",TOKEN_DESCRIPTOR:"D",TOKEN_DESCRIPTOR_SUMATOTAL:"T",TOKEN_JSON:"J",TOKEN_NUMERO:"N",TOKEN_CADENA:"C",TOKEN_OPERATOR:"O",TIPO_DESCRIPTOR_NUMERO:"N",formula:undefined,data:{},header:undefined,stack:[],formulaStack:[],instrument:{},initConfig:function(formula,instrument,header){this.instrument=instrument;this.formula=formula;this.data=instrument.data;this.header=header;this.stack=[];this.formulaStack=[]},loadFormula:function(){var self=this;var tokens=this.formula.split("|");_.each(tokens,function(token){self.readToken(token)})},getDescriptorType:function(descriptor){var type=undefined;if(this.header!==undefined){var datosDescriptor=_.find(this.header.collection.models,function(descriptorArray){return descriptorArray.id===descriptor},this);if(datosDescriptor!==undefined){return datosDescriptor.data.type}}return type},getTotalDescriptorValue:function(token){var value=this.getTotalValue("DT"+token.substring(1));switch(this.getDescriptorType(token.substring(1))){case this.TIPO_DESCRIPTOR_NUMERO:return Number(value)}return value},getDescriptorValue:function(token){var header=_.find(this.header.collection.models,function(model){return model.id===token.substring(1)},this);var value=this.instrument.getRawDataFromColumnadoConfig(header);return value},getValue:function(token,datos){if(token===""||typeof token==="undefined"){return}var dato="";switch(token.type){case this.TOKEN_DESCRIPTOR_SUMATOTAL:dato=this.getTotalDescriptorValue(token);break;case this.TOKEN_DESCRIPTOR:dato=this.getDescriptorValue(token);break;case this.TOKEN_JSON:dato=Number(this.getDataValue(token.substr(1)));break;case this.TOKEN_NUMERO:case this.TOKEN_CADENA:dato=Number(token.substr(1));break;default:dato=token;break}return dato},readToken:function(token){if(token===""||typeof token==="undefined"){return}var operandType=token.substr(0,1);switch(operandType){case this.TOKEN_DESCRIPTOR_SUMATOTAL:this.stack.push({type:operandType,value:this.getTotalDescriptorValue(token)});break;case this.TOKEN_DESCRIPTOR:this.stack.push({type:operandType,value:this.getDescriptorValue(token)});break;case this.TOKEN_JSON:this.stack.push({type:operandType,value:Number(this.getDataValue(token.substr(1)))});break;case this.TOKEN_NUMERO:case this.TOKEN_CADENA:this.stack.push({type:operandType,value:Number(token.substr(1))});break;default:this.stack.push({type:this.TOKEN_OPERATOR,value:token});break}},getDataValue:function(dataIndex){var value=this.data[dataIndex];if(value!==undefined){return value}else{return""}},getTotalValue:function(dataIndex){var value=this.data[dataIndex];if(value!==undefined){return value}else{return""}},evaluateFormulaFrom:function(record){var self=this;this.data=record;_.each(this.stack,function(token){if(token.type===self.TOKEN_OPERATOR){self.evaluateOperator(token.value)}else{self.formulaStack.push(self.getValue(token,record))}});return this.formulaStack.pop()},evaluateFormula:function(formula,instrument,header){var self=this;this.initConfig(formula,instrument,header);this.loadFormula();_.each(this.stack,function(token){if(token.type===self.TOKEN_OPERATOR){self.evaluateOperator(token.value)}else{self.formulaStack.push(token.value)}});var evaluatedValue=this.formulaStack.pop();return _.isFinite(evaluatedValue)?evaluatedValue:Number.NaN},evaluateOperator:function(operator){var operand2=this.formulaStack.pop();var operand1=this.formulaStack.pop();switch(operator){case this.OPERATOR_ADD:this.formulaStack.push(operand1+operand2);break;case this.OPERATOR_SUBTRACT:this.formulaStack.push(operand1-operand2);break;case this.OPERATOR_MULTIPLY:this.formulaStack.push(operand1*operand2);break;case this.OPERATOR_DIVIDE:this.formulaStack.push(operand1/operand2);break}},getDescriptors:function(formula){var self=this;var descriptors=[];var tokens=formula.split("|");_.each(tokens,function(token){if(token!==""&&typeof token!=="undefined"){if(token.substr(0,1)===self.TOKEN_DESCRIPTOR){descriptors.push(token)}}});return descriptors}};(function(){var templateLoader={templateVersion:"0.0.10",templates:{},loadRemoteTemplate:function(templateName,filename,callback){if(!this.templates[templateName]){var self=this;$.get(this.getTemplateUrl(filename),function(data){callback(data)})}else{callback(this.templates[templateName])}},addTemplate:function(templateName,data){this.templates[templateName]=data},localStorageAvailable:function(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}},saveLocalTemplates:function(){if(this.localStorageAvailable){localStorage.setItem("templates",JSON.stringify(this.templates));localStorage.setItem("templateVersion",this.templateVersion)}},loadLocalTemplates:function(){if(this.localStorageAvailable){var templateVersion=localStorage.getItem("templateVersion");if(templateVersion&&templateVersion==this.templateVersion){var templates=localStorage.getItem("templates");if(templates){templates=JSON.parse(templates);for(var x in templates){if(!this.templates[x]){this.addTemplate(x,templates[x])}}}}else{localStorage.removeItem("templates");localStorage.removeItem("templateVersion")}}},getTemplateUrl:function(filename){var debug=this.getURLParameter("debug")==="1";if(debug||!IFB.Templates.Versioned){return IFB.Templates.baseURL+filename+"?_dc="+(new Date).getTime()}else{return IFB.Templates.baseURL+"/"+IFB.VERSION.CLIENT+filename}},getURLParameter:function(name){return decodeURI((RegExp(name+"="+"(.+?)(&|$)").exec(location.search)||[,null])[1])}};templateLoader.loadLocalTemplates();IFB.Utils.TemplateLoader=templateLoader})();(function(){var DEFAULT_OPENING_TIME="00:00";var getOpeningTimeFromDescriptors=function(date,tradeTimes){var now=moment();var time=DEFAULT_OPENING_TIME;date=(date&&date.match(/[0-9]{8}/)?moment(date,"YYYYMMDD"):now).format("YYYY-MM-DD");if(tradeTimes){var matches=tradeTimes.match(/[0-9]{2}:[0-9]{2}/);if(_.isArray(matches)&&matches.length>0){time=matches[0]}}return moment(date+"T"+time)};var getLastUpdateTimeFromDescriptors=function(date,time){var lastUpdateTime=moment(date+time,"YYYYMMDDHHmmss");return lastUpdateTime&&lastUpdateTime.isValid()?lastUpdateTime:moment()};var tradeTimeUtils={getTradeTimeStatus:function(date,time,tradingTimes){var openingTime=getOpeningTimeFromDescriptors(date,tradingTimes);return{preOpeningTime:openingTime.clone().add("minutes",IFB.Utils.Helper.getPreOpeningDiffMinutes()),openingTime:openingTime,lastUpdateTime:getLastUpdateTimeFromDescriptors(date,time),getStatus:function(){if(this.lastUpdateTime<this.preOpeningTime){return"preopening"}else if(this.lastUpdateTime<this.openingTime){return"opening"}else{return""}}}},getTradeTimeStatusFromList:function(instruments,openingTime){var self=this;var currentDate=_.max(instruments,function(instrument){return instrument.D60}).D60;var groups=_.groupBy(instruments,function(instrument){return self.getTradeTimeStatus(instrument.D60,instrument.D70,openingTime||instrument.D611).getStatus()||"DEFAULT"});var candidate=null;if(!candidate&&groups.DEFAULT){candidate=_.find(groups.DEFAULT,function(instrument){return instrument.D60===currentDate})}if(!candidate&&groups["opening"]){candidate=_.find(groups["opening"],function(instrument){return instrument.D60===currentDate})}if(!candidate&&groups["preopening"]){candidate=_.find(groups["preopening"],function(instrument){return instrument.D60===currentDate})}return this.getTradeTimeStatus(candidate.D60,candidate.D70,openingTime||candidate.D611)}};IFB.Utils.TradeTimeUtils=tradeTimeUtils})();(function(){var templateLoader={templateVersion:"0.0.1",templates:{},loadRemoteTemplate:function(templateName,filename,callback){if(!this.templates[templateName]){var self=this;$.get(filename,function(data){self.addTemplate(templateName,data);callback(data)})}else{callback(this.templates[templateName])}},addTemplate:function(templateName,data){this.templates[templateName]=data},localStorageAvailable:function(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}},saveLocalTemplates:function(){if(this.localStorageAvailable){localStorage.setItem("templates",JSON.stringify(this.templates));localStorage.setItem("templateVersion",this.templateVersion)}},loadLocalTemplates:function(){if(this.localStorageAvailable){var templateVersion=localStorage.getItem("templateVersion");if(templateVersion&&templateVersion===this.templateVersion){var templates=localStorage.getItem("templates");if(templates){templates=JSON.parse(templates);for(var x in templates){if(!this.templates[x]){this.addTemplate(x,templates[x])}}}}else{localStorage.removeItem("templates");localStorage.removeItem("templateVersion")}}}};templateLoader.loadLocalTemplates();window.templateLoader=templateLoader})();IFB.Models.Account=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON();this.set({id:this.getDescriptorValue(IFB.Descriptors.Trader.Cuentas.Account.descriptor)})},getId:function(){return this.id},getAccount:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.Cuentas.Account.descriptor)},getCashBuy:function(){return this.formatAsNumber(IFB.Descriptors.Trader.Cuentas.CashBuy.descriptor,4)},getCashAvailable:function(decimals){decimals=decimals||decimals===0?decimals:4;return this.formatAsNumber(IFB.Descriptors.Trader.Cuentas.CashAvailable.descriptor,decimals)},getCashInitial:function(){return this.formatAsNumber(IFB.Descriptors.Trader.Cuentas.CashInitial.descriptor,4)},getCashSell:function(){return this.formatAsNumber(IFB.Descriptors.Trader.Cuentas.CashSell.descriptor,4)},getDescriptorValue:function(descriptor){return this.data[descriptor]||""},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue!==undefined&&(!value||value==="0"||value==="")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;return oldValue},createDescriptorsCalculated:function(){}});IFB.Models.Alert=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON();if(this.data.General){this.set({id:this.data.General.ID})}},formatValueAsDate:function(value,format){format=format||"DD/MM/YYYY";if(value){value=moment(value,"YYYYMMDD").format(format)}return value},formatValueAsTime:function(value,format){format=format||"HH:mm";if(value){value=moment(value,"HHmmss").format(format)}return value},getName:function(){if(this.data.General){return this.data.General.Nombre}else{return""}},getCreatioinDate:function(format){try{return this.formatValueAsDate(this.data.General.Fecha,format)}catch(e){return""}},getCreationTime:function(format){try{return this.formatValueAsTime(this.data.General.Hora,format)}catch(e){return""}},isEnabled:function(){if(this.data.General){return this.data.General.Activa==="1"}else{return false}},getDescription:function(){if(this.data.General){return this.data.General.Observaciones}else{return""}},getGMT:function(){if(this.data.General){return this.data.General.GMT}else{return""}},getLanguage:function(){if(this.data.General){return this.data.General.Idioma}else{return""}},getUnderlyingMV:function(){if(this.data.Tipo){return this.data.Tipo.Subtipo.Param1}else{return""}}});IFB.Models.BoletaOrder=Backbone.Model.extend({initialize:function(data){this.initializeModel(data);this.createDataValidators();this.createValidators()},DEFAULTS_DECIMALS:3,DEFAULTS_DATE_FORMAT:"DD/MM/YYYY",DEFAULTS_DATE_FORMAT_RAW:"YYYYMMDD",DATE_INPUT_FORMAT_RAW:"YYYY-MM-DD",initializeModel:function(data){this.set("MIC",data.dataInstrument[IFB.Descriptors.MIC.descriptor]);this.set("id",data.dataInstrument.MV);this.set("MV",data.dataInstrument.MV);this.set("idAccount",data.idAccount);this.set("volume",data.quantity);this.set("isin",data.dataInstrument[IFB.Descriptors.Isin.descriptor]);this.set("last",data.dataInstrument[IFB.Descriptors.Last.descriptor]);this.set("price",IFB.Trader.sideOptions[data.side].value===IFB.Trader.sideOptions.BUY.value?Number(data.dataInstrument[IFB.Descriptors.AskPrice.descriptor]):Number(data.dataInstrument[IFB.Descriptors.BidPrice.descriptor]));this.set("side",IFB.Trader.sideOptions[data.side].value);this.set("name",data.dataInstrument[IFB.Descriptors.IFBShortName.descriptor]);this.set("orderType",IFB.Trader.orderTypeOptions.LIMIT.value);this.set("currency",data.dataInstrument[IFB.Descriptors.Currency.descriptor]);this.set("exectype",this.execTypeOptions.EXECTYPE_NONE);this.set("expireTime",this.expireTimeOptions.FIX_EXPIRETIME_SESSION);this.set("lastPrice",data.dataInstrument[IFB.Descriptors.Last.descriptor]);this.set("minQuantity",data.dataInstrument[IFB.Descriptors.Trader.MinQuantityFIX.descriptor]);this.set("stopPrice",data.dataInstrument[IFB.Descriptors.Trader.StopPriceFIX.descriptor]);this.set("maxFloor",data.dataInstrument[IFB.Descriptors.Trader.MaxFloorFIX.descriptor])},expireTimeOptions:{FIX_EXPIRETIME_SESSION:"0",FIX_EXPIRETIME_DATE:"6"},execTypeOptions:{EXECTYPE_NONE:"0",EXECTYPE_CONDICIONES_ADICIONALES_EJECUTAR_O_ANULAR:"3",EXECTYPE_CONDICIONES_ADICIONALES_TODO_NADA:"4",EXECTYPE_MINQTY:"M"},defaults:{exectype:"0",name:"",idAccount:"",MV:"",price:0,lastPrice:0,volume:0,amount:0,isin:"",currency:"EUR",expireDate:moment().format(this.DEFAULTS_DATE_FORMAT_RAW),expireTime:"0",last:0,minQuantity:0,stopPrice:0,maxFloor:0},getDescriptorValue:function(field){return this.getRawValue(field)},getRawValue:function(field){return this.get(field)||""},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getRawValue(descriptor),decimals,zeroValue,positiveSign,suffix)},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue!==undefined&&(!value||value==="0"||value==="")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatValueAsDate:function(value,format){format=format||this.DEFAULTS_DATE_FORMAT;if(value){value=moment(value,this.DEFAULTS_DATE_FORMAT_RAW).format(format)}return value},formatAsDate:function(descriptor,format){return this.formatValueAsDate(this.getRawValue(descriptor),format)},getDecimals:function(defaultValue){var value=this.getRawValue(IFB.Descriptors.Decimals.descriptor);return/^\s*\d+\s*$/.test(value)?parseInt(value,10):defaultValue||this.DEFAULTS_DECIMALS},getPrice:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();var value=this.formatAsNumber("price",decimals,"");return value}catch(e){}},getStopPrice:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber("stopPrice",decimals,"")}catch(e){}},getVolume:function(){try{return this.formatAsNumber("volume",0,"")}catch(e){}},getRawVolume:function(){try{var value=this.getRawValue("volume");if(value&&value>0)return this.getRawValue("volume")}catch(e){}},getMinQuantity:function(){try{return this.formatAsNumber("minQuantity",0,"")}catch(e){}},getMaxFloor:function(){try{return this.formatAsNumber("maxFloor",0,"")}catch(e){}},getIntraday:function(){return this.getRawValue("intraday")==="on"},getAmount:function(decimals){try{var amount=this.getRawValue("last")*this.getRawValue("volume");decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatValueAsNumber(amount,decimals)}catch(e){}},getAmountSend:function(){try{return this.getRawValue("last")*this.getRawValue("volume")}catch(e){}},getSide:function(){return this.getRawValue("side")},getSideCls:function(){return this.getRawValue("side")==="1"?"buy":"sell"},getAccount:function(){return this.getRawValue("idAccount")},getOrderTypeText:function(){var orderType=this.getRawValue("orderType");return IFB.Trader.getOrderTypeText(orderType)},getOrderType:function(){var orderType=this.getRawValue("orderType");return IFB.Trader.getOrderType(orderType)},getExecType:function(){return this.getRawValue("exectype")},getExpireTime:function(){if(this.getExpireDate(this.DEFAULTS_DATE_FORMAT_RAW)!==moment().format("YYYYMMDD")){return"6"}else{return"0"}},getIsin:function(){return this.getRawValue("isin")},getName:function(){return this.getRawValue("name")},getCurrency:function(){return this.getRawValue("currency")},getExpireDate:function(format){try{return this.formatAsDate("expireDate",format)}catch(e){}},getMarket:function(){var mv=this.getRawValue("MV");return mv.substring(0,2)},getValue:function(){var mv=this.getRawValue("MV");return mv.substring(2)},getMIC:function(){return this.getRawValue("MIC")},getOrderToTrader:function(){var order={MIC:this.getMIC(),ExecType:this.getExecType(),Currency:this.getCurrency(),ISIN:this.getIsin(),Market:this.getMarket(),Value:this.getValue(),Side:this.getSide(),OrderType:this.getOrderType(),Quantity:this.getRawValue("volume"),ExpireDate:this.getExpireDate(this.DEFAULTS_DATE_FORMAT_RAW),ExpireTime:this.getExpireTime(),Account:this.getAccount(),Amount:this.getAmountSend(),Intradia:this.getIntraday()};if(order.OrderType===IFB.Trader.orderTypeOptions.LIMIT.value||order.OrderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){order.Price=this.getRawValue("price")}if(order.ExecType===this.execTypeOptions.EXECTYPE_MINQTY){order.ExecType=this.execTypeOptions.EXECTYPE_NONE;var rawMinQuantity=this.getRawValue("minQuantity");if(rawMinQuantity!==undefined&&rawMinQuantity!==""&&rawMinQuantity!=="0"){order.MinQty=this.getMinQuantity()}}if(order.OrderType===IFB.Trader.orderTypeOptions.STOP.value||order.OrderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){var rawStopPrice=this.getRawValue("stopPrice");if(rawStopPrice!==""&&rawStopPrice!=="0"){order.StopPrice=this.getStopPrice(3)}}var rawMaxFloor=this.getRawValue("maxFloor");if(rawMaxFloor!==""&&rawMaxFloor!=="0"){order.MaxFloor=this.getMaxFloor()}return order},getLast:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber("last",decimals)}catch(e){}},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;return oldValue},setModel:function(dataObject){var self=this;try{_.each(dataObject,function(value,attribute){if(self.isNumberField(attribute)){self.set(attribute,accounting.unformat(value,accounting.settings.number.decimal))}else if(self.isDateField(attribute)){self.set(attribute,moment(value,self.DEFAULTS_DATE_FORMAT).format(self.DEFAULTS_DATE_FORMAT_RAW))}else{self.set(attribute,value)}})}catch(e){}},isNumberField:function(field){var validationField=this.validation[field];if(!validationField){return false}if(_.isArray(validationField)){return _.some(validationField,function(validation){return validation.pattern&&(validation.pattern==="number"||validation.pattern==="digits")})}else{return validationField.pattern&&(validationField.pattern==="number"||validationField.pattern==="digits")}},isDateField:function(field){var validationField=this.validation[field];if(!validationField){return false}if(_.isArray(validationField)){return _.some(validationField,function(validation){return validation.date})}else{return validationField.date}},createDataValidators:function(){this.validation={price:[{required:true,pattern:"number",msg:"Indicar un precio válido. Máximo tres decimales separados por ','"},{decimals:this.DEFAULTS_DECIMALS},{pattern:"positive",msg:"Por favor, introduzca un precio mayor que cero"}],volume:{required:true,min:1,msg:"Por favor, introduzca el número de títulos correcto",pattern:"integer"},minQuantity:{required:true,min:1,msg:"Por favor, introduzca un volumen mínimo correcto",pattern:"digits"},expireDate:[{required:true,msg:"Por favor, introduzca una fecha de expiración"},{date:{unavailableWeekend:true,validRange:{initDate:moment(),endDate:moment().add("d",90)}}}],stopPrice:[{required:true,pattern:"number",msg:"Indicar un precio de disparo válido. Máximo tres decimales separados por ','"},{decimals:this.DEFAULTS_DECIMALS},{pattern:"positive",msg:"Por favor, introduzca un precio de disparo mayor que cero"}],maxFloor:{required:true,min:1,msg:"Por favor, introduzca el volumen oculto",pattern:"digits"}}},createValidators:function(){_.extend(Backbone.Validation.validators,{decimals:function(value,attr,customValue,model){var regex=new RegExp("^[-]?\\d*(\\"+accounting.settings.number.decimal+"\\d{1,"+customValue+"})?$");if(!regex.test(value)){return"Sólo se admiten "+model.DEFAULTS_DECIMALS+" decimales como máximo"}},date:function(value,attr,customValue,model){var SUNDAY_WEEKDAY=0;var SATURDAY_WEEKDAY=6;if(!value){return}var date=moment(value,model.DEFAULTS_DATE_FORMAT);if(!date.isValid()){return"Formato de fecha no valido"}if(customValue.validRange){if(date.isBefore(customValue.validRange.initDate.startOf("day"))||date.isAfter(customValue.validRange.endDate)){return"Fecha fuera del rango permitido"}}if(customValue.unavailableWeekend){if(date.day()===SATURDAY_WEEKDAY||date.day()===SUNDAY_WEEKDAY){return"La fecha elegida coincide con el fin de semana. Por favor, seleccione otra fecha"}}}});_.extend(Backbone.Validation.patterns,{date:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}$/,positive:/^0*[1-9][0-9]*(\,[0-9]+)?|0+\,[0-9]*[1-9][0-9]*$/,integer:/^\d+$/});_.extend(Backbone.Validation.messages,{date:"Por favor, seleccione una fecha correcta",positive:"Por favor, seleccione un número mayor que cero",integer:"Por favor, seleccione un entero"})},getExceTypeText:function(){var jsonExecType={};var execType=this.getExecType();switch(execType){case this.execTypeOptions.EXECTYPE_MINQTY:var minQuantity=this.getMinQuantity();if(minQuantity!==undefined&&Number(minQuantity)!==0){jsonExecType.header="Volumen mínimo";jsonExecType.text=minQuantity}break;case this.execTypeOptions.EXECTYPE_CONDICIONES_ADICIONALES_EJECUTAR_O_ANULAR:jsonExecType.header="Ejecutar o anular";jsonExecType.text="Sí";break;case this.execTypeOptions.EXECTYPE_CONDICIONES_ADICIONALES_TODO_NADA:jsonExecType.header="Todo o nada";jsonExecType.text="Sí";break;case this.execTypeOptions.EXECTYPE_NONE:break}return jsonExecType}});IFB.Models.ChartDailyPoint=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON();this.set({id:this.data.F13})},getHighChartPoint:function(){var point=[];point.push(moment(this.data.F13,"YYYYMMDD").valueOf());point.push(Number(this.data.F4));point.push(Number(this.data.F7));point.push(Number(this.data.F8));point.push(Number(this.data.F6));return point},getDate:function(format){return moment(this.data.F13,"YYYYMMDD").format(format||"DD/MM/YYYY")},getOpening:function(decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.data.F4,decimals,zeroValue,positiveSign,suffix)},getHigh:function(decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.data.F7,decimals,zeroValue,positiveSign,suffix)},getLow:function(decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.data.F8,decimals,zeroValue,positiveSign,suffix)},getClose:function(decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.data.F6,decimals,zeroValue,positiveSign,suffix)},getVolume:function(decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.data.F5,decimals,zeroValue,positiveSign,suffix)},getChangePercent:function(index,isReverse){},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue&&(!value||value==="0")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof decimals==="number"?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue}});IFB.Models.ChartIntradayPoint=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON();this.set({id:this.data.F4})}});IFB.Models.Columnado=Backbone.Model.extend({idAttribute:"descriptor",data:undefined,id:undefined,columnTypes:{Time:"H",Date:"F",Number:"N",Caracter:"C"},columnOrigin:{DIRECTO:"0",FECHAHORA:"1",CALCULADO:"2",COMPARACION:"3",FORMULA_WT:"4",FORMULA:"5",NOTICIA:"N",FECHA:"F",EXTERNO:"E"},calculationTypeExternalSource:{BANCOMER_WT:"4"},defaultAlignmentCss:["ifb-alignLeft","ifb-alignCenter",""],initialize:function(){this.data=this.toJSON();this.id=this.data.ID},getId:function(){return this.id},getDescriptorId:function(){return"D"+this.id},getAttribute:function(attribute){return this.data[attribute]},getAggregation:function(){return this.getAttribute("Aggregation")||""},getAlgor:function(){return this.getAttribute("Algor")||""},getAlignment:function(){return this.getAttribute("Alignment")||""},getDecimals:function(){return this.getAttribute("Decimals")||""},getFixed:function(){return this.getAttribute("Fixed")||""},getName:function(){return this.getAttribute("Name")||""},getNameL:function(){return this.getAttribute("NameL")||""},getOrigin:function(){return this.getAttribute("Origin")||""},getPrice:function(){return this.getAttribute("Price")||""},getRT:function(){return this.getAttribute("RT")||""},getTooltip:function(){return this.getAttribute("Tooltip")||""},getType:function(){return this.getAttribute("Type")||""},getTypeStreaming:function(){var type=this.getAttribute("Type")||"";var result="";if(type){switch(type){case this.columnTypes.Time:result="time";break;case this.columnTypes.Date:result="date";break;case this.columnTypes.Number:result="number";break;case this.columnTypes.Caracter:result="string";break;default:result="string";break}}return result},getVisible:function(){return this.getAttribute("Visible")||""},getWidth:function(){return this.getAttribute("Width")||""},getZerosDraw:function(){return this.getAttribute("ZerosDraw")||""},isVisible:function(){return _.isUndefined(this.getAttribute("Visible"))?true:this.getAttribute("Visible")},isFixed:function(){return _.isUndefined(this.getAttribute("Fixed"))?false:this.getAttribute("Fixed")==="1"},getAction:function(){return this.getAttribute("Action")||""},isTopFlopColored:function(){var descriptorConfig=_.findWhere(IFB.Descriptors,{descriptor:"D"+this.getId()});return _.isUndefined(descriptorConfig)?false:descriptorConfig.topFlopColored===true},getCss:function(){var descriptorConfig=_.findWhere(IFB.Descriptors,{descriptor:"D"+this.getId()});return _.isUndefined(descriptorConfig)?"":descriptorConfig.css},getFormatFunction:function(instrument){var self=this;var type=this.getTypeStreaming();var descriptorConfig=_.find(_.pairs(IFB.Descriptors),function(item){return item[1].descriptor==="D"+self.getId()});if(_.isUndefined(descriptorConfig)){return{type:type}}else{if(descriptorConfig[1].formatFunction){return descriptorConfig[1].formatFunction}else{return{name:"get"+descriptorConfig[0],type:type}}}},getIcon:function(){return this.getAttribute("Icon")||""},getAlignmentCss:function(arrayAlignmentCss){var alignment=this.getAlignment();var alignmentCss=arrayAlignmentCss||this.defaultAlignmentCss;alignment=alignment!==""?Number(alignment):0;return alignmentCss[alignment]},isDateOrTimeTypeDescriptor:function(){var descriptor="D"+this.id;return descriptor===IFB.Descriptors.DateOrTimeSituationMessage.descriptor||descriptor===IFB.Descriptors.DateOrTime.descriptor}});IFB.Models.Error=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON()},getErrorCode:function(){return this.data.ErrorCode},getText:function(){return this.data.Text},getProvider:function(){return this.data.Provider}});IFB.Models.Factset=Backbone.Model.extend({data:undefined,initialize:function(){this.data=this.toJSON()},getDescriptorValue:function(descriptor){return this.data[descriptor]||""},getDateOfInformation:function(){return this.getDescriptorValue("F04")},getBuyRecommendationsMonth:function(){try{return this.formatAsNumber("F27",0)}catch(e){}},getOverWeightRecommendationsMonth:function(){try{return this.formatAsNumber("F28",0)}catch(e){}},getHoldRecommendationsMonth:function(){try{return this.formatAsNumber("F29",0)}catch(e){}},getUnderWeightRecommendationsMonth:function(){try{return this.formatAsNumber("F30",0)}catch(e){}},getSellRecommendationsMonth:function(){try{return this.formatAsNumber("F31",0)}catch(e){}},getTotalRecommendationsMonth:function(){try{return Number(this.getDescriptorValue("F27"))+Number(this.getDescriptorValue("F28"))+Number(this.getDescriptorValue("F29"))+Number(this.getDescriptorValue("F30"))+Number(this.getDescriptorValue("F31"))}catch(e){}},getRecommendationAverage:function(){try{return this.getDescriptorValue("F26")}catch(e){}},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue&&(!value||value==="0")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue}});IFB.Models.Header=Backbone.Model.extend({idAttribute:"descriptor",initialize:function(){var data=this.toJSON();var defaultHeaderConfig=_.findWhere(IFB.Descriptors,{descriptor:data.descriptor});if(defaultHeaderConfig){this.set($.extend(true,defaultHeaderConfig,data))}else{this.set(data)}},getAttribute:function(attribute){return this.attributes[attribute]},getCss:function(){return this.getAttribute("css")||""},getText:function(){return this.getAttribute("text")||""},isVisible:function(){return _.isUndefined(this.getAttribute("visible"))?true:this.getAttribute("visible")},isDynamic:function(){return _.isUndefined(this.getAttribute("dynamic"))?false:this.getAttribute("dynamic")},isTopFlopColored:function(){return _.isUndefined(this.getAttribute("topFlopColored"))?false:this.getAttribute("topFlopColored")},getFormatFunction:function(){return this.getAttribute("formatFunction")}});IFB.Models.Instrument=Backbone.Model.extend({id:undefined,data:undefined,defaultDecimals:2,NATIONAL_MARKET:"M ",NATIONAL_MARKETS:["M ","SV","XX"],INSTRUMENTS_TYPES:{EQUITY:"V",INDEX:"I",FUTURE:"D1",WARRANTS:"W",FUND:"f",INTEREST_RATE:"T",CURRENCY:"d",COMMODITY:"M",DERIVATE:"D",RISK_PREMIUM:"i"},initialize:function(){this.data=this.toJSON();this.set({id:this.data.MV})},getDecimals:function(defaultValue){var value=this.getDescriptorValue(IFB.Descriptors.Decimals.descriptor);return/^\s*\d+\s*$/.test(value)?parseInt(value,10):defaultValue||this.defaultDecimals},getDescriptorValue:function(descriptor){return this.data[descriptor]||""},getDescriptorValueOrNull:function(descriptor,nullValue,suffix){nullValue=nullValue||"";suffix=suffix||"";return this.data[descriptor]?this.data[descriptor]+suffix:nullValue},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;return oldValue},getCustomDifference:function(fieldLast,fieldPrevious){var last=this.data[fieldLast];var previous=this.data[fieldPrevious];if(!last||!previous){return""}return this.formatValueAsNumber(last-previous,this.getDecimals())},getCustomPercentageDifference:function(fieldLast,fieldPrevious){var last=this.data[fieldLast];var previous=this.data[fieldPrevious];var result;if(!last||!previous){return""}if(Number(last)!==0){result=(last-previous)/last*100}return this.formatValueAsNumber(result,this.getDecimals())},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue&&(!value||value==="0")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof decimals==="number"?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatValueAsDate:function(value,format){format=format||"DD/MM/YYYY";if(value){value=moment(value,"YYYYMMDD").format(format)}return value},formatValueAsTime:function(value,format){format=format||"HH:mm";if(value){value=moment(value,"HHmmss").add("minutes",IFB.Settings.GmtOffset).format(format)}return value},formatValueAsDateOrTime:function(value,dateFormat,timeFormat){dateFormat=dateFormat||"DD/MM";timeFormat=timeFormat||"HH:mm";if(_.isString(value)){if(value.substring(0,1)==="H"){return this.formatValueAsTime(value.substring(1),timeFormat)}else if(value.substring(0,1)==="F"){return this.formatValueAsDate(value.substring(1),dateFormat)}}return""},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},formatAsDate:function(descriptor,format){return this.formatValueAsDate(this.getDescriptorValue(descriptor),format)},formatAsTime:function(descriptor,format){return this.formatValueAsTime(this.getDescriptorValue(descriptor),format)},getDescriptorValueWithFormat:function(descriptor,decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{options.decimals=options.decimals||options.decimals===0?options.decimals:this.getDecimals();return this.formatAsNumber(descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getInstrumentDetailsUrl:function(){var ticker=this.getDescriptorValue("MV");return"stock/"+ticker},getTopFlopClsWithReferenceDescriptor:function(descriptor,referenceDescriptor,values){var descriptorValue=Number(this.getDescriptorValue(descriptor)||"0");var referenceDescriptorValue=Number(this.getDescriptorValue(referenceDescriptor)||"0");if(!values||values.length!==3){values=["green","red",""]}return descriptorValue>referenceDescriptorValue?values[0]:descriptorValue<referenceDescriptorValue?values[1]:values[2]},getTopFlopCls:function(descriptor,values){var descriptorValue=Number(this.getDescriptorValue(descriptor)||"0");if(!values||values.length!==3){values=["ifb-top","ifb-flop","ifb-equal"]}if(descriptor===IFB.Descriptors.Trend.descriptor){return descriptorValue===1?values[0]:descriptorValue===2?values[1]:values[2]}return descriptorValue>0?values[0]:descriptorValue<0?values[1]:values[2]},getTopFlopClsInv:function(descriptor,values){return this.getTopFlopCls(descriptor,["ifb-flop","ifb-top","ifb-equal"])},getAlias:function(descriptor){var descriptorValue=this.getDescriptorValue(descriptor);if($&&$.t){return $.t("infobolsa.global:alias."+descriptorValue)}else{return descriptorValue}},getIcon:function(descriptor){var descriptorValue=this.getDescriptorValue(descriptor);if($&&$.t){return $.t("infobolsa.global:icon."+descriptorValue)}else{return descriptorValue}},getCommodityIcon:function(descriptor){var descriptorValue=this.getDescriptorValue(descriptor);if($&&$.t){return $.t("infobolsa.global:commodityIcon."+descriptorValue)}else{return descriptorValue}},getCommodityUnit:function(descriptor){var descriptorValue=this.getDescriptorValue(descriptor);if($&&$.t){return $.t("infobolsa.global:commodityUnit."+descriptorValue)}else{return descriptorValue}},getValueRangePercent:function(value,rangeMin,rangeMax){var dif=rangeMax-rangeMin;var valueRangePercent=dif===0?50:Math.round((value-rangeMin)*100/dif);return valueRangePercent<0?0:valueRangePercent>100?100:valueRangePercent},getNoLimitsValueRangePercent:function(value,rangeMin,rangeMax){var dif=rangeMax-rangeMin;var valueRangePercent=dif===0?50:Math.round((value-rangeMin)*100/dif);return valueRangePercent<0?NaN:valueRangePercent>100?NaN:valueRangePercent},isRising:function(){return this.getDescriptorValue(IFB.Descriptors.ChangePercent.descriptor)>0},isLosing:function(instrument){return this.getDescriptorValue(IFB.Descriptors.ChangePercent.descriptor)<0},isEqual:function(instrument){return Number(this.getDescriptorValue(IFB.Descriptors.ChangePercent.descriptor))===0},getAgrup:function(){try{return this.getDescriptorValue(IFB.Descriptors.ConstituentsCode.descriptor).split("|")[0]}catch(e){}},getShortName:function(){return this.getDescriptorValue(IFB.Descriptors.ShortName.descriptor)},getFriendlyName:function(){return this.getDescriptorValue(IFB.Descriptors.FriendlyName.descriptor)},getIsin:function(){return this.getDescriptorValue(IFB.Descriptors.Isin.descriptor)},getSessionLow:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.SessionLow.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getSessionAverage:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.SessionAverage.descriptor,decimals)}catch(e){}},getSessionHigh:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.SessionHigh.descriptor,decimals)}catch(e){}},getLast:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{options.decimals=options.decimals||options.decimals===0?options.decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.Last.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getChangePercent:function(options){options=_.defaults(options||{},{decimals:2});try{return this.formatAsNumber(IFB.Descriptors.ChangePercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getChange:function(options){options=options||{};decimals=options.decimals||options.decimals===0?options.decimals:this.getDecimals();try{return this.formatAsNumber(IFB.Descriptors.Change.descriptor,decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getYearReturn:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.YearReturn.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getNetAssetValue:function(decimals){decimals=decimals||6;try{return this.formatAsNumber(IFB.Descriptors.NetAssetValue.descriptor,decimals)}catch(e){}},getTime:function(format){try{return this.formatAsTime(IFB.Descriptors.Time.descriptor,format)}catch(e){}},getDate:function(format){try{return this.formatAsDate(IFB.Descriptors.Date.descriptor,format)}catch(e){}},getFundLastDate:function(){try{return this.formatAsDate(IFB.Descriptors.FundLastDate.descriptor)}catch(e){}},getPreviousYearClose:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.PreviousYearClosingPrice.descriptor,decimals)}catch(e){}},getYearHigh:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.YearHigh.descriptor,decimals)}catch(e){}},getYearLow:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.YearLow.descriptor,decimals)}catch(e){}},get52WeeksHigh:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors._52WeeksHigh.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get52WeeksDateLow:function(format){try{return this.formatAsDate(IFB.Descriptors._52WeeksDateLow.descriptor,format)}catch(e){}},get52WeeksDateHigh:function(format){try{return this.formatAsDate(IFB.Descriptors._52WeeksDateHigh.descriptor,format)}catch(e){}},get52WeeksLow:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors._52WeeksLow.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getOpen:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.Open.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getClose:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.Close.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getOperations:function(){try{return this.formatAsNumber(IFB.Descriptors.Operations.descriptor,0)}catch(e){}},getTopCount:function(){try{return this.formatAsNumber(IFB.Descriptors.TopCount.descriptor,0)}catch(e){}},getFlopCount:function(){try{return this.formatAsNumber(IFB.Descriptors.FlopCount.descriptor,0)}catch(e){}},getBidPrice:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.BidPrice.descriptor,decimals)}catch(e){}},getAskPrice:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.AskPrice.descriptor,decimals)}catch(e){}},getBidVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.BidVolume.descriptor,0)}catch(e){}},getAskVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.AskVolume.descriptor,0)}catch(e){}},isNationalInstrument:function(){try{var market=this.id.substring(0,2);return $.inArray(market,this.NATIONAL_MARKETS)>-1}catch(e){}},getInstrumentType:function(){try{return this.getDescriptorValue(IFB.Descriptors.InstrumentType.descriptor)}catch(e){}},getClientInstrumentType:function(){try{return this.getDescriptorValue(IFB.Descriptors.ClientInstrumentType.descriptor)}catch(e){}},getCountryCode:function(){try{return this.getDescriptorValue(IFB.Descriptors.Country.descriptor)}catch(e){}},getCurrency:function(){try{return this.getDescriptorValue(IFB.Descriptors.Currency.descriptor)}catch(e){}},getCurrencySymbol:function(currency){currency=currency||this.getCurrency();switch(currency){case"USD":return"$";case"EUR":return"€";case"GBP":return"£";case"JPY":return"¥";case"pts":return"";default:return currency}},getCurrencyName:function(currency){currency=currency||this.getCurrency();switch(currency){case"USD":return"Dólar";case"EUR":return"Euro";case"GBP":return"Libra";case"JPY":return"Yen";case"pts":return"";default:return currency}},getAssetType:function(){try{return this.getDescriptorValue(IFB.Descriptors.AssetType.descriptor)}catch(e){}},getTicker:function(){try{return this.getDescriptorValue(IFB.Descriptors.InstrumentTicker.descriptor)}catch(e){}},getClientTicker:function(){try{return this.getDescriptorValue(IFB.Descriptors.ClientInstrumentTicker.descriptor)}catch(e){}},isFalsyOrZero:function(descriptors){var result=true;descriptors=_.isArray(descriptors)?descriptors:[descriptors];return _.every(descriptors,function(descriptor){var value=this.getDescriptorValue(descriptor);return!value||_.isNumber(value)&&Number(value)===0},this)},getDateOrTime:function(onlySituationMessage,dateFormat,timeFormat){var desiredDescriptor=IFB.Descriptors.DateOrTime.descriptor;if(onlySituationMessage){desiredDescriptor=IFB.Descriptors.DateOrTimeSituationMessage.descriptor}var dateOrTime=this.getDescriptorValue(desiredDescriptor);return this.formatValueAsDateOrTime(dateOrTime,dateFormat,timeFormat)},isEtfInstrument:function(){var instrumentType=this.getDescriptorValue(IFB.Descriptors.InstrumentType.descriptor);var instrumentSubype=this.getDescriptorValue(IFB.Descriptors.InstrumentSubtype.descriptor);return instrumentType==="V"&&instrumentSubype==="E"},isIndex:function(){var instrumentType=this.getDescriptorValue(IFB.Descriptors.InstrumentType.descriptor);return instrumentType==="I"},getMarketDescription:function(){try{return this.getDescriptorValue(IFB.Descriptors.MarketName.descriptor)}catch(e){}},getIFBMarketName:function(){try{return this.getDescriptorValue(IFB.Descriptors.IFBMarketName.descriptor)}catch(e){}},getVolume:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.Volume.descriptor,0,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getCash:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.Cash.descriptor,0,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMonthReturn:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MonthReturn.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get3YearsReturn:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors._3YearsReturn.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get12MonthsReturnClose:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors._12MonthsReturnClose.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getCurrentYearChangePercent:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.ChangePercent_CurrentYear.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get2YearsReturnClose:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors._2YearsReturnClose.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getLastYearChangePercent:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.ChangePercent_LastYear.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get3YearsReturnClose:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors._3YearsReturnClose.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get2YearsAgoChangePercent:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.ChangePercent_2YearsAgo.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get4YearsReturnClose:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors._4YearsReturnClose.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get3YearsAgoChangePercent:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.ChangePercent_3YearsAgo.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get5YearsReturnClose:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors._5YearsReturnClose.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},get4YearsAgoChangePercent:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.ChangePercent_4YearsAgo.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getDividendYield:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.FACTSET_DividendYield.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getPER:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.FACTSET_PER.descriptor,2,options.zeroValue,options.positiveSign)}catch(e){}},getProfitPerShare:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.ProfitPerShare.descriptor,2,options.zeroValue,options.positiveSign)}catch(e){}},isHistRising:function(){return this.getDescriptorValue(IFB.Descriptors.HistChangePercent.descriptor)>0},isHistLosing:function(){return this.getDescriptorValue(IFB.Descriptors.HistChangePercent.descriptor)<0},isHistEqual:function(){return Number(this.getDescriptorValue(IFB.Descriptors.HistChangePercent.descriptor))===0},getMarketCodeClient:function(){return this.getDescriptorValue(IFB.Descriptors.MarketCodeClient.descriptor)},getIFBShortName:function(){return this.getDescriptorValue(IFB.Descriptors.IFBShortName.descriptor)},getIFBLongName:function(){return this.getDescriptorValue(IFB.Descriptors.IFBLongName.descriptor)},getClientIsin:function(){try{return this.getDescriptorValue(IFB.Descriptors.ClientIsin.descriptor)}catch(e){}},getYearVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.YearVolume.descriptor,0)}catch(e){}},getDayAvgVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.DayAvgVolume.descriptor,0)}catch(e){}},isTradable:function(){if(IFB.Trader){return IFB.Trader.isTradable(this.id)}return false},getFundIssuer:function(){try{return this.getDescriptorValue(IFB.Descriptors.FundIssuer.descriptor)}catch(e){}},getFundDividendDistribution:function(){try{return this.getDescriptorValue(IFB.Descriptors.FundDividendDistribution.descriptor)}catch(e){}},getFundComission:function(){try{return this.formatAsNumber(IFB.Descriptors.FundComission.descriptor,4)}catch(e){}},getWeekReturnClose:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.WeekReturnClose.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMonthReturnClose:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MonthReturnClose.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getYearReturnClose:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.YearReturnClose.descriptor,2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getDataFromHeaderConfig:function(header){var self=this;var formatFunctions=header.getFormatFunction();var valueFormated="";formatFunctions=formatFunctions?_.isArray(formatFunctions)?formatFunctions:[formatFunctions]:undefined;if(!formatFunctions){return self.getDescriptorValue(header.id)}_.each(formatFunctions,function(formatFunction){if(_.isFunction(self[formatFunction.name])){valueFormated+=self.getDataByFunctionName(formatFunction)}if(formatFunction.type){valueFormated+=self.getDataByType(formatFunction,header.id)}});return valueFormated},getDataFromColumnadoConfig:function(header){var self=this;var rawData=self.getRawDataFromColumnadoConfig(header);var formatData=self.getFormatedDataFromColumnadoConfig(rawData,header);return formatData},getFormatedDataFromColumnadoConfig:function(rawData,header){var self=this;var type=header.getType();var formatedData=rawData;var descriptor="D"+header.id;switch(type){case header.columnTypes.Time:formatedData=self.formatValueAsTime(rawData);break;case header.columnTypes.Date:formatedData=self.formatValueAsDate(rawData);break;case header.columnTypes.Caracter:if(header.isDateOrTimeTypeDescriptor()){formatedData=self.formatValueAsDateOrTime(rawData)}break;case header.columnTypes.Number:var zerosDraw=header.getZerosDraw()==="0"?" ":"0";var positiveSign;var suffix;formatedData=self.formatValueAsNumber(rawData,Number(header.getDecimals()),zerosDraw,positiveSign,suffix);break;default:}return formatedData},getRawDataFromColumnadoConfig:function(header){var self=this;var origin=header.getOrigin();var descriptor="D"+header.id;var rawData;switch(origin){case header.columnOrigin.DIRECTO:rawData=self.getDescriptorValue(descriptor);break;case header.columnOrigin.EXTERNO:rawData=self.getRawDataFromExternalOrigin(header);break;case header.columnOrigin.FORMULA_WT:rawData=self.getRawDataFromFormaulaWT(header);break;default:rawData=self.getDescriptorValue(descriptor)}return rawData},getRawDataFromExternalOrigin:function(header){var self=this;var algorithm=header.getAlgor().split("-");var calculationType=algorithm[0];var rawData;switch(calculationType){case header.calculationTypeExternalSource.BANCOMER_WT:rawData=self.getRawDataFromBancomerWT(header);break}return rawData},getRawDataFromFormaulaWT:function(header){var rawData;rawData=IFB.Utils.ReversePolishNotation.evaluateFormula(header.getAlgor(),this,header);return rawData},getRawDataFromBancomerWT:function(header){try{return this.getDescriptorValue(this.getBCMDescriptor(header))}catch(e){}},getDataByFunctionName:function(formatFunction){try{return formatFunction.params?this[formatFunction.name](formatFunction.params):this[formatFunction.name]()}catch(e){}},getDataByType:function(formatFunction,descriptor,header){var params=!formatFunction.params&&header?this.getFormatParamsFromHeader(header):{};switch(formatFunction.type){case"number":return this.formatAsNumber(descriptor,params.decimals,params.zeroValue,params.positiveSign,params.suffix);case"date":return this.formatAsDate(descriptor);case"time":return this.formatAsTime(descriptor);case"string":return this.getDescriptorValue(descriptor);default:return this.getDescriptorValue(descriptor)}},getEtfBenchmark:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Benchmark.descriptor)}catch(e){}},getEtfGeographicArea:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Geographic_Area.descriptor)}catch(e){}},getEtfSector:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Sector.descriptor)}catch(e){}},getEtfStyle:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Style.descriptor)}catch(e){}},getEtfType:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Type.descriptor)}catch(e){}},getEtfDescription:function(){try{return this.getDescriptorValue(IFB.Descriptors.ETF_Description.descriptor)}catch(e){}},getCapitalization:function(){try{return this.formatAsNumber(IFB.Descriptors.FACTSET_Capitalization.descriptor,2," ")}catch(e){}},getBancomerCapitalization:function(){try{return this.formatAsNumber(IFB.Descriptors.Bancomer_Capitalization.descriptor,0," ")}catch(e){}},getCategory:function(){return this.getDescriptorValue(IFB.Descriptors.Category.descriptor)},getUnderlying:function(){return this.getDescriptorValue(IFB.Descriptors.Underlying.descriptor)},getSymbol:function(){return this.getDescriptorValue(IFB.Descriptors.Symbol.descriptor)},getPlacement:function(){return this.getDescriptorValue(IFB.Descriptors.Placement.descriptor)},getStrike:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.Strike.descriptor,0,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getExpiryDate:function(format){try{return this.formatAsDate(IFB.Descriptors.ExpiryDate.descriptor,format)}catch(e){}},getNoesisRecommendationCls:function(descriptor,values){var descriptorValue=Number(this.getDescriptorValue(descriptor)||"0");if(!values||values.length!==3){values=["ifb-top","ifb-flop","ifb-equal"]}switch(descriptorValue){case 1:case 2:return values[0];case 3:return values[2];case 4:case 5:return values[1]}},getAverageDailyVolume_1Mouth:function(){try{return this.formatAsNumber(IFB.Descriptors.AverageDailyVolume_1Mouth.descriptor,0)}catch(e){}},getEqualCount:function(){try{return this.getDescriptorValue(IFB.Descriptors.EqualCount.descriptor)}catch(e){}},getEmptyData:function(){return""},getEmptyDivData:function(){return"<div></div>"},getTimeLastUpdate:function(format){try{return this.formatAsTime(IFB.Descriptors.TimeLastUpdate.descriptor,format)}catch(e){}},getDateLastUpdate:function(format){try{return this.formatAsDate(IFB.Descriptors.DateLastUpdate.descriptor,format)}catch(e){}},getEmisora:function(){try{return this.getDescriptorValue(IFB.Descriptors.Emisora.descriptor)}catch(e){}},getSerie:function(){try{return this.getDescriptorValue(IFB.Descriptors.Serie.descriptor)}catch(e){}},getCorporateName:function(){try{return this.getDescriptorValue(IFB.Descriptors.CorporateName.descriptor)}catch(e){}},getMarketType:function(){try{return this.getDescriptorValue(IFB.Descriptors.MarketType.descriptor)}catch(e){}},getCenter:function(){try{return this.getDescriptorValue(IFB.Descriptors.Center.descriptor)}catch(e){}},getIndustry:function(){try{return this.getDescriptorValue(IFB.Descriptors.Industry.descriptor)}catch(e){}},getSubIndustry:function(){try{return this.getDescriptorValue(IFB.Descriptors.SubIndustry.descriptor)}catch(e){}},getShareType:function(){try{return this.getDescriptorValue(IFB.Descriptors.ShareType.descriptor)}catch(e){}},getCoupon:function(){try{return this.getDescriptorValue(IFB.Descriptors.Coupon.descriptor)}catch(e){}},getSector:function(){try{return this.getDescriptorValue(IFB.Descriptors.Sector.descriptor)}catch(e){}},getSubSector:function(){try{return this.getDescriptorValue(IFB.Descriptors.SubSector.descriptor)}catch(e){}},getSampleIndicator:function(){try{return this.getDescriptorValue(IFB.Descriptors.SampleIndicator.descriptor)}catch(e){}},getSERIE_InstrumentType:function(){try{return this.getDescriptorValue(IFB.Descriptors.SERIE_InstrumentType.descriptor)}catch(e){}},getOperativity:function(){try{return this.getDescriptorValue(IFB.Descriptors.Operativity.descriptor)}catch(e){}},getBursatility:function(){try{return this.getDescriptorValue(IFB.Descriptors.Bursatility.descriptor)}catch(e){}},getSource:function(){try{return this.getDescriptorValue(IFB.Descriptors.Source.descriptor)}catch(e){}},getIssuance:function(){try{return this.formatAsDate(IFB.Descriptors.Issuance.descriptor)}catch(e){}},getIssuedCapital_I:function(){try{return this.getDescriptorValue(IFB.Descriptors.IssuedCapital_I.descriptor)}catch(e){}},getIssuedCapital_II:function(){try{return this.getDescriptorValue(IFB.Descriptors.IssuedCapital_II.descriptor)}catch(e){}},getInstrumentYesterday:function(){try{return this.formatAsNumber(IFB.Descriptors.InstrumentYesterday.descriptor,0)}catch(e){}},getSharesToday:function(){try{return this.formatAsNumber(IFB.Descriptors.SharesToday.descriptor,0)}catch(e){}},getP_FLEPA_Main:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FLEPA_Main.descriptor,decimals)}catch(e){}},getP_FLEPA_Factor1:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FLEPA_Factor1.descriptor,decimals)}catch(e){}},getP_FLEPA_Factor2:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FLEPA_Factor2.descriptor,decimals)}catch(e){}},getP_FEPA_Main:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FEPA_Main.descriptor,decimals)}catch(e){}},getP_FEPA_Factor1:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FEPA_Factor1.descriptor,decimals)}catch(e){}},getP_FEPA_Factor2:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_FEPA_Factor2.descriptor,decimals)}catch(e){}},getP_U_Main:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_U_Main.descriptor,decimals)}catch(e){}},getP_U_Factor1:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_U_Factor1.descriptor,decimals)}catch(e){}},getP_U_Factor2:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_U_Factor2.descriptor,decimals)}catch(e){}},getP_VL_Main:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_VL_Main.descriptor,decimals)}catch(e){}},getP_VL_Factor1:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_VL_Factor1.descriptor,decimals)}catch(e){}},getP_VL_Factor2:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.P_VL_Factor2.descriptor,decimals)}catch(e){}},getVE_UAIIDA_Main:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.VE_UAIIDA_Main.descriptor,decimals)}catch(e){}},getVE_UAIIDA_Factor1:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.VE_UAIIDA_Factor1.descriptor,decimals)}catch(e){}},getVE_UAIIDA_Factor2:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.VE_UAIIDA_Factor2.descriptor,decimals)}catch(e){}},getSales_Previous:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.Sales_Previous.descriptor,decimals)}catch(e){}},getSales_3T13:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.Sales_3T13.descriptor,decimals)}catch(e){}},getSales_Percentage:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.Sales_Percentage.descriptor,decimals)}catch(e){}},getON_Previous:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.ON_Previous.descriptor,decimals)}catch(e){}},getON_3T13:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.ON_3T13.descriptor,decimals)}catch(e){}},getON_Percent:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.ON_Percent.descriptor,decimals)}catch(e){}},getUN_Previous:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.UN_Previous.descriptor,decimals)}catch(e){}},getUN_3T13:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.UN_3T13.descriptor,decimals)}catch(e){}},get3T13:function(){try{return this.getDescriptorValue(IFB.Descriptors._3T13.descriptor)}catch(e){}},getUN_Percent:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.UN_Percent.descriptor,decimals)}catch(e){}},getEBITDA_Previous:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.EBITDA_Previous.descriptor,decimals)}catch(e){}},getEBITDA_3T13:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.EBITDA_3T13.descriptor,decimals)}catch(e){}},getEBITDA_Percent:function(decimals){try{return this.getDescriptorValueWithFormat(IFB.Descriptors.EBITDA_Percent.descriptor,decimals)}catch(e){}},getTradedCash:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.TradedCash.descriptor,0,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getOpenPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.OpenPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMaxPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MaxPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMedPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MedPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMinPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MinPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getLastExPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.LastExPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMaxAnnPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MaxAnnPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getMinAnnPercent:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.MinAnnPercent.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getRotation:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.Rotation.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getNominalValue:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.NominalValue.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getCurrencyVolumes:function(){try{return this.getDescriptorValue(IFB.Descriptors.CurrencyVolumes.descriptor)}catch(e){}},getMarketCode:function(){try{return this.getDescriptorValue(IFB.Descriptors.MarketCode.descriptor)}catch(e){}},getBCMDescriptor:function(header){try{var algor=header.getAlgor().split("-");return algor[1]}catch(e){}},getFormatParamsFromHeader:function(header){var params={};if(!header){return params}params.decimals=Number(header.getDecimals());return params},getRecommendationText:function(){return IFB.Utils.Helper.getRecommendationText(this.getDescriptorValue(IFB.Descriptors.FACTSET_Recommendation.descriptor))},getWeekHigh:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.WeekHigh.descriptor,decimals)}catch(e){}},getWeekLow:function(decimals){try{decimals=decimals||decimals===0?decimals:this.getDecimals();return this.formatAsNumber(IFB.Descriptors.WeekLow.descriptor,decimals)}catch(e){}},getIFB_PER:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.PER.descriptor,options.decimals||2,options.zeroValue,options.positiveSign)}catch(e){}},getBPA:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.BPA.descriptor,options.decimals||2,options.zeroValue,options.positiveSign)}catch(e){}},getPriceBook:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.PriceBook.descriptor,options.decimals||2,options.zeroValue,options.positiveSign)}catch(e){}},getIFB_DividendYield:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.DividendYield.descriptor,options.decimals||2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getPriceCashFlow:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.PriceCashFlow.descriptor,options.decimals||2,options.zeroValue,options.positiveSign)}catch(e){}},getIFB_Capitalization:function(options){options=options||{};try{return this.formatAsNumber(IFB.Descriptors.Capitalization.descriptor,options.decimals||2,options.zeroValue,options.positiveSign)}catch(e){}},getNumberOfConstituents:function(){var risers=this.getConstituentsRisers()||0;var fallers=this.getConstituentsFallers()||0;var neutrals=this.getConstituentsNeutrals()||0;return Number(risers)+Number(fallers)+Number(neutrals)},getConstituentsRisers:function(options){if(options){try{return this.formatAsNumber(IFB.Descriptors.Index_Consituents_Risers.descriptor,options.decimals||0,options.zeroValue,options.positiveSign)}catch(e){}}else{return this.getDescriptorValue(IFB.Descriptors.Index_Consituents_Risers.descriptor)}},getConstituentsNeutrals:function(options){if(options){try{return this.formatAsNumber(IFB.Descriptors.Index_Consituents_Neutrals.descriptor,options.decimals||0,options.zeroValue,options.positiveSign)}catch(e){}}else{return this.getDescriptorValue(IFB.Descriptors.Index_Consituents_Neutrals.descriptor)}},getConstituentsFallers:function(options){if(options){try{return this.formatAsNumber(IFB.Descriptors.Index_Consituents_Fallers.descriptor,options.decimals||0,options.zeroValue,options.positiveSign)}catch(e){}}else{return this.getDescriptorValue(IFB.Descriptors.Index_Consituents_Fallers.descriptor)}},getCA_FundKIID:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundKIID.descriptor)}catch(e){}},getCA_FundProspectus:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundProspectus.descriptor)}catch(e){}},getCA_FundQuarterlyReport:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundQuarterlyReport.descriptor)}catch(e){}},getCA_FundReporting:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundReporting.descriptor)}catch(e){}},getCA_FundRules:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundRules.descriptor)}catch(e){}},getCA_FundType:function(){try{return this.getDescriptorValue(IFB.Descriptors.CA_FundType.descriptor)}catch(e){}},getFundLongName:function(){try{return this.getDescriptorValue(IFB.Descriptors.FundLongName.descriptor)}catch(e){}},getFundChangePercentCurrentYear:function(options){options=options||{};options.decimals=options.decimals||2;try{return this.formatAsNumber(IFB.Descriptors.FundChangePercentCurrentYear.descriptor,options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getFundCurrency:function(){try{return this.getDescriptorValue(IFB.Descriptors.FundCurreny.descriptor)}catch(e){}},getFundValuationDate:function(format){try{return this.formatAsDate(IFB.Descriptors.FundValuationDate.descriptor,format)}catch(e){}},getReferenceIndex:function(){try{return this.getDescriptorValue(IFB.Descriptors.ReferenceIndex.descriptor)}catch(e){}}});IFB.Models.News=Backbone.Model.extend({id:undefined,data:undefined,FORMAT_DETAIL_BOLSACAMINOS:"24",initialize:function(){this.data=this.toJSON();this.set({id:this.data.Clave})},getTitle:function(){return this.data.Titular||this.data.F4},getDetails:function(){return this.data.Detalle||""},getKey:function(){return this.data.Clave||this.data.F3},getClassification:function(){return this.data.Clasificacion},getEvent:function(){return this.data.Clasificacion.evento},getRawDate:function(){return this.data.Fecha||this.data.F1},getDate:function(){var date=this.data.Fecha||this.data.F1;if(!date){return undefined}return this.formatValueAsDate(date)},getSource:function(){return this.data.Fuente||this.data.F0},getFormatDetail:function(){return this.data.FD},getTime:function(){var time=this.data.Hora||this.data.F2;if(!time){return undefined}return this.formatValueAsTime(time)},formatValueAsNumber:function(value,decimals,zeroValue){return accounting.formatNumber(value,{precision:decimals||6,zero:zeroValue||""})},formatValueAsDate:function(value){if(value){value=moment(value,"YYYYMMDD").format("DD/MM/YYYY")}return value},formatValueAsTime:function(value,format){format=format||"HH:mm";if(value){value=moment(value,"HHmmss").add("minutes",IFB.Settings.GmtOffset).format(format)}return value},newsDetailLink:function(){if(this.data.FD==="8"){return"href=/news/document?key="+this.data.Clave+"&source="+this.data.Fuente+"&date="+newsItem.Fecha+' target="_blank"'}else if(this.data.FD==="20"){return"href=/news/video/detail?key="+this.data.Clave+"&source="+this.data.Fuente}else{return"href=/news/detail?key="+this.data.Clave+"&source="+this.data.Fuente}},getClaveSector:function(){return this.data.Clasificacion.ClaveSector},getSubDireccion:function(){return this.data.Clasificacion.SubDireccion},getCategory:function(){return this.data.Clasificacion.Categoria},isRead:function(){return IFB.Utils.ReadStatusConfig.isRead(this.getSource(),this.getKey())}});IFB.Models.NewsDetail=Backbone.Model.extend({id:undefined,data:undefined,initialize:function(){this.data=this.toJSON();this.set({id:this.data.Clave})},getTitle:function(){return this.data.Titular||this.data.F4},getDetails:function(){if(this.data.url)return'<iframe src="//'+this.data.url+'" width="100%" height="3100"/>';else return this.data.Detalle||""},getKey:function(){return this.data.Clave||this.data.F3},getEvent:function(){return this.data.Clasificacion.evento},getRawDate:function(){return this.data.Fecha||this.data.F1},getDate:function(){var date=this.data.Fecha||this.data.F1;if(!date){return undefined}return this.formatValueAsDate(date)},getSource:function(){return this.data.Fuente||this.data.F0},getTime:function(){var time=this.data.Hora||this.data.F2;if(!time){return undefined}return this.formatValueAsTime(time)},formatValueAsNumber:function(value,decimals,zeroValue){return accounting.formatNumber(value,{precision:decimals||6,zero:zeroValue||""})},formatValueAsDate:function(value){if(value){value=moment(value,"YYYYMMDD").format("DD/MM/YYYY")}return value},formatValueAsTime:function(value,format){format=format||"HH:mm";if(value){value=moment(value,"HHmmss").add("minutes",IFB.Settings.GmtOffset).format(format)}return value},newsDetailLink:function(){if(this.data.FD==="8"){return"href=/news/document?key="+this.data.Clave+"&source="+this.data.Fuente+"&date="+newsItem.Fecha+' target="_blank"'}else if(this.data.FD==="20"){return"href=/news/video/detail?key="+this.data.Clave+"&source="+this.data.Fuente}else{return"href=/news/detail?key="+this.data.Clave+"&source="+this.data.Fuente}},getUrl:function(){return this.data.url}});IFB.Models.OpenPosition=Backbone.Model.extend({id:undefined,data:undefined,defaultDecimals:2,initialize:function(){this.data=this.toJSON();this.set({id:this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioKey.descriptor)+this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioShortName.descriptor)});this.setDescriptorValue(IFB.Descriptors.Trader.PortfolioBuyShares.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Trader.Assessment.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Trader.AssessmentFIX.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Last.descriptor,0);this.setDescriptorValue("MV",this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioMV.descriptor))},createDescriptorsCalculated:function(){this.setDescriptorValue(IFB.Descriptors.Trader.PortfolioBuyShares.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Trader.Assessment.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Trader.AssessmentFIX.descriptor,0);this.setDescriptorValue(IFB.Descriptors.Last.descriptor,0);this.setDescriptorValue("MV",this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioMV.descriptor));this.calculatePortfolioBuyShares();this.calculateAssessment();this.calculateAssessmentFIX()},getId:function(){return this.id},getPortfolioLastPriceSFB:function(decimals){decimals=decimals||decimals===0?decimals:this.defaultDecimals;return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioLastPriceSFB.descriptor,decimals)},getPortfolioAccount:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioAccount.descriptor)},getPortfolioMV:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioMV.descriptor)},getAssessment:function(decimals){decimals=decimals||decimals===0?decimals:this.defaultDecimals;return this.formatAsNumber(IFB.Descriptors.Trader.Assessment.descriptor,decimals)},getAssessmentFIX:function(decimals){decimals=decimals||decimals===0?decimals:this.defaultDecimals;return this.formatAsNumber(IFB.Descriptors.Trader.AssessmentFIX.descriptor,decimals)},getPortfolioShortName:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioShortName.descriptor)},getPortfolioInitialTrade:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioInitialTrade.descriptor,0)},getPortfolioBuyShares:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioBuyShares.descriptor,0)},getPortfolioBuyTrade:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioBuyTrade.descriptor,0)},getPortfolioSellTrade:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioSellTrade.descriptor,0)},getDescriptorValue:function(descriptor){var dato=this.data[descriptor];return dato},getPortfolioBuyPriceFIX:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioBuyPriceFIX.descriptor,2)},getPortfolioSellPriceFIX:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioSellPriceFIX.descriptor,2)},getProfitLoss:function(decimals){decimals=decimals||decimals===0?decimals:this.defaultDecimals;return this.formatAsNumber(IFB.Descriptors.Trader.ProfitLoss.descriptor,decimals)},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;this.applyAlgorithms(descriptor);return oldValue},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue!==undefined&&(!value||value==="0"||value==="")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},applyAlgorithms:function(descriptor){switch(descriptor){case IFB.Descriptors.Trader.PortfolioInitialTrade.descriptor:case IFB.Descriptors.Trader.PortfolioBuyTrade.descriptor:case IFB.Descriptors.Trader.PortfolioSellTrade.descriptor:this.calculatePortfolioBuyShares();this.calculateAssessment();this.calculateAssessmentFIX();break;case IFB.Descriptors.Last.descriptor:this.calculateAssessment();this.calculateAssessmentFIX();break}},getRawPortfolioBuyShares:function(){var valueInitialTrade=this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioInitialTrade.descriptor);var valueBuyTrade=this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioBuyTrade.descriptor);var valueSellTrade=this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioSellTrade.descriptor);var BuyShares=(valueInitialTrade!==undefined?Number(valueInitialTrade):0)+(valueBuyTrade!==undefined?Number(valueBuyTrade):0)-(valueSellTrade!==undefined?Number(valueSellTrade):0);return BuyShares},calculatePortfolioBuyShares:function(){var buyQuantity=this.getRawPortfolioBuyShares();this.data[IFB.Descriptors.Trader.PortfolioBuyShares.descriptor]=buyQuantity;this.set(IFB.Descriptors.Trader.PortfolioBuyShares.descriptor,buyQuantity)},calculateAssessment:function(){var assesment=this.getRawPortfolioBuyShares()*this.getMultiplier()*Number(this.getDescriptorValue(IFB.Descriptors.Last.descriptor));this.data[IFB.Descriptors.Trader.Assessment.descriptor]=assesment;this.set(IFB.Descriptors.Trader.Assessment.descriptor,assesment)},calculateAssessmentFIX:function(){var fixing=this.getFixing();var assesmentFIX=(this.getTitles()*this.getMultiplier()*Number(this.getDescriptorValue(IFB.Descriptors.Last.descriptor))-parseFloat(this.getDescriptorValue(IFB.Descriptors.Trader.PortfolioSellPriceFIX.descriptor)))*fixing;this.data[IFB.Descriptors.Trader.AssessmentFIX.descriptor]=assesmentFIX;this.set(IFB.Descriptors.Trader.AssessmentFIX.descriptor,assesmentFIX)},setInstrumentData:function(instrument){this.instrument=instrument},getInstrumentData:function(){if(!this.instrument){return new IFB.Models.Instrument}else{return this.instrument}},getMultiplier:function(decimals){var result=this.formatAsNumber(IFB.Descriptors.Trader.Multiplier.descriptor,decimals);if(result=="10"){console.log("multiplier",result)}if(result)return result;return 1},getCompensationPrice:function(decimals){decimals=decimals||decimals===0?decimals:this.defaultDecimals;return this.formatAsNumber(IFB.Descriptors.Trader.CompensationPrice.descriptor,decimals)},getFixing:function(){var fixing=this.formatAsNumber(IFB.Descriptors.Trader.Fixing.descriptor,2);return parseFloat(fixing.replace(/\./g,"").replace(",","."))},getTitles:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PortfolioTitlesFIX.descriptor,0)},getBalanceCurrency:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.BalanceCurrency.descriptor)}});IFB.Models.Order=Backbone.Model.extend({id:undefined,data:undefined,defaultDecimals:2,NATIONAL_MARKET:"M ",DEFAULTS_DATE_FORMAT:"DD/MM/YYYY",DEFAULTS_DATE_FORMAT_RAW:"YYYYMMDD",execTypeOptions:{EXECTYPE_NONE:"0",EXECTYPE_CONDICIONES_ADICIONALES_EJECUTAR_O_ANULAR:"3",EXECTYPE_CONDICIONES_ADICIONALES_TODO_NADA:"4"},state:{0:"E.Mer.",1:"P.Eje.",2:"Eje.",3:"D.f.D.",4:"Canc.",5:"Modif.",7:"Par.",8:"Rech.",9:"Susp.",A:"Env.",B:"Calc.",C:"Exp.",D:"A.f.B.",W:"E.Con.",Z:"Ret."},initialize:function(){this.data=this.toJSON();this.set({id:this.getDescriptorValue(IFB.Descriptors.Trader.Key.descriptor)})},getCancelCls:function(){var descriptorValue=this.getDescriptorValue(IFB.Descriptors.Trader.CancelOrder.descriptor)||"0";if(descriptorValue==="1"){return"close"}return""},getSideCls:function(){var descriptorValue=this.getDescriptorValue(IFB.Descriptors.Trader.SideFIX.descriptor||"0");if(descriptorValue==="1"){return"buy"}return"sell"},getMVFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.MVFIX.descriptor)},getMarketIB:function(){var MV=this.getMVFIX();return MV.length>2?MV.substring(0,2):""},getSymbolIB:function(){var MV=this.getMVFIX();return MV.length>2?MV.substring(2,7):""},getId:function(){return this.id},getShortName:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.ShortName.descriptor)},getSideFIX:function(){var side=this.getDescriptorValue(IFB.Descriptors.Trader.SideFIX.descriptor);return side==="1"?"C":"V"},getPrice:function(decimals){try{decimals=decimals||decimals===0?decimals:3;return this.formatAsNumber(IFB.Descriptors.Trader.Price.descriptor,decimals,"")}catch(e){}},getAvgPrice:function(decimals){try{decimals=decimals||decimals===0?decimals:3;return this.formatAsNumber(IFB.Descriptors.Trader.AvgPrice.descriptor,decimals,"")}catch(e){}},getQuantity:function(){return this.formatAsNumber(IFB.Descriptors.Trader.Quantity.descriptor,0)},getState:function(){try{var status=this.getDescriptorValue(IFB.Descriptors.Trader.OrderStatusFIX.descriptor);return this.state[status]}catch(e){}},getAccountFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.AccountFIX.descriptor)},getAccountName:function(){var account=this.getDescriptorValue(IFB.Descriptors.Trader.AccountFIX.descriptor);var name=IFB.Trader.getAccountNameFromId(account);return name},getIsinFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.IsinFIX.descriptor)},getOrderTypeFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.OrderTypeFIX.descriptor)},getOrderTypeLiteral:function(){var typeFIX=this.getOrderTypeFIX();var type=_.find(IFB.Trader.orderTypeOptions,function(typeOption){return typeOption.value===typeFIX});return type!==undefined?type.text:""},getPendingVolumeFIX:function(){return this.formatAsNumber(IFB.Descriptors.Trader.PendingVolumeFIX.descriptor,0)},getRejectCodeFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.RejectCodeFIX.descriptor)},getExpireDateFIX:function(format){try{return this.formatAsDate(IFB.Descriptors.Trader.ExpireDateFIX.descriptor,format)}catch(e){}},getCurrency:function(){return"EUR"},getExecTypeFIX:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.ExecTypeFIX.descriptor)},getStopPriceFIX:function(decimals){try{decimals=decimals||decimals===0?decimals:3;return this.formatAsNumber(IFB.Descriptors.Trader.StopPriceFIX.descriptor,decimals,"")}catch(e){}},getMaxFloorFIX:function(){try{return this.formatAsNumber(IFB.Descriptors.Trader.MaxFloorFIX.descriptor,0)}catch(e){}},getMinQuantityFIX:function(){try{return this.formatAsNumber(IFB.Descriptors.Trader.MinQuantityFIX.descriptor,0)}catch(e){}},getDescriptorValue:function(descriptor){return this.data[descriptor]||""},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue!==undefined&&(!value||value==="0"||value==="")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},formatAsDate:function(descriptor,format){return this.formatValueAsDate(this.getDescriptorValue(descriptor),format)},formatValueAsDate:function(value,format){format=format||this.DEFAULTS_DATE_FORMAT;if(value){value=moment(value,this.DEFAULTS_DATE_FORMAT_RAW).format(format)}return value},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;return oldValue},getCalculatedValue:function(functionName){var jsonData={};switch(functionName){case"StatusText":jsonData.value=this.getState();break;case"CancelCls":var cancelOrder=this.getDescriptorValue(IFB.Descriptors.Trader.CancelOrder.descriptor);if(cancelOrder==="1"){jsonData.addCls="close"}else{jsonData.removeCls="close"}break;case"TypeLiteral":jsonData.value=this.getOrderTypeLiteral();break}return jsonData},createDescriptorsCalculated:function(){},getExceTypeText:function(){var jsonExecType={};var execType=this.getExecTypeFIX();switch(execType){case this.execTypeOptions.EXECTYPE_NONE:var minQuantity=this.getMinQuantityFIX();if(minQuantity!==undefined){jsonExecType.header="Volumen mínimo";jsonExecType.text=minQuantity}break;case this.execTypeOptions.EXECTYPE_CONDICIONES_ADICIONALES_EJECUTAR_O_ANULAR:jsonExecType.header="Ejecutar o anular";jsonExecType.text="Sí";break;case this.execTypeOptions.EXECTYPE_CONDICIONES_ADICIONALES_TODO_NADA:jsonExecType.header="Todo o nada";jsonExecType.text="Sí";break}return jsonExecType},isIntraday:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.OrderIntraday.descriptor)},isOrderAdmin:function(){return this.getDescriptorValue(IFB.Descriptors.Trader.OrderAdmin.descriptor)}});IFB.Models.Positions=Backbone.Model.extend({id:undefined,data:undefined,defaultDecimals:3,defaultZeroValues:"",initialize:function(){this.data=this.toJSON();this.set({id:this.getDescriptorValue(IFB.Descriptors.MarketDepth.descriptor),mv:this.data.MV})},getId:function(){return this.id},getDecimals:function(){return this.defaultDecimals},getBidOrders:function(){try{return this.formatAsNumber(IFB.Descriptors.BidOrders.descriptor,0,this.defaultZeroValues)}catch(e){}},getAskOrders:function(){try{return this.formatAsNumber(IFB.Descriptors.AskOrders.descriptor,0,this.defaultZeroValues)}catch(e){}},getBidVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.BidVolume.descriptor,0,this.defaultZeroValues)}catch(e){}},getAskVolume:function(){try{return this.formatAsNumber(IFB.Descriptors.AskVolume.descriptor,0,this.defaultZeroValues)}catch(e){}},getBidPrice:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{options.decimals=options.decimals||options.decimals===0?options.decimals:this.getDecimals();options.zeroValue=options.zeroValue?options.zeroValue:this.defaultZeroValues;return this.formatAsNumber(IFB.Descriptors.BidPrice.descriptor,options.decimals,options.zeroValue)}catch(e){}},getAskPrice:function(decimals){var options=_.isObject(decimals)?decimals:{decimals:decimals};try{options.decimals=options.decimals||options.decimals===0?options.decimals:this.getDecimals();options.zeroValue=options.zeroValue?options.zeroValue:this.defaultZeroValues;return this.formatAsNumber(IFB.Descriptors.AskPrice.descriptor,options.decimals,options.zeroValue)}catch(e){}},getDescriptorValue:function(descriptor){return this.data[descriptor]||""},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue!==undefined&&(!value||value==="0"||value==="")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:typeof (decimals==="number")?decimals:this.getDecimals(),zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue},formatAsNumber:function(descriptor,decimals,zeroValue,positiveSign,suffix){return this.formatValueAsNumber(this.getDescriptorValue(descriptor),decimals,zeroValue,positiveSign,suffix)},setDescriptorValue:function(descriptor,value){var oldValue=this.data[descriptor];this.data[descriptor]=value;return oldValue}});IFB.Models.SignificantFact=IFB.Models.Instrument.extend({id:undefined,data:undefined,defaultDecimals:2,initialize:function(){this.data=this.toJSON();this.set({id:this.data.MV})},getEventFamily:function(){try{return this.getDescriptorValue("HR")}catch(e){}},getEventType:function(){try{return this.getDescriptorValue("Tipo")}catch(e){}},getPaymentDate:function(format){try{return this.formatAsDate("FechaPago",format)}catch(e){}},getInitialDate:function(format){try{return this.formatAsDate("FechaIni",format)}catch(e){}},getFinalDate:function(format){try{return this.formatAsDate("FechaFin",format)}catch(e){}},getGrossAmount:function(options){options=options||{};try{return this.formatAsNumber("ImporteBruto",options.decimals||4,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getNetAmount:function(options){options=options||{};try{return this.formatAsNumber("ImporteNeto",options.decimals||4,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getOldShares:function(options){options=options||{};try{return this.formatAsNumber("AccionesAntiguas",options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getNewShares:function(options){options=options||{};try{return this.formatAsNumber("AccionesNuevas",options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getPricePerShare:function(options){options=options||{};try{return this.formatAsNumber("Precio",options.decimals||3,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getNominalAmount:function(options){options=options||{};try{return this.formatAsNumber("ImporteNominal",options.decimals||2,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getPayAmount:function(options){options=options||{};try{return this.formatAsNumber("ImporteDesembolso",options.decimals||3,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getIPODate:function(format){try{return this.formatAsDate("FechaOfertaPublica",format)}catch(e){}},getSequence:function(options){options=options||{};try{return this.formatAsNumber("Secuencia",options.decimals,options.zeroValue,options.positiveSign,options.suffix)}catch(e){}},getEffectDate:function(format){try{return this.formatAsDate("FechaEfectiva",format)}catch(e){}},getFirstCallDate:function(format){try{return this.formatAsDate("FechaConvocatoria1",format)}catch(e){}},getFirstCallTime:function(format){try{return this.formatAsTime("HoraConvocatoria1",format)}catch(e){}},getSecondCallDate:function(format){try{return this.formatAsDate("FechaConvocatoria2",format)}catch(e){}},getSecondCallTime:function(format){try{return this.formatAsTime("HoraConvocatoria2",format)}catch(e){}}});IFB.Collections.Base=Backbone.Collection.extend({options:{},refreshIntervalId:undefined,ajaxTried:0,initialize:function(options){if(!options){return}this.requests=[];this.options=options||{};this.url=(this.options.baseURL||"")+this.url;this.options.serviceParams.beforeSend=this.setAuthorizationHeader;this.options.serviceParams.reset=true;this.bind("dataLoaded",this.dataLoaded,this)},setRefresh:function(){var self=this;if(this.options.refresh&&!self.refreshIntervalId){self.refreshIntervalId=setInterval(function(){self.refresh()},this.options.refresh)}},dataLoaded:function(){this.setRefresh()},refresh:function(){this.load()},parse:function(message){throw new Error("This method must be overrided")},getElementById:function(id){return this.get(id)},load:function(data){var self=this;var request;var serviceParams=_.clone(this.options.serviceParams);serviceParams.data=_.clone(this.options.serviceParams.data);_.extend(serviceParams.data,data||{});if(IFB.ClientConfiguration&&IFB.ClientConfiguration.Services.CacheKey&&IFB.Services.Profile){var cacheKey=IFB.ClientConfiguration.Services.CacheKey;serviceParams.data.profile=cacheKey+"_"+IFB.Services.Profile}_.each(this.requests,function(request){if(request){request.abort()}});this.requests=[];request=this.fetch(serviceParams);if(request){this.requests.push(request)}},sync:function(method,model,options){var self=this,args=arguments;Backbone.sync.apply(this,args).done(function(){self.ajaxTried=0}).fail(function(){if(self.ajaxTried<IFB.Services.RetryLimit){self.ajaxTried++;self.sync.apply(self,args)}else{self.ajaxTried=0;if(_.isFunction(options.success)){options.success(JSON.parse(IFB.Services.AnswerError))}}})},setAuthorizationHeader:function(xhr){$.support.cors=true;if(IFB.Services.AUTH_TOKEN){xhr.setRequestHeader("Infobolsa-Auth-Token",IFB.Services.AUTH_TOKEN);xhr.setRequestHeader("Content-type","text/plain")}if(IFB.Services.Session){xhr.setRequestHeader("Infobolsa-Session",IFB.Services.Session)}},changeDataParam:function(){var self=this;return function(data){self.config.serviceParams.data.param=data;self.load()}}});IFB.Services.Base=IFB.Class(null,{baseURL:undefined,session:undefined,servicename:undefined,initialize:function(options){this.baseURL=options.baseURL||IFB.Services.baseURL;this.session=options.session;this.servicename=options.servicename||""},request:function(method,url,parameters,methodname,successCallback,context,successCallbackParams){var errorMessage={error:true,code:"infobolsa.service."+this.servicename+"."+methodname+".error"};$.ajax({type:method,url:url,data:parameters,xhrFields:{withCredentials:true},tryCount:0,success:function(response){if(_.isFunction(successCallback)){successCallback(response,context,successCallbackParams)}},beforeSend:function(xhr){if(IFB.Services.AUTH_TOKEN){xhr.setRequestHeader("Infobolsa-Auth-Token",IFB.Services.AUTH_TOKEN);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}if(IFB.Services.Session){xhr.setRequestHeader("Infobolsa-Session",IFB.Services.Session)}},error:function(xhr,textStatus,errorThrown){if(this.tryCount<IFB.Services.RetryLimit){this.tryCount++;$.ajax(this);return}if(_.isFunction(successCallback)){successCallback(IFB.Services.AnswerError,context,successCallbackParams)}}})},postRequest:function(url,parameters,methodname,successCallback,context,successCallbackParams){this.request("POST",url,parameters,methodname,successCallback,context,successCallbackParams)},cacheRequest:function(url,parameters,methodname,successCallback,context,successCallbackParams){delete parameters.sesion;if(IFB.Services.Profile){var cacheKey="";if(IFB.ClientConfiguration&&IFB.ClientConfiguration.Services.CacheKey){cacheKey=IFB.ClientConfiguration.Services.CacheKey;parameters.profile=cacheKey+"_"+IFB.Services.Profile}}this.request("GET",url,parameters,methodname,successCallback,context,successCallbackParams)},getRequest:function(url,parameters,methodname,successCallback,context,successCallbackParams){this.request("GET",url,parameters,methodname,successCallback,context,successCallbackParams)},postRequestNoAuth:function(url,parameters,methodname){var errorMessage={code:"infobolsa.service."+this.servicename+"."+methodname+".error"};$.ajax({cache:false,type:"POST",url:url,xhrFields:{withCredentials:true},data:parameters})},getRequestNoAuth:function(url,parameters,methodname,successCallback,context,successCallbackParams){var errorMessage={error:true,code:"infobolsa.service."+this.servicename+"."+methodname+".error"};$.ajax({type:"GET",url:url,data:parameters,tryCount:0,success:function(response){if(_.isFunction(successCallback)){successCallback(response,context,successCallbackParams)}},beforeSend:function(xhr){xhr.setRequestHeader("Content-Type","text/plain")},error:function(xhr,textStatus,errorThrown){if(this.tryCount<IFB.Services.RetryLimit){this.tryCount++;$.ajax(this);return}if(_.isFunction(successCallback)){successCallback(IFB.Services.AnswerError,context,successCallbackParams)}}})},jsonParamsPost:function(url,parameters,methodname,successCallback,context,successCallbackParams){parameters=JSON.stringify(parameters);return this.postRequest(url,parameters,methodname,successCallback,context,successCallbackParams)},getSession:function(){return this.session}});IFB.Views.Base=Backbone.View.extend({initialize:function(){_.extend(this,Backbone.Events);this.model.bind("reset",this.reset,this);this.lastRegisterCall=undefined;this.initializeStreamingConfiguration()},reconnectingRealTime:false,destroy:function(){if(this.options.streaming){if(this.lastRegisterCall){this.unregister()}IFB.Services.Streaming.CONNECTION.unsubscribe("RealTime_Reconnected")}this.undelegateEvents()},reset:function(){var id=this.$el.attr("id");if(this.options.enableSort&&this.options.sortConfig&&this.options.sortConfig.descriptor){this.options.sortConfig.changeSortDescriptor=true;this.sortView(this.options.sortConfig,true)}else{this.render()}if(this.options.streaming){if(this.lastRegisterCall){this.unregister()}this.register()}this.publish("loaded",id)},render:function(){var self=this;var id=self.$el.attr("id");IFB.Utils.TemplateLoader.loadRemoteTemplate(this.options.templateId,this.options.templateFile,function(template){var compiled_template=_.template(template,{model:self.model,view:self});self.$el.html(compiled_template);self.publish("rendered",id)});this.clearDomElementsMap();return self},onFetchError:function(){},changeDataParam:function(){var self=this;return function(data){self.model.options.serviceParams.data.param=data;self.model.load()}},reload:function(serviceParams){this.model.load(serviceParams)},publish:function(topic,data){this.trigger(topic,data)},subscribe:function(topic,callback,context){this.on(topic,callback,context)},register:function(){if(!this.options.streaming){return}var instruments=this.model.models?_.map(this.model.models,function(instrument){return instrument.getDescriptorValue("MV")}):[this.model.getDescriptorValue("MV")];this.lastRegisterCall={descriptors:this.model.options.headerRT?this.model.options.headerRT.split(","):(this.model.options.serviceParams.data.header||"").split(","),instruments:instruments};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.register({wnd:this.cid,instruments:this.lastRegisterCall.instruments,descriptors:this.lastRegisterCall.descriptors,context:this,callback:this.onUpdateData})}},unregister:function(){this.domElementsMap={};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.unregister({wnd:this.cid,instruments:this.lastRegisterCall.instruments,descriptors:this.lastRegisterCall.descriptors,context:this,callback:this.onUpdateData})}},onRender:function(){throw new Error("This method must be overrided")},initializeStreamingConfiguration:function(){if(!this.options.streaming){return}if(!this.options.topFlopCls||this.options.topFlopCls.length!==3){this.options.topFlopCls={top:"ifb-top",flop:"ifb-flop",equal:"ifb-equal"}}if(!this.options.hiEffectCls||this.options.hiEffectCls.length!==3){this.options.hiEffectCls={top:"ifb-highlight-top",flop:"ifb-highlight-flop",equal:"ifb-highlight-equal"}}if(!this.options.hiEffectMillis){this.options.hiEffectMillis=3e3}this.clearDomElementsMap();IFB.Services.Streaming.CONNECTION.subscribe("RealTime_Reconnected",this.realTimeReconnected,this)},realTimeReconnected:function(){this.reconnectingRealTime=true;this.reset()},clearDomElementsMap:function(){this.domElementsMap={}},onUpdateData:function(data){var instrument=this.model.getElementById(data.MV);var elements;if(!instrument){return}this.updateInstrumentData(instrument,data)},updateInstrumentData:function(instrument,data){var self=this;var mv=data.MV;_.each(data.V,function(msg){var calculatedFields=[];key="[data-mv='"+mv+"'][data-descriptor='"+msg.D+"']";if(!self.domElementsMap[key]){self.domElementsMap[key]=$(key,self.$el)}elements=self.domElementsMap[key];if(self.options.highlightUsesPrevLastTrend&&msg.D===IFB.Descriptors.Last.descriptor){self.storePrevLastTrend(instrument,msg.V)}instrument.setDescriptorValue(msg.D,msg.V);if(elements.length>0){self.updateDOM(instrument,elements,msg.V,calculatedFields)}self.updateCalculatedFields(instrument,calculatedFields)})},updateCalculatedFields:function(instrument,calculatedFields){},getPercent:function(total,partial){var result=0;if(total){result=Math.round(partial*100/total*100)/100}return result},updateDOM:function(instrument,elements,value,calculatedFields){var self=this;_.each(elements,function(element){var el=$(element);var parent=$(el).parent();var dataType=el.attr("data-type");var dataDecimals=el.attr("data-decimals")||2;var dataDescriptor=el.attr("data-descriptor");var dataSuffix=el.attr("data-suffix")||"";var dataZeroValue=el.attr("data-zeroValue")||"";var dataPositiveSign=el.attr("data-positiveSign")||"";var dataInverseColors=el.attr("data-inverseColors")||"";var difValue=self.getDifValue(instrument,$(el).attr("data-dif-reference")||IFB.Descriptors.Trend.descriptor,value);if(self.isColorizedElement(el)){self.updateColor(el,difValue,dataInverseColors)}else if(self.isColorizedElement(parent)){self.updateColor(parent,difValue,dataInverseColors)}if(dataType!=="silent"){var formatedValue=self.formatValue(value,dataType,Number(dataDecimals),dataZeroValue,dataPositiveSign,dataSuffix,instrument,el);if(dataType!=="topFlopBar"){el.html(formatedValue)}else{var total=Number(el.attr("data-total"));var percent=self.getPercent(total,Number(value));el.attr("data-value",value);if(!percent){el.hide()}else{el.show();el.css("width",percent+"%")}}}var descriptorNumber=dataDescriptor&&dataDescriptor.indexOf("D")===0?dataDescriptor.substring(1):dataDescriptor;if((!self.options.highlightDescriptors||self.options.highlightDescriptors.indexOf(descriptorNumber)!==-1)&&descriptorNumber!==IFB.Descriptors.Trend.descriptor.replace("D","")){if(self.options.highlightUsesPrevLastTrend){var prevLastTrend=self.getDifValue(instrument,"PREV_LAST_TREND");self.highlight(el,prevLastTrend,dataInverseColors)}else{self.highlight(el,difValue,dataInverseColors)}}if(calculatedFields){var dataCalcTrigger=el.attr("data-calc-trigger");if(dataCalcTrigger){_.each(dataCalcTrigger.split(","),function(_field){var field=_field.toLowerCase();if(calculatedFields.indexOf(field)===-1){calculatedFields.push(field)}})}}})},formatValue:function(value,type,decimals,zeroValue,positiveSign,suffix,instrument,el){if(type==="number"){return instrument.formatValueAsNumber(value,decimals,zeroValue,positiveSign,suffix)}else if(type==="date"){return instrument.formatValueAsDate(value)}else if(type==="time"){return instrument.formatValueAsTime(value)}else if(type==="dateOrTime"){var dateFormat=el.attr("data-dateFormat");var timeFormat=el.attr("data-timeFormat");return instrument.formatValueAsDateOrTime(value,dateFormat,timeFormat)}else if(type==="topFlopBar"){return""}return value},isColorizedElement:function(el){return $(el).hasClass(this.options.topFlopCls.top)||$(el).hasClass(this.options.topFlopCls.flop)||$(el).hasClass(this.options.topFlopCls.equal)},highlight:function(el,difValue,inverseColors){var self=this;var cls;var top=inverseColors==="true"?this.options.hiEffectCls.flop:this.options.hiEffectCls.top;var flop=inverseColors==="true"?this.options.hiEffectCls.top:this.options.hiEffectCls.flop;var equal=this.options.hiEffectCls.equal;if(difValue>0){cls=top}else if(difValue<0){cls=flop}else{cls=equal}el.addClass(cls);_.delay(function(el){el.removeClass(cls)},this.options.hiEffectMillis,el)},updateColor:function(el,difValue,inverseColors){var top=inverseColors==="true"?this.options.topFlopCls.flop:this.options.topFlopCls.top;var flop=inverseColors==="true"?this.options.topFlopCls.top:this.options.topFlopCls.flop;var equal=this.options.topFlopCls.equal;el.removeClass(top+" "+flop+" "+equal);if(difValue>0){el.addClass(top)}else if(difValue<0){el.addClass(flop)}else{el.addClass(equal)}},getDifValue:function(instrument,descriptor,defaultValue){var value=descriptor?instrument.getDescriptorValue(descriptor)||defaultValue:defaultValue;if(descriptor===IFB.Descriptors.Trend.descriptor){return value==="1"?1:value==="2"?-1:0}return Number(value)},storePrevLastTrend:function(instrument,value){var decimals=instrument.getDescriptorValue(IFB.Descriptors.Decimals.descriptor)||4;var prevLast=instrument.getDescriptorValue(IFB.Descriptors.Last.descriptor)||0;var prevLastTrend=(value-prevLast).toFixed(decimals);instrument.setDescriptorValue("PREV_LAST_TREND",prevLastTrend)},initializeScroll:function(next){if(IFB.Utils.Helper.isMobileWidth()){return}this.heightScroll=this.options.enableScroll?(this.options.heightScroll||this.heightScroll)+"px":"auto";if(this.options.enableScroll&&this.options.elScroll){$(this.options.elScroll.selector).parent().css("max-height",this.heightScroll);this.$el.find(this.options.elScroll.selector).scrollLayout()}if(_.isFunction(next)){next()}},changeSortDescriptor:false,sortConfig:{},addSortCss:function(){$("th[data-descriptor]",this.$el).append('<span class="'+this.sortConfig.css.arrow+'"></span>');$('th[data-descriptor="'+this.sortConfig.descriptor+'"] span',this.$el).addClass(this.sortConfig.css[this.sortConfig.direction]);$('th[data-descriptor="'+this.sortConfig.descriptor+'"]',this.$el).toggleClass("arrange")},sortView:function(data){if(!this.options.enableSort){return}var sortDescriptor=data.descriptor;if(!sortDescriptor){return}this.changeSortDescriptor=data.changeSortDescriptor||this.sortConfig.descriptor!==sortDescriptor;this.sortConfig.descriptor=sortDescriptor;this.sortConfig.type=this.getSortType();this.sortConfig.direction=data.direction||this.setSortDirection();this.sortModel();this.updateServiceParamSort();this.render()},getNumber:function(value){if(value===undefined||value===""){return 0}else{return Number(value)}},sortModel:function(){var self=this;var type=this.sortConfig.type;var direction=this.sortConfig.direction;var descriptor=this.sortConfig.descriptor;var initialValue;var lastValue;this.model.models.sort(function(initial,last){var getValueFromModel=function(model,descriptor,type){var value=typeof model[descriptor]==="function"?model[descriptor]():self.model.userHeader?model.getRawDataFromColumnadoConfig(self.model.userHeader.get(descriptor.replace("D",""))):model.data[descriptor];return type==="number"?self.getNumber(value):value};initialValue=getValueFromModel(initial,descriptor,type);lastValue=getValueFromModel(last,descriptor,type);if(type==="number"){if(direction==="asc"){return initialValue-lastValue}else{return lastValue-initialValue}}else{if(direction==="asc"){return initialValue>lastValue?1:-1}else{return initialValue>lastValue?-1:1}}})},setSortDirection:function(){var sortDirection="";if(this.changeSortDescriptor){if(this.sortConfig.type==="number"){sortDirection="desc"}else{sortDirection=this.sortConfig.descriptor===IFB.Descriptors.Date.descriptor||this.sortConfig.descriptor===IFB.Descriptors.Time.descriptor?"desc":"asc"}}else{sortDirection=this.sortConfig.direction==="asc"?"desc":"asc"}return sortDirection},updateServiceParamSort:function(){var descriptor=this.sortConfig.descriptor.replace("D","");this.model.options.serviceParams.data.sort=this.sortConfig.direction==="desc"?"-"+descriptor:descriptor},getSortType:function(){try{return _.findWhere(IFB.Descriptors,{descriptor:this.sortConfig.descriptor}).sortType||"number"}catch(e){return"number"}}});IFB.Views.TraderBase=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.lastRegisterCallTrader=undefined;this.initializeStreamingConfigurationTrader()},reconnectingTrader:false,initializeStreamingConfigurationTrader:function(){if(!this.options.streamingTrader){return}this.listenTo(this.model,"add",this.onViewCollectionAddElement);IFB.Services.Trading.CONNECTION.subscribe("WebTrader_Reconnected",this.webTraderReconnected,this);if(!this.options.streamingType){this.options.streamingType=IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS}if(!this.options.topFlopCls||this.options.topFlopCls.length!==3){this.options.topFlopCls={top:"ifb-top",flop:"ifb-flop",equal:"ifb-equal"}}if(!this.options.hiEffectCls||this.options.hiEffectCls.length!==3){this.options.hiEffectCls={top:"ifb-highlight-top",flop:"ifb-highlight-flop",equal:"ifb-highlight-equal"}}if(!this.options.hiEffectMillis){this.options.hiEffectMillis=3e3}this.clearDomElementsMap()},webTraderReconnected:function(){this.reconnectingTrader=true;this.reload()},destroy:function(){if(this.options.streamingTrader){if(this.lastRegisterCallTrader){this.unregisterTrader(this.options.streamingType)}IFB.Services.Trading.CONNECTION.unsubscribe("WebTrader_Reconnected")}IFB.Views.Base.prototype.destroy.apply(this,arguments)},reset:function(){if(this.options.enableSort){this.sortModel()}if(this.options.streamingTrader){if(this.lastRegisterCallTrader){this.unregisterTrader(this.options.streamingType)}this.registerTrader(this.options.streamingType);this.reconnectingTrader=false}IFB.Views.Base.prototype.reset.apply(this,arguments)},registerTrader:function(streamingType){var key=this.model.models?_.map(this.model.models,function(elementModel){return elementModel.getId()}):[this.model.getElementById()];this.lastRegisterCallTrader={descriptors:(this.model.options.serviceParams.data.descriptorsTrader||"").split(","),instruments:key,accounts:this.model.options.serviceParams.data.Accounts||IFB.Trader.getAccountsList()};if(IFB.Services.Trading.CONNECTION){IFB.Services.Trading.CONNECTION.registerRT({accounts:this.lastRegisterCallTrader.accounts,descriptors:this.lastRegisterCallTrader.descriptors,informationType:streamingType,context:this,callback:this.onUpdateDataTrader})}},unregisterTrader:function(streamingType){this.domElementsMap={};if(IFB.Services.Trading.CONNECTION){if(this.reconnectingTrader||streamingType===IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS&&IFB.Trader.ordersStatusNotifications!==IFB.Trader.statusNotifications.NONE){IFB.Services.Trading.CONNECTION.unregisterEvents({accounts:this.lastRegisterCallTrader.accounts,informationType:streamingType,callback:this.onUpdateDataTrader})}else{IFB.Services.Trading.CONNECTION.unregisterRT({accounts:this.lastRegisterCallTrader.accounts,informationType:streamingType,callback:this.onUpdateDataTrader})}}},onUpdateData:function(data){IFB.Views.Base.prototype.onUpdateData.apply(this,arguments)},onUpdateDataTrader:function(response,key){if(!this.model){return}var self=this;if(response[IFB.Descriptors.Trader.BORRADO.descriptor]==="1"){this.model.reset();var mv=response[IFB.Descriptors.Trader.PortfolioMV.descriptor];if(!mv)return}var elementModel=this.model?this.model.getElementById(key):undefined;var elements;var keyDOM;if(elementModel){_.each(response,function(value,descriptor){var calculatedFields=[];keyDOM='[data-key="'+key+'"][data-descriptor="'+descriptor+'"]';if(!self.domElementsMap[keyDOM]){self.domElementsMap[keyDOM]=$(keyDOM,self.$el)}elements=self.domElementsMap[keyDOM];if(elements.length>0){self.updateTraderDOM(elementModel,elements,value,calculatedFields)}elementModel.setDescriptorValue(descriptor,value);self.updateCalculatedFields(elementModel,calculatedFields)})}else{this.model.add(response)}},updateTraderDOM:function(modelElement,elements,value,calculatedFields){var self=this;_.each(elements,function(element){var el=$(element);var parent=$(el).parent();var dataType=el.attr("data-type");var dataDecimals=el.attr("data-decimals")||2;var dataDescriptor=el.attr("data-descriptor");var dataSuffix=el.attr("data-suffix")||"";var dataZeroValue=el.attr("data-zeroValue")||"";var dataPositiveSign=el.attr("data-positiveSign")||"";var dataCalculated=el.attr("data-calculated")||"";var formatedValue="";var jsonDataCalculated="";if(dataCalculated!==""){modelElement.data[dataDescriptor]=value;jsonDataCalculated=modelElement.getCalculatedValue(dataCalculated);if(jsonDataCalculated.value){formatedValue=self.formatValue(jsonDataCalculated.value,dataType,dataDecimals,dataSuffix,modelElement);el.html(formatedValue)}el.addClass(jsonDataCalculated.addCls);el.removeClass(jsonDataCalculated.removeCls)}else{formatedValue=self.formatValue(value,dataType,dataDecimals,dataZeroValue,dataPositiveSign,dataSuffix,modelElement);el.html(formatedValue)}var descriptorNumber=dataDescriptor&&dataDescriptor.indexOf("D")===0?dataDescriptor.substring(1):dataDescriptor;if(!self.options.highlightDescriptors||self.options.highlightDescriptors.indexOf(descriptorNumber)!==-1){self.highlight(el,0)}if(calculatedFields){var dataCalcTrigger=el.attr("data-calc-trigger");if(dataCalcTrigger){_.each(dataCalcTrigger.split(","),function(_field){var field=_field.toLowerCase();if(calculatedFields.indexOf(field)===-1){calculatedFields.push(field)}})}}})},onViewCollectionAddElement:function(elementModel){if(elementModel){elementModel.createDescriptorsCalculated();this.sortModel();this.render()}},onOpenDetail:function(event,target){var el=$(target);var parent=el.parent();parent.toggleClass("expand");var expandedInfo=parent.next("tr");expandedInfo.slideToggle()}});IFB.Components.Base=IFB.Class(null,{defaults:{show:true},TYPE_PARAM_ISINMARKET:"6",_templates:IFB.Defaults.Templates||{},initialize:function(options){_.extend(this,Backbone.Events);this.options=_.clone(this.defaults);_.extend(this.options,options);this.views=[];this.dbService=new IFB.Services.Database({});if(this.options.show){this.show()}},show:function(){this.create()},hide:function(){this.destroy()},create:function(){throw new Error("This method must be overriden")},update:function(){throw new Error("This method must be overriden")},destroy:function(){this.destroyRequested=true;this.destroyAllViews()},configure:function(componentType,serviceUrl,method){this.config={};this.config.serviceParams=this.options.serviceParams||{};this.config.serviceParams.data=this.options.service||{};this.config.viewOptions=this.options.view||this.options.viewOptions||{};if(this.options.config&&this._templates[this.options.config]){_.defaults(this.config,this._templates[this.options.config]);_.defaults(this.config.viewOptions,this._templates[this.options.config].viewOptions);_.defaults(this.config.serviceParams,this._templates[this.options.config].serviceParams);if(this._templates[this.options.config].serviceParams){_.defaults(this.config.serviceParams.data,this._templates[this.options.config].serviceParams.data)}}if(componentType){_.defaults(this.config,IFB.Defaults.Components[componentType]);_.defaults(this.config.viewOptions,IFB.Defaults.Components[componentType].viewOptions);_.defaults(this.config.serviceParams,IFB.Defaults.Components[componentType].serviceParams);_.defaults(this.config.serviceParams.data,IFB.Defaults.Components[componentType].serviceParams.data)}if(this.config.serviceParams.data.type===this.TYPE_PARAM_ISINMARKET&&this.config.serviceParams.data.param){var dataParam=this.config.serviceParams.data.param;this.config.requestedParam=dataParam;this.config.serviceParams.data.param=this.translateIsinMarketParam(dataParam)}if(method){this.config.serviceParams.type=method}this.config.serviceParams.url=(this.config.serviceParams.url||IFB.Services.baseURL)+serviceUrl},translateIsinMarketParam:function(param){var isinList="";if(_.isArray(param)){_.each(param,function(isin){isinList+=this.translateMarket(isin)+";"},this);isinList=isinList.substring(0,isinList.length-1)}else{isinList=this.translateMarket(param)}return isinList},translateMarket:function(param){var isinList="";var isinLength=12;if(param.length>isinLength){var isin=param.substring(0,isinLength);var market=IFB.Utils.Helper.translateMarketCode(param.substring(isinLength));if(_.isArray(market)){market.forEach(function(item){isinList+=isin+item+";"})}else{isinList=isin+market}return isinList}return param},changeDataParam:function(param){var self=this;if(_.isArray(this.views)){this.views.forEach(function(viewDef){if(viewDef.options.updatable){viewDef.view.changeDataParam()(self.translateMarket(param))}})}},reload:function(){var self=this;if(_.isArray(this.views)){this.views.forEach(function(viewDef){if(viewDef.options.updatable){viewDef.view.reload()}})}},registerView:function(view,options){var self=this;options=options||{updatable:true};var viewDef={view:view,options:options,events:{loaded:false}};this.views.push(viewDef);this.chainEvent("loaded",viewDef);this.chainEvent("rendered",viewDef);this.chainEvent("updating",viewDef);this.chainEvent("perQuoteConsumed",viewDef);this.chainEvent("clickArc",viewDef);this.chainEvent("selectRow",viewDef);view.on("rendered",function(){self.attachTemplateClickEvents(view.$el)})},chainEvent:function(eventName,viewDef){var self=this;viewDef.view.on(eventName,function(){var args=arguments;viewDef.events[eventName]=true;if(_.every(self.views,function(viewItem){return viewItem.events[eventName]})){self.trigger(eventName,args[0],args[1],args[2])}})},destroyAllViews:function(){var self=this;_.each(this.views,function(viewDef){self.destroyView(viewDef.view)});this.views=[]},destroyView:function(view){if(view&&view.model){this.clearRefreshInterval(view.model);view.model.off(null,null,view);this.detachTemplateClickEvents(view.$el);view.destroy();view.$el.empty()}},clearRefreshInterval:function(model){if(model.refreshIntervalId){clearInterval(model.refreshIntervalId)}},attachTemplateClickEvents:function($el){var self=this;$(".ifbEventTrigger",$el).each(function(index,object){var listenArray=$(this).data("listen")?$(this).data("listen").split(","):["click tap"];$.each(listenArray,function(index,value){if($(object).data("event")){var eventArray=$(object).data("event").split(",");$(object).off(value).on(value,function(event){self.trigger(eventArray[index],$(object).data(),$(object),event)})}else{throw new Error("Falta propiedad data-event sobre el objeto:",$(object).id)}})})},detachTemplateClickEvents:function($el){var self=this;$(".ifbEventTrigger",$el).off()},removeTemplateElements:function(selector){$(selector,this.config.viewOptions.el).off();$(selector,this.config.viewOptions.el).remove()},isTemplateClickEvent:function(event){if(event&&event.target){return $(event.target).hasClass("ifbEventTrigger")}return false},_getInstrumentSituation:function(data,next,context){var self=this;this.dbService.loadDataLV({sesion:IFB.Services.Session,param:data.param,type:data.type,header:data.header,rt:data.rt||"1",sort:data.sort||"-1"},function(result){var json=JSON.parse(result);if(json.answer&&json.answer.LV){var dataSet=json.answer.LV;if(_.isArray(dataSet)){dataSet=dataSet[0]}next(dataSet,context)}})},showLoader:function(staticComponentConstructor,config){var el=$(this.config.viewOptions.el);var loaderEl=el.find(".ifb-loader-container");if(loaderEl.length===0){el.prepend('<div class="ifb-loader-container">');loaderEl=el.find(".ifb-loader-container")}this.loader=new staticComponentConstructor({config:config||"global_loading",view:{el:loaderEl}})},hideLoader:function(){if(this.loader){this.loader.destroy();this.loader=undefined}},register:function(){if(_.isArray(this.views)){this.views.forEach(function(viewDef){if(viewDef.view){viewDef.view.register()}})}}});IFB.Components.ChartBase=IFB.Class(IFB.Components.Base,{INSTRUMENTSITUATION_DESCRIPTORS:"1147,642,250,420,611,60,70,10060,10240,370,10370,10307",create:function(){throw new Error(200,"create must be implemented")},_doCreate:function(serviceParams){throw new Error(200,"_doCreate must be implemented")},_shouldBeSessionRequest:function(tradingHours,lastQuoteDate,lastQuoteTime,previousQuoteDate,gapAllowed){if(!tradingHours){return true}var shouldBeSessionRequest=true;var initTradingTime=tradingHours.substring(0,8);var today=moment().format("YYYYMMDD");var previosQuoteDateTime=moment(previousQuoteDate,"YYYYMMDD");var tradingStartTime=moment(today+" "+initTradingTime,"YYYYMMDD hh:mm:ss");var lastQuoteDateTime=moment(lastQuoteDate+" "+lastQuoteTime,"YYYYMMDD hhmmss");var marketGap=lastQuoteDateTime.diff(tradingStartTime,"minutes");if(marketGap<0){var timeGap=moment().diff(tradingStartTime,"minutes");if(timeGap<gapAllowed){shouldBeSessionRequest=false}}return shouldBeSessionRequest},_getInstrumentSituation:function(data,next){var self=this;this.dbService.loadDataLV({sesion:IFB.Services.Session,param:data.param,type:data.type,header:this.INSTRUMENTSITUATION_DESCRIPTORS,rt:"1",sort:"-1"},function(result){var json=JSON.parse(result);if(json.answer&&json.answer.LV){var dataSet=json.answer.LV;if(_.isArray(dataSet.V)){dataSet.V=dataSet.V[0]}if(dataSet.V&&dataSet.V.MV&&dataSet.V.MV.length>2){self.config.viewOptions.trend=Number(dataSet.V[IFB.Descriptors.Trend.descriptor]||0);self.config.viewOptions.decimals=dataSet.V[IFB.Descriptors.Decimals.descriptor]||2;next(dataSet.V)}}})},_getInstrumentsSituation:function(data,next){var self=this;this.dbService.loadDataLV({sesion:IFB.Services.Session,param:data.param,type:data.type,header:"1147,642,250,420,611,60,70,10060,10240,370,10370,10307",rt:"1",sort:"-1"},function(result){var json=JSON.parse(result);if(json.answer&&json.answer.LV){next(json.answer.LV.V)}})},changeDataParam:function(param){var self=this;if(_.isArray(this.views)){var data=self.config.serviceParams.data;data.param=self.translateMarket(param);self._getInstrumentSituation(data,function(data){self.views.forEach(function(viewDef){if(viewDef.options.updatable){var gapAllowed=IFB.Utils.Helper.getPreOpeningDiffMinutes();var tradingHours=self.config.viewOptions.openingTime||data.D611;if(!self._shouldBeSessionRequest(tradingHours,data.D60,data.D70,data.D10060,gapAllowed)){self._changeViewOptionsNotSessionRequest(data,self.config.serviceParams,self.config.viewOptions,2)}else{self._restoreViewOptions()}viewDef.view.changeDataMvParam()(data.MV,self.config.viewOptions);var instrumentModel=new IFB.Models.Instrument(data);viewDef.view.instrument=instrumentModel}})})}},_changeViewOptionsNotSessionRequest:function(){return},_restoreViewOptions:function(){return},changeChartType:function(newType,redraw){var _redraw=redraw||true;var view=this.views&&this.views[0]?this.views[0].view:undefined;if(!Highcharts.getOptions().plotOptions[newType]){throw new Error("The chart type '"+newType+"' does not exist")}if(view&&view.chart&&view.chart.series&&view.chart.series[0]){view.typeChart=newType;view.setExtremes();view.chart.series[0].update({type:newType,data:view.getHighchartPoints(),color:view.getColor()},_redraw)}},zoom:function(dateUTCInit,dateUTCEnd){var view=this.views&&this.views[0]?this.views[0].view:undefined;if(view&&view.chart&&view.chart.series&&view.chart.series[0]){view.chart.xAxis[0].setExtremes(dateUTCInit,dateUTCEnd)}}});IFB.Components.News=IFB.Class(IFB.Components.Base,{model:undefined,view:undefined,callConfigure:function(){this.configure("News","/wtdb/NoticiasSesion")},create:function(){this.callConfigure();this.model=new IFB.Collections.News(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.News(viewOptions);this.registerView(this.view);this.model.load()}});IFB.Components.NewsRange=IFB.Class(IFB.Components.News,{callConfigure:function(){this.configure("NewsRange","/wtdb/NoticiasRangoFechas")}});IFB.Collections.Accounts=IFB.Collections.Base.extend({model:IFB.Models.Account,url:"/GetAccountsJSON",accountSelected:undefined,initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer){return[]}var data=message.answer;return data.length?data:[]},load:function(data){var request;var serviceParamsTrader=_.clone(this.options.serviceParams);serviceParamsTrader.data=_.clone(this.options.serviceParams.data);_.extend(serviceParamsTrader.data,data||{});serviceParamsTrader.url=IFB.Trader.getBaseURL()+"/GetAccountsJSON";var accountsParamsValue=this.options.serviceParams.data.Accounts||IFB.Trader.getAccountsList();serviceParamsTrader.data=JSON.stringify({Accounts:accountsParamsValue,TraderLink:IFB.Trader.configTrader.Enlaces.Carteras,SessionID:IFB.Trader.sessionID,Descriptors:serviceParamsTrader.data.descriptorsTrader});_.each(this.requests,function(request){request.abort()});this.requests=[];request=this.fetch(serviceParamsTrader);if(request){this.requests.push(request)}},setSelected:function(accountSelected){this.accountSelected=accountSelected},reset:function(){IFB.Collections.Base.prototype.reset.apply(this,arguments);this.selectFirstAccount()},selectFirstAccount:function(){this.accountSelected=this.getElementById(IFB.Trader.getFirstTradableAccountID())}});IFB.Collections.AlertList=IFB.Collections.Base.extend({model:IFB.Models.Alert,url:"/wtmg/AlertaLista",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){var data=[];this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.Alertas){return[]}if($.isArray(message.answer.Alertas.Alerta)){data=message.answer.Alertas.Alerta}else if(message.answer.Alertas.Alerta){data=[message.answer.Alertas.Alerta]}return data.length?data:[]}});IFB.Collections.ChartDaily=IFB.Collections.Base.extend({model:IFB.Models.ChartDailyPoint,url:"/wtdb/ChartDaily",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.answer||message.answer.error||!message.answer.LST||!message.answer.LST.TV||!message.answer.LST.TV.T15){return[]}return $.isArray(message.answer.LST.TV.T15)?message.answer.LST.TV.T15:[message.answer.LST.TV.T15]},getLastTime:function(){if(this.models&&this.models.length>0){return moment(this.models[this.models.length-1].id,"HHmmss").format("HHmmss")}return""},getXFirstPoints:function(){var points=this.getPoints();return points&&points.length>0?points[0][0]:undefined},getPoint:function(date,rawPoint){var point=[];point.push(moment(rawPoint.data.F13+"000000+0200","YYYYMMDDHHmmssZ").valueOf());point.push(Number(rawPoint.data.F4));return point},getPoints:function(){var self=this;var data=[];_.each(this.models,function(point){data.push(self.getPoint(self.date,point))});return data},_getRawChangePercent:function(index){var theModels=this.models;var currentPoint=theModels[index];if(theModels[index-1]){var previousPoint=theModels[index-1];var changePercent=this.calculateChangePercent(previousPoint.data.F6,currentPoint.data.F6);return changePercent}else{return""}},getPointTrend:function(index){var trend=0;var rawChangePercent=this._getRawChangePercent(index);if(typeof rawChangePercent==="number"){if(rawChangePercent<0){trend=2}else if(rawChangePercent>0){trend=1}}return trend},getPointChangePercent:function(index,decimals){var rawChangePercent=this._getRawChangePercent(index);if(typeof rawChangePercent==="number"){return this.formatValueAsNumber(rawChangePercent,decimals)}else{return""}},calculateChangePercent:function(previous,current){if(!previous){return 0}else{return(current-previous)/previous*100}},formatValueAsNumber:function(value,decimals,zeroValue,positiveSign,suffix){if(zeroValue&&(!value||value==="0")){return zeroValue}var fmtValue=accounting.formatNumber(value,{precision:decimals,zero:zeroValue||""});fmtValue+=suffix||"";return positiveSign&&value>0&&fmtValue.indexOf(positiveSign)===-1?positiveSign+fmtValue:fmtValue}});IFB.Collections.ChartIntraday=IFB.Collections.Base.extend({model:IFB.Models.ChartIntradayPoint,url:"/wtdb/ChartIntraday",date:"",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.answer||message.answer.error||!message.answer.LST||!message.answer.LST.TV||!message.answer.LST.TV.T09){return[]}this.date=message.answer.LST.TV.FSD;return $.isArray(message.answer.LST.TV.T09)?message.answer.LST.TV.T09:[message.answer.LST.TV.T09]},getLastTime:function(){if(this.models&&this.models.length>0){return moment(this.models[this.models.length-1].id,"HHmmss").format("HHmmss")}return""},getXFirstPoints:function(){var points=this.getPoints();return points&&points.length>0?points[0][0]:undefined},getPoint:function(date,rawPoint){var point=[];point.push(moment(date+rawPoint.data.F4+"+0200","YYYYMMDDHHmmssZ").valueOf());point.push(Number(rawPoint.data.F5));point.push(Number(rawPoint.data.F7));point.push(Number(rawPoint.data.F6));point.push(Number(rawPoint.data.F8));return point},getPoints:function(){var self=this;var data=[];_.each(this.models,function(point){data.push(self.getPoint(self.date,point))});return data},getLastModel:function(){if(this.models&&this.models.length>0){return this.models[this.models.length-1]}return undefined},getFrequency:function(){return this.options.serviceParams.data.compressionMult||""},updateLastModel:function(updatedModel){this.models[this.models.length-1]=new IFB.Models.ChartIntradayPoint(updatedModel.data)},addNewModel:function(pointModel){var newModel=new IFB.Models.ChartIntradayPoint(pointModel.data);this.add(newModel)}});IFB.Collections.Columnado=IFB.Collections.Base.extend({model:IFB.Models.Columnado,url:"/wtdb/Columnado",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){var data=[];var cols;this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.Header){return[]}if(message.answer.Header.Group){_.each(message.answer.Header.Group,function(group){cols=$.isArray(group.Col)?group.Col:[group.Col];_.each(cols,function(col){col.groupName=group.Name;data.push(col)})})}else{data=$.isArray(message.answer.Header.Col)?message.answer.Header.Col:[message.answer.Header.Col]}return data.length?data:[]}});IFB.Collections.Dividends=IFB.Collections.Base.extend({model:IFB.Models.Instrument,url:"/wtdb/LoadDividends",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.LV){return[]}var data=$.isArray(message.answer.LV.V)?message.answer.LV.V:[message.answer.LV.V];return data.length?data:[]}});IFB.Collections.Header=Backbone.Collection.extend({model:IFB.Models.Header});IFB.Collections.InstrumentList=IFB.Collections.Base.extend({model:IFB.Models.Instrument,url:"/wtdb/LoadDataLV",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){var data=[];this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.LV){return[]}this.infoTag=message.answer.LV.Info||{};data=$.isArray(message.answer.LV.V)?message.answer.LV.V:[message.answer.LV.V];return data.length?data:[]}});IFB.Collections.News=IFB.Collections.Base.extend({model:IFB.Models.News,url:"/wtdb/NoticiasSesion",date:undefined,initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.Noticias){return[]}this.date=message.answer.Noticias.Date||moment().format("YYYYMMDD");if(message.answer.Noticias.TotalNum==="0"||!message.answer.Noticias.TN){return[]}return $.isArray(message.answer.Noticias.TN)?message.answer.Noticias.TN:[message.answer.Noticias.TN]}});IFB.Collections.NewsCriteria=IFB.Collections.News.extend({model:IFB.Models.News,url:"/wtdb/NoticiasCriterios",initialize:function(){IFB.Collections.News.prototype.initialize.apply(this,arguments)}});IFB.Collections.NewsDetail=IFB.Collections.Base.extend({model:IFB.Models.NewsDetail,url:"/wtdb/News",date:undefined,initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.Noticia){return[]}this.date=message.answer.Noticia.Date||moment().format("YYYYMMDD");if(!message.answer.Noticia){return[]}return[message.answer.Noticia]}});IFB.Collections.NewsRange=IFB.Collections.News.extend({model:IFB.Models.News,url:"/wtdb/NoticiasRangoFechas",initialize:function(){IFB.Collections.News.prototype.initialize.apply(this,arguments)}});IFB.Collections.OpenPositionList=IFB.Collections.Base.extend({model:IFB.Models.OpenPosition,url:"/GetOpenPositionJSON",selectedAccount:"",initialize:function(){this.selectFirstAccount();IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer){return[]}var data=message.answer;return data.length?data:[]},getInstrumentsArray:function(){var arrMV=[];_.each(this.models,function(openPosition){var mv=openPosition.getPortfolioMV();if($.inArray(mv,arrMV)===-1){if(mv&&mv.length===7){arrMV.push(mv)}}});return arrMV},getInstrumentsList:function(){var arrayMV=this.getInstrumentsArray();return arrayMV.join(",")},setLastPrice:function(MV,last){_.each(this.models,function(openPosition){var mv=openPosition.getPortfolioMV();if(mv===MV){openPosition.setDescriptorValue(IFB.Descriptors.Last.descriptor,last)}})},getModelByMV:function(MV){return _.find(this.models,function(openPosition){var mv=openPosition.getPortfolioMV();return mv===MV})},setSelectedAccount:function(value){this.selectedAccount=value},getSelectedAccount:function(){return this.selectedAccount},reset:function(){IFB.Collections.Base.prototype.reset.apply(this,arguments);this.selectFirstAccount()},selectFirstAccount:function(){this.selectedAccount=IFB.Trader.getFirstTradableAccountID()},load:function(data){var request;var serviceParamsTrader=_.clone(this.options.serviceParams);serviceParamsTrader.data=_.clone(this.options.serviceParams.data);_.extend(serviceParamsTrader.data,data||{});serviceParamsTrader.url=IFB.Trader.getBaseURL()+"/GetOpenPositionJSON";var accountsParamsValue=this.options.serviceParams.data.Accounts||IFB.Trader.getAccountsList();serviceParamsTrader.data=JSON.stringify({Accounts:accountsParamsValue,TraderLink:IFB.Trader.configTrader.Enlaces.Carteras,SessionID:IFB.Trader.sessionID,Descriptors:serviceParamsTrader.data.descriptorsTrader,Type:serviceParamsTrader.data.accountType,_dc:(new Date).getTime()});_.each(this.requests,function(request){request.abort()});this.requests=[];request=this.fetch(serviceParamsTrader);if(request){this.requests.push(request)}},createDescriptorsCalculated:function(){_.each(this.models,function(openPosition){openPosition.createDescriptorsCalculated()})},setInstrumentsData:function(instruments){var self=this;_(instruments).each(function(instrument){_(self.models).each(function(openPosition){var mv=openPosition.getPortfolioMV();if(mv===instrument.id){openPosition.setInstrumentData(instrument)}})})}});IFB.Collections.OrdersList=IFB.Collections.Base.extend({model:IFB.Models.Order,url:"/GetOrderBookJSON",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){var data=[];this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer){return[]}data=message.answer;return data.length?data:[]},load:function(data){var request;var serviceParamsTrader=_.clone(this.options.serviceParams);serviceParamsTrader.data=_.clone(this.options.serviceParams.data);_.extend(serviceParamsTrader.data,data||{});serviceParamsTrader.url=IFB.Trader.getBaseURL()+"/GetOrderBookJSON";serviceParamsTrader.data=JSON.stringify({Accounts:IFB.Trader.getAccountsOrderBook(),TraderLink:IFB.Trader.configTrader.Enlaces.Ordenes,SessionID:IFB.Trader.sessionID,History:"N",Descriptors:serviceParamsTrader.data.descriptorsTrader,_dc:(new Date).getTime()});_.each(this.requests,function(request){request.abort()});this.requests=[];request=this.fetch(serviceParamsTrader);if(request){this.requests.push(request)}}});IFB.Collections.Positions=IFB.Collections.Base.extend({model:IFB.Models.Positions,url:"/wtdb/LoadDataPosiciones",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){var data=[];this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.LV){return[]}this.infoTag=message.answer.LV.Info||{};if(message.answer.LV.V){data=$.isArray(message.answer.LV.V)?message.answer.LV.V:[message.answer.LV.V];data=_.sortBy(data,function(position){var value=position[IFB.Descriptors.MarketDepth.descriptor];if(value)return parseInt(value,10);else return 0})}return data.length?data:[]}});IFB.Collections.SignificantFacts=IFB.Collections.Base.extend({model:IFB.Models.SignificantFact,url:"/wtdb/HechoRelevanteCercano",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments)},parse:function(message){this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.LV){return[]}var data=$.isArray(message.answer.LV.V)?message.answer.LV.V:[message.answer.LV.V];return data.length?data:[]}});IFB.Collections.TableField=IFB.Collections.Base.extend({model:{},url:"/wtdb/LoadDataLV",table:"",initialize:function(){IFB.Collections.Base.prototype.initialize.apply(this,arguments);this.table=this.options.serviceParams.table;this.model=this.getTypeModel()},parse:function(message){var data=[];var dataResponse;this.trigger("dataLoaded",this);if(!message.status.ok||!message.answer.LST||!message.answer.LST[this.table]){return[]}dataResponse=message.answer.LST[this.table];data=$.isArray(dataResponse)?dataResponse:[dataResponse];return data.length?data:[]},getTypeModel:function(){switch(this.table){case"T29":return IFB.Models.Factset}}});IFB.Services.Activity=IFB.Class(IFB.Services.Base,{macroParameters:{EXTERNAL_USER:"[USUARIOEXTERNO]",EXTERNAL_SESSION:"[SESIONEXTERNA]",COMPONENT:"[COMPONENTE]",ACTION:"[ACCION]",SOURCE:"[ORIGEN]",DEVICE:"[DISPOSITIVO]",PARAMS:"[PARAMETROS]",DATE_DD_MM_AAAA:"[FECHA_DD-MM-AAAA]",HOUR:"[HORA]"},formats:{DATE:"DD/MM/YYYY",HOUR:"HH:mm:s",SECONDARY_PARAM:"{0}:{1}",SECONDARY_PARAMS_SEPARATOR:";",ARRAY_PARAMS_SEPARATOR:"|"},isActivityInfobolsa:false,url:undefined,params:undefined,listParams:undefined,eventsTrace:undefined,initialize:function(options){this.isActivityInfobolsa=options.isActivityInfobolsa||false;this.url=options.Url;this.params=options.Params;this.eventsTrace=options.eventsTrace;this.baseURL=window.location.protocol+"//"+this.url;this.servicename="activity";this.readParams()},readParams:function(){this.listParams=[];if(this.params&&this.params.length>0){var paramValuePairs=this.params.split(";");_.each(paramValuePairs,function(paramValuePair){var paramValue=paramValuePair.split("=");this.listParams.push({name:paramValue[0],value:paramValue[1]})},this)}},notify:function(component,action,params,source){if(this.url){var parameters=this.parseParamsUrl(component,action,params,source);this.postRequest(this.baseURL,parameters,"notify",this.onCallbackNotify,this,[component,action])}},onCallbackNotify:function(response,context,paramsCallback){if(context.isActivityInfobolsa&&context.eventsTrace){var start=response.indexOf("http://");var end=response.indexOf("\nPost");var urlTest=response.substring(start,end);console.log("LOG ACTIVIDAD. Componente:",paramsCallback[0],"- Accion:",paramsCallback[1],"- URL Comprobacion:",urlTest)}},parseParamsUrl:function(component,action,params,source){var paramsUrl={};_.each(this.listParams,function(param){var valueParam;if(this.valueParamIsMacro(param.value)){valueParam=this.parseParamMacro(param.value,component,action,params,source)}else{valueParam=param.value}paramsUrl[param.name]=valueParam},this);return paramsUrl},valueParamIsMacro:function(value){return value.indexOf("[")!==-1&&value.indexOf("]")!==-1},parseParamMacro:function(valueParam,component,action,params,source){var valueParsed="";switch(valueParam){case this.macroParameters.EXTERNAL_USER:var userInfo=IFB.Utils.Helper.getUserInfo();if(userInfo){valueParsed=userInfo.externalUser}break;case this.macroParameters.EXTERNAL_SESSION:var userInfo=IFB.Utils.Helper.getUserInfo();if(userInfo){valueParsed=userInfo.externalSession}break;case this.macroParameters.COMPONENT:valueParsed=component;break;case this.macroParameters.ACTION:valueParsed=action;break;case this.macroParameters.SOURCE:valueParsed=source;break;case this.macroParameters.DEVICE:valueParsed="PM";break;case this.macroParameters.PARAMS:if(_.isString(params)){valueParsed=params}else{valueParsed=this.jsonToParams(params)}break;case this.macroParameters.DATE_DD_MM_AAAA:valueParsed=this.getDate();break;case this.macroParameters.HOUR:valueParsed=this.getHour();break}return valueParsed},getDate:function(){return moment().format(this.formats.DATE)},getHour:function(){return moment().format(this.formats.HOUR)},jsonToParams:function(jsonParams){var stringParams="";if(typeof jsonParams!=="object"){stringParams=jsonParams.toString().toUpperCase()}else if(_.isArray(jsonParams)){_.each(jsonParams,function(value,key){stringParams+=stringParams.length>0?this.formats.ARRAY_PARAMS_SEPARATOR:"";stringParams+=this.jsonToParams(value)},this)}else{_.each(jsonParams,function(value,key){stringParams+=stringParams.length>0?this.formats.SECONDARY_PARAMS_SEPARATOR:"";stringParams+=IFB.Utils.Format.stringFormat(this.formats.SECONDARY_PARAM,[key.toUpperCase(),this.jsonToParams(value)])},this)}return stringParams},request:function(method,url,parameters,methodname,successCallback,context,successCallbackParams){$.ajax({type:method,url:url,data:parameters,success:function(response){if(successCallback){successCallback(response,context,successCallbackParams)}}})}});IFB.Services.Database=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.Database.parent.initialize.call(this,options);this.baseURL=options.baseURL||IFB.Services.baseURL+"/wtdb/";this.servicename="database"},serviceURLs:{loadDataLV:"LoadDataLV",chartDaily:"ChartDaily",chartIntraday:"ChartIntraday",relevantFactNearby:"HechoRelevanteCercano",criteriaNews:"NoticiasCriterios",dateRangeNews:"NoticiasRangeFechas",news:"News",recentNews:"NoticiasSesion",instrumentInGroup:"ValorEnAgrupacion",loadDataCombo:"LoadDataCombo",valuePerquote:"HayPerquote",columnado:"Columnado",loadDataMasSubenBajanContratan:"LoadDataMasSubenBajanContratan"},loadDataLV:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loadDataLV;this.cacheRequest(url,params,this.serviceURLs.loadDataLV,callback._function,context,callback.params)},loadDataMasSubenBajanContratan:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loadDataMasSubenBajanContratan;this.cacheRequest(url,params,this.serviceURLs.loadDataMasSubenBajanContratan,callback._function,context,callback.params)},chartDaily:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.chartDaily;this.cacheRequest(url,params,this.serviceURLs.chartDaily,callback._function,context)},chartIntraday:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.chartIntraday;this.cacheRequest(url,params,this.serviceURLs.chartIntraday,callback._function,context)},relevantFactNearby:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.relevantFactNearby;this.cacheRequest(url,params,this.serviceURLs.relevantFactNearby,callback._function,context)},criteriaNews:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.criteriaNews;this.cacheRequest(url,params,this.serviceURLs.criteriaNews,callback._function,context)},dateRangeNews:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.dateRangeNews;this.cacheRequest(url,params,this.serviceURLs.dateRangeNews,callback._function,context)},news:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.news;this.cacheRequest(url,params,this.serviceURLs.news,callback._function,context)},recentNews:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.recentNews;this.cacheRequest(url,params,this.serviceURLs.recentNews,callback._function,context)},instrumentInGroup:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.instrumentInGroup;this.cacheRequest(url,params,this.serviceURLs.instrumentInGroup,callback._function,context)},loadDataCombo:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loadDataCombo;this.cacheRequest(url,params,this.serviceURLs.loadDataCombo,callback._function,context)},valuePerquote:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.valuePerquote;this.postRequest(url,params,this.serviceURLs.valuePerquote,callback._function,context)},columnado:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.columnado;this.cacheRequest(url,params,this.serviceURLs.columnado,callback._function,context,callback.params)}});IFB.Services.ExternalUsers=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.ExternalUsers.parent.initialize.call(this,this.options);this.baseURL=this.options.baseURL||IFB.Services.ExternalUsersUrl;this.servicename="externalusers"},serviceURLs:{autoLogin:"AutoLogin.aspx",clickOnDocuments:"Si3/ClickOnDocuments.aspx"},autoLogin:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.autoLogin;this.getRequestNoAuth(url,params,this.serviceURLs.autoLogin,callback._function,context,callback.params)},clickOnDocuments:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.clickOnDocuments;this.getRequestNoAuth(url,params,this.serviceURLs.clickOnDocuments,callback._function,context,callback.params)}});IFB.Services.Management=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.Management.parent.initialize.call(this,this.options);this.baseURL=this.options.baseURL||IFB.Services.baseURL+"/wtmg/";this.servicename="management"},serviceURLs:{addAlert:"AlertaAlta",listAlert:"AlertaLista",removeAlert:"AlertaBaja",validateSID:"ValidateSID",getProfile:"Profile",getProductConfig:"ProdConfig",getEvents:"EventosConsulta",loadFile:"LoadFile",loadUserFiles:"LoadUserFiles",saveFile:"SaveFile",getOthersLikeYou:"EventosOtrosComoTu",login:"Login",loginSesion:"LoginSesion",addAlertING:"AlertaAltaING",deleteExternalUser:"UsuarioExternoBorrar"},addAlert:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.addAlert;var parameters={alerta:params.alert};this.postRequest(url,parameters,this.serviceURLs.addAlert,callback._function,context)},addAlertING:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.addAlertING;var parameters={alerts:JSON.stringify(params.alerts)};this.postRequest(url,parameters,this.serviceURLs.addAlertING,callback._function,context)},listAlert:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.listAlert;var parameters={sesion:params.session,idAlertas:params.idAlert};this.postRequest(url,parameters,this.serviceURLs.listAlert,callback._function,context,callback.params)},removeAlert:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.removeAlert;var parameters={sesion:params.session,alerta:params.alertId,formato:params.format};this.postRequest(url,parameters,this.serviceURLs.removeAlert,callback._function,context)},validateSID:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.validateSID;var parameters={sid:params.sid};this.postRequest(url,parameters,this.serviceURLs.validateSID,callback._function,context,callback.params)},getProfile:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.getProfile;var parameters={sesion:params.session,canalessubcanales:params.canalessubcanales};this.postRequest(url,parameters,this.serviceURLs.getProfile,callback._function,context,callback.params)},getProductConfig:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.getProductConfig;var parameters={sesion:params.session};this.postRequest(url,parameters,this.serviceURLs.getProductConfig,callback._function,context,callback.params)},getEvents:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.getEvents;this.postRequest(url,params,this.serviceURLs.getEvents,callback._function,context,callback.params)},getOthersLikeYou:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.getOthersLikeYou;this.postRequest(url,params,this.serviceURLs.getOthersLikeYou,callback._function,context,callback.params)},loadFile:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loadFile;var parameters={sesion:params.session,file:params.file,type:params.type,transform:params.transform};this.postRequest(url,parameters,this.serviceURLs.loadFile,callback._function,context,callback.params)},saveFile:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.saveFile;var parameters={sesion:params.session,file:params.file,type:params.type,replace:params.replace,content:params.content,transform:params.transform};this.postRequest(url,parameters,this.serviceURLs.saveFile,callback._function,context,callback.params)},loadUserFiles:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loadUserFiles;var parameters={sesion:params.session,type:params.type,contentpreload:params.contentpreload};this.postRequest(url,parameters,this.serviceURLs.loadUserFiles,callback._function,context,callback.params)},login:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.login;var parameters={usr:params.usr,pwd:params.pwd,lang:params.lang,product:params.product};this.postRequest(url,parameters,this.serviceURLs.login,callback._function,context,callback.params)},loginSesion:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.loginSesion;var parameters={sesion:params.session,producto:params.product};this.postRequest(url,parameters,this.serviceURLs.loginSesion,callback._function,context,callback.params)},deleteExternalUser:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.deleteExternalUser;var parameters={entidad:params.entidad,usuarioEntidad:params.usuarioEntidad,producto:params.producto};this.postRequest(url,parameters,this.serviceURLs.deleteExternalUser,callback._function,context,callback.params)}});IFB.Services.Portfolio=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.Portfolio.parent.initialize.call(this,this.options);this.baseURL=this.options.baseURL||IFB.ClientConfiguration&&IFB.ClientConfiguration.Services.PortfolioUrl?IFB.ClientConfiguration.Services.PortfolioUrl:IFB.Services.PortfolioUrl;this.servicename="portfolio"},serviceURLs:{addPortfolio:"AltaCartera",addOrder:"AltaMovimiento",getPortfolioList:"DameListaCarteras",getPortfolioOpenPosition:"PosicionAbierta",getPortfolioClosedPosition:"PosicionCerrada",removePortfolio:"BajaCartera",editPortfolio:"EditarCartera"},addPortfolio:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.addPortfolio;var parameters={sesionid:params.sesionid,nombrecartera:params.nombrecartera};this.postRequest(url,parameters,this.serviceURLs.addPortfolio,callback._function,context)},addOrder:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.addOrder;var parameters={sesionid:params.sesionid,carteraid:params.carteraid,sentido:params.sentido,mv:params.mv,titulos:params.titulos,precio:params.precio,fecha:params.fecha,hora:params.hora,comision:params.comision,divisa:params.divisa};this.postRequest(url,parameters,this.serviceURLs.addOrder,callback._function,context)},getPortfolioList:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.getPortfolioList;var parameters={sesionid:params.session,crea:params.crea};this.postRequest(url,parameters,this.serviceURLs.addPortfolio,callback._function,context)},getPortfolioOpenPosition:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.getPortfolioOpenPosition;var parameters={sesionid:params.session,carteraid:params.portfolioId};this.postRequest(url,parameters,this.serviceURLs.getPortfolioOpenPosition,callback._function,context)},getPortfolioClosedPosition:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.getPortfolioClosedPosition;var parameters={sesionid:params.session,carteraid:params.portfolioId};this.postRequest(url,parameters,this.serviceURLs.getPortfolioClosedPosition,callback._function,context)},removePortfolio:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.removePortfolio;var parameters={sesionid:params.session,carteraid:params.portfolioId};this.postRequest(url,parameters,this.serviceURLs.removePortfolio,callback._function,context)},editPortfolio:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+"/"+this.serviceURLs.editPortfolio;var parameters={sesionid:params.session,carteraid:params.portfolioId,nombrecartera:params.portfolioName};this.postRequest(url,parameters,this.serviceURLs.editPortfolio,callback._function,context)}});IFB.Services.SI3=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.SI3.parent.initialize.call(this,this.options);this.baseURL=this.options.baseURL||IFB.Services.baseURL+"/si3/";this.servicename="si3"},serviceURLs:{getClickOnDocuments:"GetClickOnDocuments",signDocument:"SignDocument",notifyDeleteUser:"NotificaBajaUsuario"},getClickOnDocuments:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.getClickOnDocuments;var parameters={codCompany:params.codCompany,codUsr:params.codUsr,codProduct:params.codProduct,codSeller:params.codSeller};this.postRequest(url,parameters,this.serviceURLs.getClickOnDocuments,callback._function,context)},signDocument:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.signDocument;var parameters={codCompany:params.codCompany,codDoc:params.codDoc,codUser:params.codUser,codProduct:params.codProduct,codInstal:params.codInstal,signDate:params.signDate,clientid:params.clientid,product:params.product};this.postRequest(url,parameters,this.serviceURLs.signDocument,callback._function,context)},notifyDeleteUser:function(params,callback,context){callback=_.isFunction(callback)?{_function:callback}:callback;var url=this.baseURL+this.serviceURLs.notifyDeleteUser;var parameters={codCompany:params.codCompany,codUser:params.codUser,emailsList:params.emailList,clientid:params.clientid,product:params.product};this.postRequest(url,parameters,this.serviceURLs.notifyDeleteUser,callback._function,context)}});IFB.Services.Streaming=IFB.Class(IFB.Services.Base,{isAlive:false,isLogout:false,TIMERHEARTBEAT:15e3,reconnecting:false,options:{},firstConnection:true,connected:false,actualFrame:1,messages:0,mapValues:undefined,netting:0,maxMessages:undefined,formatTypeJson:undefined,ifbTables:{Positions:"47"},streamingEnabled:true,initialize:function(options){_.extend(this,Backbone.Events);this.options=options||{};this.streamingEnabled=_.isUndefined(this.options.streamingEnabled)?true:this.options.streamingEnabled;IFB.Services.Streaming.parent.initialize.call(this,options);this.servicename="streaming";_.once(this.setDomainName());this.initConfig();if(this.isEnabled()){this.createFrames();this.addPostMessageListener()}},subscribe:function(event,callback,context){this.on(event,callback,context)},unsubscribe:function(event){this.off(event)},isEnabled:function(){return!!this.session&&this.streamingEnabled},initConfig:function(){this.maxMessages=this.options.maxMessages||5e3;this.formatTypeJson=this.options.formatTypeJson||"3";this.netting=this.options.netting||0},setDomainName:function(){var domain;if(IFB.ClientConfiguration&&IFB.ClientConfiguration.Services.Domain){domain=IFB.ClientConfiguration.Services.Domain}else if(IFB.Services.Domain){domain=IFB.Services.Domain}if(domain){document.domain=domain}},getStreamingBaseUrl:function(){if(IFB.ClientConfiguration&&IFB.ClientConfiguration.Services.StreamingBaseUrl){return IFB.ClientConfiguration.Services.StreamingBaseUrl}else{return IFB.Services.StreamingBaseUrl}},serviceURLs:{setConnection:"SetConnection.srf",registerRT:"RegisterRT.srf",unregisterRT:"UnregisterRT.srf",unregisterAllRT:"unregisterAll.srf",registerPos:"RegisterPos.srf",unregisterPos:"UnregisterPos.srf",registerNot:"RegisterNot.srf",unregisterNot:"UnregisterNot.srf"},createFrames:function(){var url=this.getStreamingBaseUrl()+"/"+this.serviceURLs.setConnection+"?sesion="+escape(this.session)+"&amortiguacion="+this.netting;this.createFrame({name:"iframe_conexion1",id:"iframe_conexion1",src:url+"&idconnection=1&formatType="+this.formatTypeJson+"&timestamp="+(new Date).getTime(),width:0,height:0,frameborder:0});this.createFrame({name:"iframe_conexion2",id:"iframe_conexion2",src:this.getStreamingBaseUrl()+"/blank.html",width:0,height:0,frameborder:0});this.isAlive=true;this.activityCheckWT()},createFrame:function(config){$('<iframe style="display:none" id="'+config.id+'" name="'+config.name+'" src="'+config.src+'" width="'+config.width+'" height="'+config.height+'" frameborder="'+config.frameborder+'" />').appendTo("body")},connect:function(callback){this.connected=true;this.messages=0;if(this.reconnecting){this.reconnecting=false;this.trigger("RealTime_Reconnected",this);console.log("Reconectado a Streaming ")}else{if(this.firstConnection){this.firstConnection=false;console.log("Conectado a Streaming ")}}if(callback&&"function"===typeof callback){callback()}},reconnect:function(){var url=this.getStreamingBaseUrl()+"/"+this.serviceURLs.setConnection+"?sesion="+escape(this.session)+"&amortiguacion="+this.netting+"&idconnection=1&formatType="+this.formatTypeJson+"&timestamp="+(new Date).getTime();if(this.connected){return}if($("#iframe_conexion"+this.actualFrame)){$("#iframe_conexion"+this.actualFrame).attr("src",url)}},disconnect:function(){if($("#iframe_conexion"+this.actualFrame)){this.connected=false;this.firstConnection=true;$("#iframe_conexion"+this.actualFrame).attr("src",IFB.Services.baseURL+"/blank.html")}},register:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.registerRT;var topic;var params={sesion:escape(this.session),wnd:registerInfo.wnd,lv:registerInfo.instruments.join(),header:registerInfo.descriptors.join(),initload:registerInfo.initload||0};this.postRequestNoAuth(url,params,this.serviceURLs.registerRt);_.each(registerInfo.instruments,function(instrument){topic=self.getTopic("D",instrument);self.on(topic,registerInfo.callback,registerInfo.context)})},unregister:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.unregisterRT;var topic;var params={sesion:escape(this.session),wnd:registerInfo.wnd,lv:registerInfo.instruments.join(),header:registerInfo.descriptors.join()};this.postRequestNoAuth(url,params,this.serviceURLs.unregisterRT);_.each(registerInfo.instruments,function(instrument){topic=self.getTopic("D",instrument);self.off(topic,registerInfo.callback,registerInfo.context)})},registerPos:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.registerPos;var topic;var params={sesion:escape(this.session),wnd:registerInfo.wnd,mv:registerInfo.mv,header:registerInfo.descriptors.join(),initload:registerInfo.initload||0};this.postRequestNoAuth(url,params,this.serviceURLs.registerPos);topic=self.getTopic("P",registerInfo.mv);self.on(topic,registerInfo.callback,registerInfo.context)},unregisterPos:function(unregisterInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.unregisterPos;var topic;var params={sesion:escape(this.session),wnd:unregisterInfo.wnd,mv:unregisterInfo.mv,header:unregisterInfo.descriptors.join()};this.postRequestNoAuth(url,params,this.serviceURLs.unregisterPos);topic=self.getTopic("P",unregisterInfo.mv);self.off(topic,unregisterInfo.callback)},registerNot:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.registerNot;var topic;var params={sesion:escape(this.session),wnd:registerInfo.wnd,lf:registerInfo.sources};this.postRequestNoAuth(url,params,this.serviceURLs.registerNot);_.each(registerInfo.sources.split(","),function(source){topic=self.getTopic("N",source);self.on(topic,registerInfo.callback,registerInfo.context)})},unregisterNot:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.unregisterNot;var topic;var params={sesion:escape(this.session),wnd:registerInfo.wnd,lf:registerInfo.sources};this.postRequestNoAuth(url,params,this.serviceURLs.unregisterNot);_.each(registerInfo.sources.split(","),function(source){topic=self.getTopic("N",source);self.off(topic,registerInfo.callback,registerInfo.context)})},unregisterAll:function(){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.unregisterAllRT;var topic;var params={sesion:escape(this.session)};this.postRequestNoAuth(url,params,this.serviceURLs.unregisterAllRT)},getTopic:function(subscriptionType,target){if(target){var trimTarget=target.replace(/^\s+|\s+$/g,"");return subscriptionType+":"+trimTarget.replace(" ","_")}return""},updateData:function(data,frame){this.messages++;if(this.messages>=this.maxMessages){this.changeFrame();this.messages=0}this.dataTrigger(data)},dataTrigger:function(data){if(data.type==="NT"){this.trigger(this.getTopic("N",data.Fuente),data.Noticia)}else{switch(data.T){case this.ifbTables.Positions:this.trigger(this.getTopic("P",data.MV),data);if(data.C==="1"){this.trigger(this.getTopic("D",data.MV),data)}break;default:this.trigger(this.getTopic("D",data.MV),data);break}}},changeFrame:function(){this.actualFrame=this.actualFrame===1?2:1;var url=this.getStreamingBaseUrl()+"/"+this.serviceURLs.setConnection+"?sesion="+escape(this.session)+"&amortiguacion="+this.netting+"&formatType="+this.formatTypeJson+"&idconnection="+this.actualFrame+"&timestamp="+(new Date).getTime();$("#iframe_conexion"+this.actualFrame).attr("src",url)},alertComplete:function(id,info){IFB.Utils.INGHelper.onAlertComplete(id,info)},addPostMessageListener:function(){if(window.addEventListener){addEventListener("message",this.onPostMessage,false)}else{attachEvent("onmessage",this.onPostMessage)}},activityCheckWT:function(){if(this.streamingEnabled){if(this.isAlive){this.isAlive=false}else{if(!this.isLogout){console.log("Streaming desconectado ");this.reconnecting=true;this.changeFrame()}}setTimeout(activityCheckWT,this.TIMERHEARTBEAT*2.3)}},onPostMessage:function(event){var self=IFB.Services.Streaming.CONNECTION;if(event.data.indexOf("type")===-1){return}var response=JSON.parse(event.data);this.isAlive=true;switch(response.type){case"ChangeGMT":ChangeGMT_F();break;case"Connected":Connected_F();break;case"HB":HB_F();break;case"NT":callback(response,self.actualFrame);break;case"LOGOUT":LOGOUT_F();break;case"RT":callback(response,self.actualFrame);break;case"IL":callback(response,self.actualFrame);break;case"Notification":Notificacion_F();break;case"END":END_F();break}}});function HB_F(){IFB.Services.Streaming.CONNECTION.isAlive=true}function ChangeGMT_F(){}function Connected_F(){IFB.Services.StreamingCallbacks.connected()}function END_F(){}function Notify_F(){}function Notificacion_F(){}function LOGOUT_F(){console.log("LOGOUT_F");IFB.Services.StreamingCallbacks.logout();this.isLogout=true}function cargaInicial(data,frame){IFB.Services.Streaming.CONNECTION.isAlive=true;IFB.Services.StreamingCallbacks.realTime(data,frame)}function callback(data,frame){IFB.Services.Streaming.CONNECTION.isAlive=true;IFB.Services.StreamingCallbacks.realTime(data,frame)}function Alerta_F(id,info){IFB.Services.StreamingCallbacks.alert(id,info)}function activityCheckWT(data,frame){IFB.Services.Streaming.CONNECTION.activityCheckWT(data,frame)}(function(){var callbacks={alert:function(id,info){IFB.Services.Streaming.CONNECTION.alertComplete(id,info)},connected:function(){IFB.Services.Streaming.CONNECTION.connect()},logout:function(){},realTime:function(data,frame){IFB.Services.Streaming.CONNECTION.updateData(data,frame)}};IFB.Services.StreamingCallbacks=callbacks})();IFB.Services.Trading=IFB.Class(IFB.Services.Base,{streamingBaseURL:undefined,options:{},callbackConnected:undefined,firstConnection:true,connected:false,actualFrame:1,messages:0,mapValues:undefined,maxMessages:undefined,serverLinkOrders:"ORDENES",serverLinkRisks:"CARTERAS",isAlive:false,isLogout:false,TIMERHEARTBEAT:15e3,reconnecting:false,notificationReconnectingExists:false,INFORMATION_TYPE_ORDERS:"ORDENES",INFORMATION_TYPE_PORTFOLIO:"CARTERAS",INFORMATION_TYPE_PORTFOLIO_CASH:"CARTERASCONTADO",INFORMATION_TYPE_PORTFOLIO_INTRADAY:"CARTERASINTRADIA",INFORMATION_TYPE_ACCOUNTS:"CUENTAS",INFORMATION_TYPE_BALANCE:"SALDOS",INFORMATION_TYPE_TRANSACTIONS:"MOVIMIENTOS",serviceURLs:{openConection:"OpenConnection",modifyOrder:"ModifyOrderJSON",newOrder:"NewOrderJSON",cancelOrders:"CancelOrderJSON",getOrderBook:"GetOrderBookJSON",getEvents:"GetEventsJSON",getOpenPosition:"GetOpenPositionJSON",getAccounts:"GetAccountsJSON",registerRT:"RegisterRT",unregisterRT:"UnregisterRT",unregisterUser:"UnregisterUserJSON",initCall:"Init",getErrors:"GetErrors",getCommission:"GetCommissionJSON",getBalance:"DameSaldos"},initialize:function(options){_.extend(this,Backbone.Events);this.options=options||{};this.serverLinkOrders=this.options.serverLinkOrders;this.serverLinkRisks=this.options.serverLinkRisks;IFB.Services.Trading.parent.initialize.call(this,options);this.streamingBaseURL=options.streamingBaseURL;this.servicename="trader";_.once(this.setDomainName());this.initConfig()},startStreaming:function(callbackConnected,contextCallback){this.callbackConnected=callbackConnected;this.contextCallback=contextCallback;if(this.isEnabled()){this.createFrames()}},activityCheck:function(){if(this.isAlive){this.isAlive=false}else{if(!this.isLogout){this.reconnecting=true;console.log("Web Trader desconectado ");this.showNotificationReconnecting();this.changeFrame()}}setTimeout(activityCheckTrader,this.TIMERHEARTBEAT*2.3)},isEnabled:function(){return true},initConfig:function(){this.maxMessages=this.options.maxMessages||5e3},setDomainName:function(){if(IFB.Services.Domain){document.domain=IFB.Services.Domain}},closeNotificationReconnecting:function(){if(this.notificationReconnectingExists){IFB.Utils.Helper.closeNotification();this.notificationReconnectingExists=false}},showNotificationReconnecting:function(callbackInitSession){if(this.reconnecting&&!this.notificationReconnectingExists){IFB.Utils.Helper.showNotificationReconnecting();this.notificationReconnectingExists=true}},createFrames:function(){var url=this.streamingBaseURL+"/"+this.serviceURLs.openConection+"?sesion="+escape(this.session);this.createFrame({name:"iframe_trader_conexion1",id:"iframe_trader_conexion1",src:url+"&idconnection=1&timestamp="+(new Date).getTime()+"&timehb="+this.TIMERHEARTBEAT,width:0,height:0,frameborder:0});this.createFrame({name:"iframe_trader_conexion2",id:"iframe_trader_conexion2",src:this.streamingBaseURL+"/Init",width:0,height:0,frameborder:0});this.actualFrame=1;this.isAlive=true;this.activityCheck()},createFrame:function(config){$('<iframe style="display:none" id="'+config.id+'" name="'+config.name+'" src="'+config.src+'" width="'+config.width+'" height="'+config.height+'" frameborder="'+config.frameborder+'" />').appendTo("body")},connect:function(){this.connected=true;if(this.firstConnection){this.firstConnection=false}this.closeNotificationReconnecting();if(this.callbackConnected&&"function"===typeof this.callbackConnected){this.callbackConnected(this.contextCallback)}},getServerLink:function(type){return type===this.INFORMATION_TYPE_ORDERS?this.serverLinkOrders:this.serverLinkRisks},registerRT:function(registerInfo){if(!this.isEnabled()){return}var self=this;var url=this.baseURL+"/"+this.serviceURLs.registerRT;var topic;var params={SessionID:escape(this.session),TraderLink:this.getServerLink(registerInfo.informationType),Accounts:registerInfo.accounts,Type:registerInfo.informationType,Descriptors:registerInfo.descriptors.join(","),timestamp:(new Date).getTime()};this.jsonParamsPost(url,params,this.serviceURLs.registerRT);this.registerEvents(registerInfo)},registerEvents:function(registerInfo){var self=this;var arrAccounts=registerInfo.accounts.split(",");_.each(arrAccounts,function(account){topic=self.getTopic(registerInfo.informationType,account);self.on(topic,registerInfo.callback,registerInfo.context)})},unregisterEvents:function(unregisterInfo){var self=this;var arrAccounts=unregisterInfo.accounts.split(",");_.each(arrAccounts,function(account){topic=self.getTopic(unregisterInfo.informationType,account);self.off(topic,unregisterInfo.callback,unregisterInfo.context)})},unregisterRT:function(unregisterInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.unregisterRT;var topic;var params={SessionID:escape(this.session),TraderLink:this.getServerLink(unregisterInfo.informationType),Accounts:unregisterInfo.accounts,Type:unregisterInfo.informationType,timestamp:(new Date).getTime()};this.jsonParamsPost(url,params,this.serviceURLs.unregisterRT);this.unregisterEvents(unregisterInfo)},unregisterUser:function(){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.unregisterUser;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkOrders};this.jsonParamsPost(url,params,this.serviceURLs.unregisterUser)},getErrors:function(errorsInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getErrors;var topic;var params={SessionID:escape(this.session)};if(errorsInfo.language){params.Language=errorsInfo.language}if(errorsInfo.provider){params.Provider=errorsInfo.provider}if(errorsInfo.traderlink){params.TraderLink=errorsInfo.traderlink}if(errorsInfo.fields){params.Fields=errorsInfo.fields}this.jsonParamsPost(url,params,this.serviceURLs.getErrors,errorsInfo.callback,errorsInfo.context,errorsInfo.callbackParams)},getOrderBook:function(orderBookInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getOrderBook;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Accounts:orderBookInfo.accounts,History:orderBookInfo.history,Descriptors:orderBookInfo.descriptors.join()};this.jsonParamsPost(url,params,this.serviceURLs.getOrderBook,orderBookInfo.callback,orderBookInfo.context,orderBookInfo.callbackParams)},getEvents:function(eventInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getEvents;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,OrderID:eventInfo.orderID,History:eventInfo.history,Descriptors:eventInfo.descriptors.join(),Account:eventInfo.account};this.jsonParamsPost(url,params,this.serviceURLs.getEvents)},initCall:function(params,context){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.initCall;this.getRequest(url,{},this.serviceURLs.initCall,params.callback,context,params.callbackParams)},getAccounts:function(accountsInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getAccount;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkRisks,Accounts:accountsInfo.accounts,Descriptors:accountsInfo.descriptors.join()};this.jsonParamsPost(url,params,this.serviceURLs.getAccount)},getOpenPosition:function(openPositionInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getOpenPosition;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkRisks,Accounts:openPositionInfo.accounts,Descriptors:openPositionInfo.descriptors.join(),_dc:(new Date).getTime()};this.jsonParamsPost(url,params,this.serviceURLs.getOpenPosition)},newOrder:function(params,context){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.newOrder;var parameters={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Order:params.Order};this.jsonParamsPost(url,parameters,this.serviceURLs.newOrder,params.callback,context,params.callbackParams)},getCommission:function(params,context){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getCommission;var parameters={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Order:params.Order};this.jsonParamsPost(url,parameters,this.serviceURLs.getCommission,params.callback,context,params.callbackParams)},getBalance:function(accounts,descriptors,interestedObject,successEventName,errorEventName){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.getBalance;var parameters={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Accounts:openPositionInfo.accounts,Descriptors:openPositionInfo.descriptors.join()};this.jsonParamsPost(url,parameters,this.serviceURLs.getCommission,params.callback,context,params.callbackParams)},modifyOrder:function(orderInfo){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.modifyOrder;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Order:orderInfo.order};this.jsonParamsPost(url,params,this.serviceURLs.modifyOrder)},cancelOrders:function(orderInfo,context){if(!this.isEnabled()){return}var url=this.baseURL+"/"+this.serviceURLs.cancelOrders;var topic;var params={SessionID:escape(this.session),TraderLink:this.serverLinkOrders,Orders:orderInfo.orders};this.jsonParamsPost(url,params,this.serviceURLs.cancelOrders,orderInfo.callback,context,orderInfo.callbackParams)},getTopic:function(subscriptionType,target){var trimTarget=target.replace(/^\s+|\s+$/g,"");return subscriptionType+":"+trimTarget.replace(" ","_")},updateData:function(data,frame){this.messages++;this.isAlive=true;if(this.messages>=this.maxMessages){this.changeFrame();this.messages=0}switch(data.type){case"HB":this.webTraderHB();break;case"ORDEN":this.notificacionOrdenTR(data.data);break;case"ORDENRECHAZADA":this.notificationOrderReject(data.data);break;case"CUENTA":this.notificacionCuentaTR(data.data);break;case"CARTERA":this.notificacionCarteraTR(data.data,IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO);break;case"CARTERA_CONTADO":this.notificacionCarteraTR(data.data,IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO_CASH);break;case"CARTERA_INTRADIA":this.notificacionCarteraTR(data.data,IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO_INTRADAY);break;case"LOGOUT":this.webTraderLogout();break;case"CONNECTED":this.webTraderConnected();break;case"DISCONNECTED":this.webTraderDesconnected();break}},changeFrame:function(){if(!IFB.Services.Streaming.CONNECTION.isLogout){this.actualFrame=this.actualFrame===1?2:1;var url=this.streamingBaseURL+"/"+this.serviceURLs.openConection+"?sesion="+escape(this.session)+"&idconnection="+this.actualFrame+"&timestamp="+(new Date).getTime()+"&timehb="+this.TIMERHEARTBEAT;$("#iframe_trader_conexion"+this.actualFrame).attr("src",url)}},subscribe:function(event,callback,context){this.on(event,callback,context)},unsubscribe:function(event){this.off(event)},webTraderLogout:function(){console.log("LogOut de Web Trader");this.isLogout=true},webTraderDesconnected:function(){console.log("Desconectado de Web Trader")},webTraderConnected:function(){if(this.reconnecting){this.reconnecting=false;this.trigger("WebTrader_Reconnected",this);this.connect()}else{if(this.firstConnection){this.firstConnection=false;this.connect()}}console.log("Conectado a WebTrader");this.messages=0},webTraderHB:function(){},getOrderAccount:function(order){return order[IFB.Descriptors.Trader.AccountFIX.descriptor]},getAccountAccount:function(order){return order[IFB.Descriptors.Trader.Cuentas.Account.descriptor]},getPortfolioAccount:function(order){return order[IFB.Descriptors.Trader.PortfolioAccount.descriptor]},getKeyFromResponse:function(streamingType,response){var keyFromResponse="";switch(streamingType){case IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ORDERS:keyFromResponse=response[IFB.Descriptors.Trader.Key.descriptor];break;case IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_ACCOUNTS:keyFromResponse=response[IFB.Descriptors.Trader.Cuentas.Account.descriptor];break;case IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO:case IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO_INTRADAY:case IFB.Services.Trading.CONNECTION.INFORMATION_TYPE_PORTFOLIO_CASH:keyFromResponse=response[IFB.Descriptors.Trader.PortfolioKey.descriptor]+response[IFB.Descriptors.Trader.PortfolioShortName.descriptor];break}return keyFromResponse},notificacionOrdenTR:function(data){var self=this;if(data.status.ok){_.each(data.answer,function(order){var account=self.getOrderAccount(order);var key=self.getKeyFromResponse(self.INFORMATION_TYPE_ORDERS,order);var topic=self.getTopic(self.INFORMATION_TYPE_ORDERS,account);self.trigger(topic,order,key)})}},notificacionCarteraTR:function(data,type){var self=this;if(data.status.ok){_.each(data.answer,function(portfolio){var account=self.getPortfolioAccount(portfolio);var key=self.getKeyFromResponse(type,portfolio);var topic=self.getTopic(type,account);self.trigger(topic,portfolio,key)})}},notificacionCuentaTR:function(data){var self=this;if(data.status.ok){_.each(data.answer,function(accountresponse){var account=self.getAccountAccount(accountresponse);var key=self.getKeyFromResponse(self.INFORMATION_TYPE_ACCOUNTS,accountresponse);var topic=self.getTopic(self.INFORMATION_TYPE_ACCOUNTS,account);self.trigger(topic,accountresponse,key)})}},notificationOrderReject:function(data){var rejectReason=data.answer[0][IFB.Descriptors.Trader.RejectReason.descriptor];var buttons=[{text:"Aceptar"}];IFB.Utils.Helper.showNotification("information","orden rechazada.<br/><b><a>"+rejectReason+"</a>",true,buttons)}});function webTraderTiempoReal(data,frame){IFB.Services.Trading.CONNECTION.updateData(data,frame)}function activityCheckTrader(data,frame){IFB.Services.Trading.CONNECTION.activityCheck(data,frame)}IFB.Services.WebSocket=IFB.Class(IFB.Services.Base,{options:{},initialize:function(options){this.options=options||{};IFB.Services.WebSocket.parent.initialize.call(this,options);this.servicename="websocket";this.initConfig()},initConfig:function(){this.enabled=typeof io!=="undefined"},connect:function(callback){if(!this.enabled){this.done(callback);return}var self=this;this.socket=io.connect();this.socket.on("connect",function(client){self.socket.emit("adduser",SOCKET_IO_ADDUSER||{anonymous:true});self.connected=true;self.done(callback)});this.socket.on("data",function(message){IFB.Services.Streaming.CONNECTION.updateData(message)})},done:function(callback){if(callback&&typeof callback==="function"){callback(this)}},register:function(registerInfo){if(!this.enabled){return}var self=this;this.socket.emit("register",{instruments:registerInfo.instruments.join(","),descriptors:registerInfo.descriptors.join(",")});_.each(registerInfo.instruments,function(instrument){var topic=self.getTopic("D",instrument);amplify.subscribe(topic,registerInfo.context,registerInfo.callback)})},registerPos:function(registerInfo){if(!this.enabled){return}var self=this;this.socket.emit("registerPos",{instruments:registerInfo.instruments.join(","),descriptors:registerInfo.descriptors.join(",")});_.each(registerInfo.instruments,function(instrument){var topic=self.getTopic("D",instrument);amplify.subscribe(topic,registerInfo.context,registerInfo.callback)})},unregister:function(registerInfo){if(!this.enabled){return}var self=this;this.socket.emit("unregister",{instruments:registerInfo.instruments.join(","),descriptors:registerInfo.descriptors.join(",")});_.each(registerInfo.instruments,function(instrument){var topic=self.getTopic("D",instrument);amplify.unsubscribe(topic,registerInfo.callback)})},unregisterPos:function(registerInfo){if(!this.enabled){return}var self=this;this.socket.emit("unregisterPos",{instruments:registerInfo.instruments.join(","),descriptors:registerInfo.descriptors.join(",")});_.each(registerInfo.instruments,function(instrument){var topic=self.getTopic("D",instrument);amplify.unsubscribe(topic,registerInfo.callback)})},getTopic:function(subscriptionType,target){var trimTarget=target.replace(/^\s+|\s+$/g,"");return subscriptionType+":"+trimTarget.replace(" ","_")},updateData:function(data,frame){amplify.publish(this.getTopic("D",data.MV),data)}});IFB.Views.Accounts=IFB.Views.TraderBase.extend({initialize:function(){IFB.Views.TraderBase.prototype.initialize.apply(this,arguments)},onAccountChange:function(param1,param2){var self=this;var newAccount=param2.val();var account=self.model.getElementById(newAccount);var newCashText="-";self.model.setSelected(account);if(account){newCashText=account.getCashAvailable(2)}$("#cash").text(newCashText)},onUpdateDataTrader:function(response,key){if(!this.model){return}var self=this;var elementModel=this.model?this.model.getElementById(key):undefined;var keyDOM;var elements;if(elementModel){_.each(response,function(value,descriptor){if(elementModel===self.model.accountSelected){keyDOM='[data-descriptor="'+descriptor+'"]';if(!self.domElementsMap[keyDOM]){self.domElementsMap[keyDOM]=$(keyDOM,self.$el)}elements=self.domElementsMap[keyDOM];if(elements.length>0){self.updateTraderDOM(elementModel,elements,value,[])}}elementModel.setDescriptorValue(descriptor,value)})}else{this.model.add(response)}}});IFB.Views.AlertList=IFB.Views.Base.extend({selectedRowId:undefined,initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeScroll);if(this.options.enableSort){if(this.options.sortConfig){this.sortConfig=_.defaults({},this.options.sortConfig,this.defaultSortConfig)}else{this.sortConfig=_.defaults({},this.defaultSortConfig)}this.subscribe("rendered",this.addSortCss,this)}},heightScroll:200,defaultSortConfig:{type:"string",direction:"asc",descriptor:IFB.Descriptors.ShortName.descriptor,css:{arrow:"sortArrow",asc:"activeDown",desc:"activeUp"}},events:function(){return _.extend({},IFB.Views.Base.prototype.events,{"click .x-radiobutton":"onRadioButtonCheck","click tbody>tr":"onClickTr"})},reload:function(){this.sortConfig=_.defaults({},this.defaultSortConfig);IFB.Views.Base.prototype.reload.apply(this,arguments)}});IFB.Views.ChartBase=IFB.Views.Base.extend({initialize:function(params){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.updateDefaults(params)},updateDefaults:function(params){this.title=params.title||"";this.name=params.name||this._getMV();this.width=params.width;this.height=params.height;this.decimals=params.decimals||2;this.decimalsYAxis=params.decimalsYAxis||this.decimals;this.colors=params.colors||["#666666","#93C371","#cc3333"];this.trendClassnames=params.trendClassnames||["ifb-equal","ifb-top","ifb-flop"];this.trend=params.trend||0;this.closeLineHeight=params.closeLineHeight||3;this.lineWidth=params.lineWidth||3;this.tooltipCrosshairsColor=params.tooltipCrosshairsColor||"";this.closeLineColor=params.closeLineColor||"#999999";this.colorLabelXAxis=params.colorLabelXAxis||Highcharts.getOptions().xAxis.labels.style.color;this.colorLineXAxis=params.colorLineXAxis||Highcharts.getOptions().xAxis.lineColor;this.colorTickXAxis=params.colorTickXAxis||Highcharts.getOptions().xAxis.tickColor;this.colorLabelYAxis=params.colorLabelYAxis||Highcharts.getOptions().yAxis.labels.style.color;this.colorLineYAxis=params.colorLineYAxis||Highcharts.getOptions().yAxis.lineColor;this.colorTickYAxis=params.colorTickYAxis||Highcharts.getOptions().yAxis.tickColor;this.colorGridLineYAxis=params.colorGridLineYAxis||Highcharts.getOptions().yAxis.gridLineColor;this.tooltipEnabled=_.isUndefined(params.tooltipEnabled)?true:params.tooltipEnabled;this.pinchType=params.pinchType||null;this.followTouchMove=params.followTouchMove||false;this.typeChart=params.typeChart||"line"},setModel:function(baseURL){return new IFB.Collections.ChartIntraday(baseURL||"")},register:function(){this.lastRegisterCall={descriptors:(this.model.options.serviceParams.data.descriptors||"").split(","),instruments:[this.model.options.serviceParams.data.mv]};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.register({wnd:this.cid,instruments:this.lastRegisterCall.instruments,descriptors:this.lastRegisterCall.descriptors,context:this,initload:1,callback:this.onUpdateData})}},onUpdateData:function(data){throw new Error("This method must be overrided")},getDecimals:function(){return this.decimals},getColor:function(){var color;if(!this.isOHLCStyleType()){color=_.isArray(this.colors)&&this.colors.length===1?this.colors[0]:this.colors[this.trend]}return color},getTrendClassname:function(){return this.trendClassnames[this.trend]},changeDataMvParam:function(){var self=this;return function(data,params){self.updateDefaults(params);self.model.options.serviceParams.data.mv=data;self.model.load()}},getXAxisLabelsStyle:function(){return{fontFamily:"Verdana",fontSize:"12px",color:this.colorLabelXAxis}},getYAxisLabelsStyle:function(){return{fontFamily:"Verdana",fontSize:"12px",color:this.colorLabelYAxis}},_getMV:function(){try{return this.model.options.serviceParams.data.mv}catch(e){return""}return""},redraw:function(){this.chart.yAxis[0].setExtremes(this.chart.series[0].dataMin,this.chart.series[0].dataMax);this.chart.redraw()},getHighchartPoints:function(){var self=this;var data=[];_.each(this.model.models,function(point){data.push(self.getHighchartPoint(self.model.date,point))});var lastPricePoint=this.getLastPricePoint(data);if(lastPricePoint){data.push(lastPricePoint)}return data},getLastPricePoint:function(data){var self=this;if(this.options.showLastPrice){var lastDailyPoint=data[data.length-1];var lastPricePoint={data:{F13:this.instrument.data.D60,F6:this.instrument.data.D420,F7:this.instrument.data.D420,F8:this.instrument.data.D420,F4:this.instrument.data.D420}};var highchartLastPricePoint=self.getHighchartPoint(this.instrument.data.D60,lastPricePoint);if(highchartLastPricePoint[0]>lastDailyPoint[0]){return highchartLastPricePoint}}return},getHighchartPoint:function(){throw new Error("This method must be overrided")},setExtremes:function(){try{if(this.typeChart===IFB.Constants.Highcharts.ChartTypes.area||this.typeChart===IFB.Constants.Highcharts.ChartTypes.column){this.chart.yAxis[0].setExtremes(this.chart.series[0].dataMin,this.chart.series[0].dataMax)}}catch(e){}},isOHLCStyleType:function(){return this.typeChart===IFB.Constants.Highcharts.ChartTypes.candlestick||this.typeChart===IFB.Constants.Highcharts.ChartTypes.ohlc},getObjectSerie:function(name,points,lineWidth){var self=this;return{name:name,data:points,marker:{enabled:false,states:{hover:{enabled:true,radius:5}}},color:self.getColor(),lineWidth:lineWidth}},getNavigatorOptions:function(){return this.options.navigator||{enabled:false}},changeSerieColor:function(color){this.chart.series[0].update({color:color||this.getColor()})},getPointValue:function(timeStamp){var points=this.chart.series[0].points;var i;var value;value=_.find(points,function(point){return point.x>=timeStamp});return value?value.y:undefined},updateRangeTrend:function(min,max){this.trend=min<max?1:min===max?0:2},onSetExtremes:function(e){if(this.isOHLCStyleType()){return}var points=this.chart.series[0].points;var min=e?this.getPointValue(e.min)||points[0].y:points[0].y;var max=e?this.getPointValue(e.max)||points[points.length-1].y:points[points.length-1].y;this.updateRangeTrend(min,max);this.changeSerieColor()},getXAxisEvents:function(){var self=this;return this.options.lineColorByPeriod?{setExtremes:_.throttle(function(e){self.onSetExtremes(e)},500)}:{}}});IFB.Views.ChartColumnInstrumentList=IFB.Views.Base.extend({chart:undefined,mvs:undefined,categories:undefined,pointCoordYZero:1e-4,coordYZeroPoint:.005,zero:0,dateFormat:"",timeFormat:"",topColor:"",flopColor:"",equalColor:"",chartDescriptor:"",chartDescriptorSuffix:"",initialize:function(params){this.categories=[];this.mvs=[];IFB.Views.Base.prototype.initialize.apply(this,arguments);this.updateDefaults(params)},updateDefaults:function(params){if(params){this.dateFormat=params.dateFormat||"HH:mm";this.timeFormat=params.timeFormat||"DD/MM";this.topColor=params.topColor||"";this.flopColor=params.flopColor||"";this.equalColor=params.equalColor||"";this.chartDescriptor=params.chartDescriptor||"";this.chartDescriptorSuffix=params.chartDescriptorSuffix||""}},getInitialOptionsChart:function(categories){var self=this;return{chart:{type:"columnrange",renderTo:self.el},title:{text:""},xAxis:{categories:categories,labels:{enabled:true,useHTML:true,formatter:function(){return"<span>"+this.value+"</span>"}}},yAxis:{title:{text:""},labels:{enabled:false}},tooltip:{enabled:false},plotOptions:{columnrange:{dataLabels:{enabled:true,useHTML:true,formatter:function(){return self.getDataLabel(this)}}}},legend:{enabled:false},series:[]}},getDataLabel:function(params){var instrument=this.model.get(params.point.mv),label="";if(instrument){if(params.y===-this.coordYZeroPoint){label=this.getDateOrTimeLabel(instrument)}else if(params.y===this.coordYZeroPoint){label=this.getChartDescriptorLabel(instrument)}else if(params.y===this.pointCoordYZero){label=this.getDateOrTimeLabel(instrument)}else if(params.y===-this.pointCoordYZero){label=this.getDateOrTimeLabel(instrument)}else{label=this.getChartDescriptorLabel(instrument)}}return"<span>"+label+"</span>"},getDateOrTimeLabel:function(instrument){var dateOrTime=instrument.getDescriptorValue(IFB.Descriptors.DateOrTimeSituationMessage.descriptor);return dateOrTime?instrument.formatValueAsDateOrTime(dateOrTime,this.dateFormat,this.timeFormat):""},getChartDescriptorLabel:function(instrument){var options=_.defaults(instrument.options||{},{decimals:2});try{return instrument.formatValueAsNumber(instrument.getDescriptorValue(this.chartDescriptor),options.decimals,options.zeroValue,options.positiveSign,this.chartDescriptorSuffix)}catch(e){}},getHighchartPoints:function(){var self=this,instrumentList=this.model.models,points=[],chartDescriptorValue="",trend="";_.each(instrumentList,function(instrument,index){if(instrument){chartDescriptorValue=instrument.getDescriptorValue(self.chartDescriptor);trend=instrument.getDescriptorValue(IFB.Descriptors.Trend.descriptor);if(chartDescriptorValue!==""){self.mvs.push(instrument.id);self.categories.push(instrument.getIFBShortName());points.push(self.getHighchartPoint(instrument.id,index,Number(chartDescriptorValue),trend))}}});return points},getHighchartPoint:function(mv,index,yValue,trend){var point={x:index,mv:mv};if(trend==="1"){point.low=this.pointCoordYZero;point.high=yValue;point.color=this.topColor}else if(trend==="2"){point.low=yValue;point.high=-this.pointCoordYZero;point.color=this.flopColor}else{point.low=-this.coordYZeroPoint;point.high=this.coordYZeroPoint;point.color=this.equalColor}return point},getObjectSerie:function(points){return{colorByPoint:true,data:points}},render:function(){var self=this,points=this.getHighchartPoints();if(this.chart!==undefined){this.chart.destroy()}this.chart=new Highcharts.Chart(this.getInitialOptionsChart(this.categories));this.chart.addSeries(this.getObjectSerie(points));self.publish("rendered",self.id);return self},onUpdateData:function(data){var index,point,instrument,serie=this.chart.series&&this.chart.series.length>0?this.chart.series[0]:undefined;if(data&&data.MV){index=_.indexOf(this.mvs,data.MV);if(index!==-1&&serie){point=serie.data[index];instrument=this.model.get(data.MV);if(point&&instrument){this.updateModel(instrument,data,index);pointUpdated=this.getHighchartPoint(data.MV,index,Number(instrument.getDescriptorValue(this.chartDescriptor)),instrument.getDescriptorValue(IFB.Descriptors.Trend.descriptor));this.updateSerie(serie,index,pointUpdated)}}}},updateModel:function(instrument,data,index){if(data.V){_.each(data.V,function(descriptorUpdate){instrument.setDescriptorValue(descriptorUpdate.D,descriptorUpdate.V)});this.model.models[index]=instrument}},updateSerie:function(serie,index,point){if(serie&&point&&index){serie.data[index].update({low:point.low,high:point.high,color:point.color},true)}}});IFB.Views.ChartDaily=IFB.Views.ChartBase.extend({getHighchartPoint:function(date,rawPoint){var point={};var dateMoment=moment(rawPoint.data.F13+"000000+0000","YYYYMMDDHHmmssZ").valueOf();point.x=dateMoment.valueOf();point.y=Number(rawPoint.data.F4);point.open=Number(rawPoint.data.F6);point.high=Number(rawPoint.data.F7);point.low=Number(rawPoint.data.F8);point.close=Number(rawPoint.data.F4);return point},formatYLabel:function(value){return accounting.formatNumber(value,this.decimalsYAxis)},tooltipFormatter:function(){return IFB.Utils.Helper.chartDailyTooltipFormatter(this)},getXAxisConfiguration:function(){var xAxisLabelsStyle=this.getXAxisLabelsStyle();return{type:"datetime",tickPixelInterval:150,lineColor:self.colorLineXAxis,tickColor:self.colorTickXAxis,labels:{style:xAxisLabelsStyle,y:20}}},getInitialOptionsChart:function(){var self=this;var points=this.getHighchartPoints();var labelItems=[];if(!points.length){var width=this.$el.width();labelItems.push({html:"No hay información en las fechas seleccionadas",style:{top:(self.height-25)/2,left:(width-250)/2}})}return{chart:{renderTo:self.el,type:self.typeChart,height:self.height,width:self.width,backgroundColor:"rgba(255, 255, 255, 0.1)",pinchType:self.pinchType},title:{text:this.title,floating:true},xAxis:{type:"datetime",lineColor:self.colorLineXAxis,tickColor:self.colorTickXAxis,labels:{style:this.getXAxisLabelsStyle(),y:20},events:self.getXAxisEvents()},yAxis:{opposite:false,title:{text:""},gridLineWidth:.2,gridLineDashStyle:"Dot",gridLineColor:self.colorGridLineYAxis,lineColor:self.colorLineYAxis,tickColor:self.colorTickYAxis,lineWidth:1,labels:{formatter:function(){return self.formatYLabel(this.value)},style:this.getYAxisLabelsStyle()}},rangeSelector:{enabled:false},navigator:self.getNavigatorOptions(),scrollbar:{enabled:false},tooltip:{enabled:self.tooltipEnabled,useHTML:true,followPointer:false,borderColor:"auto",borderWidth:0,crosshairs:{color:self.tooltipCrosshairsColor,dashStyle:"solid"},shared:true,borderRadius:0,shadow:false,backgroundColor:"rgba(255, 255, 255, 0.1)",formatter:this.tooltipFormatter(),style:{padding:"0px"},followTouchMove:self.followTouchMove},legend:{enabled:false},labels:{items:labelItems},series:[self.getObjectSerie(self.name,points,self.lineWidth)]}},render:function(){var chartConfig=this.getInitialOptionsChart();if(this.chart!==undefined){this.chart.destroy()}this.chart=Highcharts&&Highcharts.StockChart?new Highcharts.StockChart(chartConfig):new Highcharts.Chart(chartConfig);this.setExtremes();this.publish("rendered",this.id);if(this.options.lineColorByPeriod){this.onSetExtremes()}return this},onUpdateData:function(updateRawData){return}});IFB.Views.ChartIntraday=IFB.Views.ChartBase.extend({getHighchartPoint:function(date,rawPoint){var point={};var dateMoment=moment(date+rawPoint.data.F4+"+0000","YYYYMMDDHHmmssZ").add("minutes",IFB.Settings.GmtOffset);point.x=dateMoment.valueOf();point.y=Number(rawPoint.data.F8);point.open=Number(rawPoint.data.F5);point.high=Number(rawPoint.data.F7);point.low=Number(rawPoint.data.F6);point.close=Number(rawPoint.data.F8);return point},destroyAndRenderChart:function(){this.render()},render:function(){var self=this;var points=this.getHighchartPoints();var chartConfig;var labelItems=[];if(!points.length){var width=this.$el.width();labelItems.push({html:"No hay información de sesión",style:{top:(self.height-25)/2,left:(width-250)/2}})}if(this.chart!==undefined){this.chart.destroy()}chartConfig=this.getInitialOptionsChart(labelItems);this.chart=Highcharts&&Highcharts.StockChart?new Highcharts.StockChart(chartConfig):new Highcharts.Chart(chartConfig);this.setExtremes();this.addCloseLine();this.chart.addSeries(this.getObjectSerie(this.name,points,this.lineWidth));self.publish("rendered",self.id);if(this.options.lineColorByPeriod){this.onSetExtremes()}return self},getInitialOptionsChart:function(labelItems){var self=this;return{chart:{renderTo:self.el,type:self.typeChart,height:self.height,width:self.width,backgroundColor:"rgba(255, 255, 255, 0.1)",pinchType:self.pinchType},title:{text:self.title,floating:true},xAxis:{type:"datetime",lineColor:self.colorLineXAxis,tickColor:self.colorTickXAxis,labels:{style:this.getXAxisLabelsStyle(),y:20},events:self.getXAxisEvents()},yAxis:{opposite:false,title:{text:""},gridLineWidth:.2,gridLineDashStyle:"Dot",lineWidth:1,gridLineColor:self.colorGridLineYAxis,lineColor:self.colorLineYAxis,tickColor:self.colorTickYAxis,labels:{formatter:function(){return accounting.formatNumber(this.value,self.decimalsYAxis)},style:this.getYAxisLabelsStyle()}},rangeSelector:{enabled:false},navigator:self.getNavigatorOptions(),scrollbar:{enabled:false},tooltip:{enabled:self.tooltipEnabled,borderColor:"auto",useHTML:true,borderWidth:0,crosshairs:{color:self.tooltipCrosshairsColor,dashStyle:"solid"},shared:true,borderRadius:0,shadow:false,backgroundColor:"rgba(255, 255, 255, 0.1)",formatter:IFB.Utils.Helper.chartIntradayTooltipFormatter(self),style:{padding:"0px"},followTouchMove:self.followTouchMove},legend:{enabled:false},labels:{items:labelItems},series:[]}},_getStreamingPoint:function(updates){var rawPoint={};rawPoint.data={};var date=this.model.date;var trend=this.trend;var self=this;_.each(updates.V,function(item){switch(item.D){case IFB.Descriptors.Date.descriptor:date=item.V;break;case IFB.Descriptors.Time.descriptor:rawPoint.data.F4=self._getRoundTime(item.V);break;case IFB.Descriptors.Last.descriptor:rawPoint.data.F8=item.V;break;case IFB.Descriptors.Volume.descriptor:rawPoint.data.F9=item.V;break;case IFB.Descriptors.Trend.descriptor:trend=item.V;break}});rawPoint.data.date=date;rawPoint.data.trend=trend;return rawPoint},_getRoundTime:function(time){var timeMoment=moment(time,"HHmmss");var result=timeMoment.format("HHmm");if(timeMoment){if(timeMoment.second()>0){result=timeMoment.add("minutes",1).format("HHmm")}}return result},_getStreamingModel:function(updateRawData,lastModel){var result=this._getStreamingPoint(updateRawData);result.data.F4=result.data.F4||lastModel.data.F4;result.data.F8=result.data.F8||lastModel.data.F8;return result},isModFrequency:function(itemModel){if(!itemModel){return}var frequency=this.model.getFrequency();return itemModel.data.F4%frequency===0?true:false},onUpdateData:function(updateRawData){var serie=this.chart.series&&this.chart.series.length>0?this.chart.series[0]:undefined;var lastModel;var streamingModel;if(serie&&this._getMV()===updateRawData.MV){lastModel=this.model.getLastModel();streamingModel=this._getStreamingModel(updateRawData,lastModel);if(streamingModel.data.F4){this.trend=streamingModel.data.trend;if(this.model.date===streamingModel.data.date){if(this.isModFrequency(lastModel)){if(streamingModel.data.F4===lastModel.data.F4){this._refreshLastModelAndPoint(serie,lastModel,streamingModel)}else if(Number(streamingModel.data.F4)>Number(lastModel.data.F4)){this._insertNewModelAndPoint(serie,streamingModel)}}else if(streamingModel.data.F4===lastModel.data.F4||Number(streamingModel.data.F4)>Number(lastModel.data.F4)){this._refreshLastModelAndPoint(serie,lastModel,streamingModel)}}else{this._resetModelAndSerie(serie,streamingModel)}this.changeSerieColor()}}},_resetModelAndSerie:function(serie,newModelPoint){if(serie&&newModelPoint){this.model.remove(this.model.models);this.model.addNewModel(newModelPoint);this.model.date=newModelPoint.data.date;this._resetSerie(serie)}},_resetSerie:function(serie){var newSerie=this.getObjectSerie(this.name,this.getHighchartPoints(),this.lineWidth);if(serie&&newSerie){serie.remove();this.chart.addSeries(newSerie);this.redraw()}},_insertNewModelAndPoint:function(serie,newModelPoint){if(serie&&newModelPoint){newModelPoint=this._initializeNewModel(newModelPoint);this.model.addNewModel(newModelPoint);this._insertNewPoint(serie,newModelPoint)}},_initializeNewModel:function(newModelPoint){newModelPoint.data.F5=newModelPoint.data.F8;newModelPoint.data.F6=newModelPoint.data.F8;newModelPoint.data.F7=newModelPoint.data.F8;newModelPoint.data.F9=0;return newModelPoint},_insertNewPoint:function(serie,newModelPoint){var newPoint;if(serie&&newModelPoint){newPoint=this.getHighchartPoint(newModelPoint.data.date,newModelPoint);serie.addPoint(newPoint);this.redraw()}},_refreshLastModelAndPoint:function(serie,lastModel,streamingModel){if(serie&&lastModel&&streamingModel){streamingModel=this._refreshLastModel(lastModel,streamingModel);this.model.updateLastModel(streamingModel);this._refreshLastPoint(serie,lastModel,streamingModel)}},_refreshLastModel:function(lastModel,streamingModel){if(lastModel&&streamingModel){streamingModel.data.F5=lastModel.data.F5;streamingModel.data.F6=Number(streamingModel.data.F8)<Number(lastModel.data.F6)?streamingModel.data.F8:lastModel.data.F6;streamingModel.data.F7=Number(streamingModel.data.F8)>Number(lastModel.data.F7)?streamingModel.data.F8:lastModel.data.F7;streamingModel.data.F9=streamingModel.data.F9||lastModel.data.F9}return streamingModel},_refreshLastPoint:function(serie,lastModel,streamingModel){var streamingPoint;var position;if(serie&&lastModel&&streamingModel){streamingPoint=this.getHighchartPoint(streamingModel.data.date,streamingModel,true);if(serie.data.length>0){serie.data[serie.data.length-1].update({x:streamingPoint.x,y:streamingPoint.y,open:streamingPoint.open,high:streamingPoint.high,low:streamingPoint.low,close:streamingPoint.close});this.redraw()}}},addCloseLine:function(){if(this.options.closeLine){this.chart.yAxis[0].addPlotLine({color:this.closeLineColor,width:this.closeLineHeight,value:this.options.close})}}});IFB.Views.DonutChart=IFB.Views.Base.extend({chart:null,render:function(){var self=this;this.chart=new Highcharts.Chart({chart:self.getChartConfig(),title:self.getTitleConfig(),tooltip:self.getTooltipConfig(),plotOptions:self.getPlotOptionsConfig(),series:self.getSeriesConfig(),colors:self.getColors()});return self},getColors:function(){throw new Error("getColors: This method must be overrided")},getChartConfig:function(){throw new Error("getChartConfig: This method must be overrided")},getTitleConfig:function(){throw new Error("getTitleConfig: This method must be overrided")},getTooltipConfig:function(){throw new Error("getTooltipConfig: This method must be overrided")},getPlotOptionsConfig:function(){throw new Error("getPlotOptionsConfig: This method must be overrided")},getSeriesConfig:function(){throw new Error("getSeriesConfig: This method must be overrided")}});IFB.Views.HeaderSelector=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)}});IFB.Views.HistoricalPrices=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)}});IFB.Views.InstrumentDetail=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeScroll);this.countClick=0;if(this.options.updateButton){this.options.updateButton.updatingText=this.options.updateButton.updatingText||"Actualizando";this.options.updateButton.updateText=this.options.updateButton.updateText||"Actualizar";this.options.updateButton.disabledClass=this.options.updateButton.disabledClass||"disabled";this.options.updateButton.updatingClass=this.options.updateButton.updatingClass||"updating";this.buttonUpdateClass="";this.buttonUpdateText=this.options.updateButton.updateText}},events:{"click .updateButton":"onUpdateButton","click .addFav":"toggleFavorites"},onUpdateButton:function(e){var self=this;var el=this.$el.find(".updateButton");var maxClicks=this.options.updateButton.maxClick||Number.MAX_VALUE;if(!this.options.updateButton||this.countClick>=maxClicks||el.hasClass(this.options.updateButton.disabledClass)){return}this.moveButtonToState(el,"updating");this.countClick+=1;this.trigger("updating");this.on("loaded",function(){if(this.state==="updating"){setTimeout(function(){self.moveButtonToState(self.$el.find(".updateButton"),"disabled")},delay>1e3?1e3:0)}if(this.options.updateButton.perQuote){this.trigger("perQuoteConsumed")}});this.reload({perquote:this.options.updateButton.perQuote?1:0});var delay=this.options.updateButton.delay||0;setTimeout(function(){if(self.countClick<maxClicks){self.moveButtonToState(self.$el.find(".updateButton"),"ready")}},delay)},moveButtonToState:function(el,state){switch(state){case"updating":this.setState(el,{add:[this.options.updateButton.updatingClass]},this.options.updateButton.updatingText);break;case"disabled":this.setState(el,{remove:[this.options.updateButton.updatingClass],add:[this.options.updateButton.disabledClass]},this.options.updateButton.updateText);break;default:this.setState(el,{remove:[this.options.updateButton.updatingClass,this.options.updateButton.disabledClass]},this.options.updateButton.updateText)}this.state=state},setState:function(el,action,text){var self=this;this.buttonUpdateClass="";this.buttonUpdateText=text;if(_.isArray(action.add)){action.add.forEach(function(cls){if(!el.hasClass(cls)){el.addClass(cls)}self.buttonUpdateClass+=self.buttonUpdateClass?" "+cls:cls})}if(_.isArray(action.remove)){action.remove.forEach(function(cls){el.removeClass(cls)})}el.text(this.buttonUpdateText)},changeDataMvParam:function(){var self=this;return function(data,params){self.model.options.serviceParams.data.mv=data;self.model.load()}},toggleFavorites:function(event){var el=$(event.target);var mv=$(el).data("mv");var selectedCls="selected";if(mv){if($(el).hasClass(selectedCls)){$(el).removeClass(selectedCls);INFOBOLSA.Utils.Favorites.remove(mv)}else{$(el).addClass(selectedCls);INFOBOLSA.Utils.Favorites.add(mv)}}}});IFB.Views.InstrumentList=IFB.Views.Base.extend({selectedRowMv:undefined,initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeScroll);if(this.options.enableSort){if(this.options.sortConfig){this.sortConfig=_.defaults({},this.options.sortConfig,this.defaultSortConfig)}else{this.sortConfig=_.defaults({},this.defaultSortConfig)}this.subscribe("rendered",this.addSortCss,this)}},heightScroll:200,defaultSortConfig:{type:"string",direction:"asc",descriptor:IFB.Descriptors.ShortName.descriptor,css:{arrow:"sortArrow",asc:"activeUp",desc:"activeDown"}},events:function(){return _.extend({},IFB.Views.Base.prototype.events,{"click .x-expandable":"clickOnDetails","click .addFav":"toggleFavorites","click .x-radiobutton":"onRadioButtonCheck","click tbody>tr":"onClickTr"})},clickOnDetails:function(event){var self=this;var el=$(event.target);var tr=$(el).closest("tr");if(tr){if($(tr).hasClass("normal")){this.collapseAllInstrumentDetails($(el).closest("table"));self.expandInstrumentDetails(tr,"fast")}else{this.collapseInstrumentDetails(tr,"fast")}}},toggleClass:function(el,clsNames){if($.isArray(clsNames)){$.each(clsNames,function(index,clsName){$(el).toggleClass(clsName)})}},expandInstrumentDetails:function(tr,animate){var self=this;var el=tr.find(".x-expandable");var ticker=el.attr("data-expand-ref");var marketCod=el.attr("data-marketcod");var isin=el.attr("data-isin");var buyLink=tr.find("a.buy");this.toggleClass(tr,["normal","expand"]);this.toggleClass(el,["expand","close"]);el.addClass("active");buyLink.hide();tr.find("td").attr("style","border-bottom-width:0px");var instrument=this.model.getElementById(ticker);IFB.Utils.TemplateLoader.loadRemoteTemplate("miniInstrumentDetailsTable","/instrumentDetails/miniInstrumentDetailsTable.htm",function(template){var compiled_template=_.template(template,{model:instrument,view:self});tr.after(compiled_template);self.clearDomElementsMap();var expandibleEl=tr.next();if(expandibleEl){expandibleEl.css("style","background-color:"+tr.css("background-color"));if(self.options.component&&typeof self.options.component.showChartIntraday==="function"){var chartEl=expandibleEl.find(".ifb-FvChart");self.options.component.showChartIntraday(chartEl,ticker);self.options.component.attachTemplateClickEvents(expandibleEl)}if(!self.options.component.isInstrumentInPortfolio(marketCod,isin)){$(expandibleEl).find("a.sell").remove();$(expandibleEl).find("a.buy").addClass("only")}$("div:first-child",expandibleEl).slideDown(animate,function(){if(self.options.enableScroll&&self.options.elScroll){self.moveScrollToRow(tr,expandibleEl)}})}})},collapseInstrumentDetails:function(tr,animate){var self=this;var el=tr.find(".x-expandable");var ticker=el.attr("data-expand-ref");var buyLink=tr.find("a.buy");var expandibleEl=tr.next();var removableElements=[expandibleEl,expandibleEl.next()];function removeElement(){if(self.options.component&&typeof self.options.component.showChartIntraday==="function"){self.options.component.detachTemplateClickEvents(expandibleEl)}removableElements.forEach(function(el){el.remove()});self.clearDomElementsMap();if(self.options.enableScroll&&self.options.elScroll){self.moveScrollToRow(tr)}}if(expandibleEl){if(animate){$("div:first-child",expandibleEl).slideUp(animate,removeElement)}else{removeElement()}}this.toggleClass(tr,["normal","expand"]);this.toggleClass(el,["expand","close"]);el.removeClass("active");buyLink.show();tr.find("td").removeAttr("style")},collapseAllInstrumentDetails:function(table){var self=this;var rows=table.find("tr.expand");$.each(rows,function(index,row){var tr=$(row);self.collapseInstrumentDetails(tr)})},moveScrollToRow:function(tr,expandedTr){var scrollView=tr.closest(".scrollview");var scrollPort=tr.closest(".scrollport");var currentMarginTop=Math.abs(scrollView.css("margin-top").replace("px",""));var trPos=tr.position().top-scrollView.position().top+currentMarginTop;var trHeigth=tr.height()+(expandedTr?expandedTr.height():0);var maxOverflowY=scrollView.height()-scrollPort.height();var overflowY=Math.min(trPos+trHeigth-scrollPort.height(),maxOverflowY);if(overflowY>0){$(this.options.elScroll.selector).scrollLayout({animateToPosition:-overflowY})}else if(maxOverflowY<currentMarginTop){$(this.options.elScroll.selector).scrollLayout({animateToPosition:-maxOverflowY})}},toggleFavorites:function(event){var el=$(event.target);var mv=$(el).data("mv");var selectedCls="selected";if(mv){if($(el).hasClass(selectedCls)){$(el).removeClass(selectedCls);INFOBOLSA.Utils.Favorites.remove(mv)}else{$(el).addClass(selectedCls);INFOBOLSA.Utils.Favorites.add(mv)}}},onClickTr:function(event){if(!this.options.enableSelectedRow){return}var el=$(event.target).closest("tr");this.selectRow(el)},selectRow:function(element){if(!this.options.enableSelectedRow||$(element).lenght===0){return}var el=$(element);el.siblings().removeClass("selected");el.addClass("selected");this.trigger("selectRow",$(el).data(),$(el));this.selectedRowMv=$(el).data("mv")},selectFirstRow:function(){if(!this.options.enableSelectedRow){return}this.selectRow(this.$el.find("table tbody tr").first())},recoverSelectedRow:function(){if(!this.options.enableSelectedRow){return}if(this.selectedRowMv){var row=this.$el.find("tr[data-mv='"+this.selectedRowMv+"']");if(row.length>0){this.selectRow(row)}else{this.selectFirstRow()}}else{this.selectFirstRow()}}});IFB.Views.InstrumentListDynamicHeader=IFB.Views.InstrumentList.extend({});IFB.Views.InteractiveChart=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeChart)},SERIE_TYPE:{INTRADAY:2,HISTORIC:3},lightBoxOpened:false,serieType:null,baseUrl:IFB.Urls.InteractiveChartBaseUrl,contextMenuActions:{addIndicator:{functionName:"AnadirIndicadores",title:"Añadir Indicador"},addInstrument:{functionName:"AnadirValor",title:"Añadir Valor"},changeChartType:{functionName:"CambiarTipoGrafico",title:"Cambiar tipo de gráfico"}},initializeChart:function(){this.baseURL=this.options.flashConfig.baseURL||IFB.ClientConfiguration&&IFB.ClientConfiguration.Urls.InteractiveChartBaseUrl?IFB.ClientConfiguration.Urls.InteractiveChartBaseUrl:IFB.Urls.InteractiveChartBaseUrl;this.flashId=this.options.flashConfig.flashvars.componentID;this.mv=this.options.mv;this.serieType=this.options.flashConfig.flashvars.tipoSerie;this.createInteractiveChartFlashObject()},createInteractiveChartFlashObject:function(){var flashConfig=this.options.flashConfig;flashConfig.swf=this.options.flashConfig.swf||this.baseURL+"/InteractiveChart/WTGraficoInteractivoLogin.swf";flashConfig.flashvars.rootURL=this.options.flashConfig.flashvars.rootURL||this.baseURL+"/WTServerMG";flashConfig.flashvars.swfRootURL=this.options.flashConfig.flashvars.swfRootURL||this.baseURL+"/InteractiveChart";$("#"+this.flashId).flash(flashConfig)},getFlashId:function(){try{return $("#"+this.el.id).flash().attr("id")}catch(e){}},getChartXml:function(){return document.getElementById(this.getFlashId()).getXMLgraf()},openChartWithXML:function(xml){document.getElementById(this.getFlashId()).openChartWithXML(xml)},changeDataParam:function(mv,registerOnly){this.unregisterMV(this.mv);this.registerMV(mv);if(!registerOnly){document.getElementById(this.getFlashId()).sustituirGrafico(mv)}this.mv=mv},addIndicator:function(){if(this.lightBoxOpened){return}document.getElementById(this.getFlashId()).menuAction(this.contextMenuActions.addIndicator.functionName,this.contextMenuActions.addIndicator.title)},addInstrument:function(){if(this.lightBoxOpened){return}document.getElementById(this.getFlashId()).menuAction(this.contextMenuActions.addInstrument.functionName,this.contextMenuActions.addInstrument.title)},changeChartType:function(){if(this.lightBoxOpened){return}document.getElementById(this.getFlashId()).menuAction(this.contextMenuActions.changeChartType.functionName,this.contextMenuActions.changeChartType.title)},addDrawTool:function(data){document.getElementById(this.getFlashId()).anadirFigura(data.tool)},changeSerieChart:function(data){document.getElementById(this.getFlashId()).cambiarSerie(data.serie);this.serieType=data.serie},onOpenLightBox:function(){this.lightBoxOpened=true},onCloseLightBox:function(){this.lightBoxOpened=false},onUpdateData:function(data){var self=this;var chart=document.getElementById(self.getFlashId());if(chart&&_.isFunction(chart.datos)){_.each(data.V,function(msg){chart.datos(data.T,0,data.MV,data.C,msg.D,msg.V)})}},registerMV:function(mv){if(this.options.streaming){if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.register({wnd:this.cid,instruments:[mv],descriptors:[this.options.model.options.serviceParams.data.header],context:this,callback:this.onUpdateData,initload:1})}}},unregisterMV:function(mv){if(this.options.streaming){if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.unregister({wnd:this.cid,instruments:[mv],descriptors:[this.options.model.options.serviceParams.data.header],context:this,callback:this.onUpdateData})}}}});function eventChart(componentId,event,response){IFB.Events.trigger(event)}function getGMToffset(){var localTime=new Date;var gmtoffsetlocal=-1*localTime.getTimezoneOffset()/60;return gmtoffsetlocal}function initializeComplete(componentId){IFB.Events.trigger("interactiveChart_initializeComplete")}IFB.Views.Boleta=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)},notificationOnShow:false,validationErrors:[],sendLoginRequestClick:function(){},onSendOrderClick:function(){if(!IFB.Trader.accounts.length){var buttons=[{text:"Aceptar"}];IFB.Utils.Helper.showNotification("warning","No dispone de cuentas asociadas",true,buttons);return}if(this.notificationOnShow){return}if(this.validateOrder()){this.showConfirmOrder()}else{var buttons=[{text:"Aceptar"}];IFB.Utils.Helper.showNotification("warning",this.validationErrors[0].error,true,buttons)}},validateOrder:function(){var self=this;var data=IFB.Utils.Helper.serializeObject(this.$el);if(data.expireDate&&this.testDateInputFormatRaw(data.expireDate)){data.expireDate=moment(data.expireDate,this.model.DATE_INPUT_FORMAT_RAW).format(this.model.DEFAULTS_DATE_FORMAT)}var errorMessage=this.model.preValidate(data);if(errorMessage){self.validationErrors=[];_.each(errorMessage,function(error,attr){self.validationErrors.push({field:attr,error:error})});return false}else{this.model.setModel(data);return true}},showConfirmOrder:function(){var self=this;var buttons=[{text:"Aceptar",cls:"btnOkConfirmationOrder "+this.model.getSideCls(),callback:function(){self.sendOrder()}},{text:"Cancelar"}];var dataNotify={title:this.model.getSide()===IFB.Trader.sideOptions.BUY.value?"ORDEN DE COMPRA":"ORDEN DE VENTA",account:this.model.getAccount(),name:this.model.getName(),isin:this.model.getIsin(),sideOrder:this.model.getSide()===IFB.Trader.sideOptions.BUY.value?"COMPRA":"VENTA",qty:this.model.getVolume(),orderType:this.model.getOrderTypeText(),date:this.model.getExpireDate(),amount:this.model.getAmount(2),sideCls:this.model.getSideCls(),currency:this.model.getCurrency()};var orderType=this.model.getOrderType();if(orderType===IFB.Trader.orderTypeOptions.LIMIT.value||orderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){dataNotify.price=this.model.getPrice(3)}var execTypeText=this.model.getExceTypeText();if(execTypeText){dataNotify.execTypeText=execTypeText}if(orderType===IFB.Trader.orderTypeOptions.STOP.value||orderType===IFB.Trader.orderTypeOptions.STOP_MARKET.value||orderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){dataNotify.stopPrice=this.model.getStopPrice(3)}var maxFloor=this.model.getMaxFloor();if(maxFloor!=="0"){dataNotify.maxFloor=maxFloor}IFB.Utils.Helper.showNotificationConfirmOrder(dataNotify,buttons)},onVolumeChange:function(){if(this.validateField("volume")){this.changeAmount()}else{this.setFieldValue("amount",accounting.formatNumber(0,3))}},validateField:function(idField){var value=this.getFieldValue(idField);var errorMessage=this.model.preValidate(idField,value);var self=this;if(errorMessage){var buttons=[{text:"Aceptar",callback:function(){self.notificationOnShow=false}}];self.notificationOnShow=true;IFB.Utils.Helper.showNotification("warning",errorMessage,true,buttons);return false}else{return true}},onOrderTypeChange:function(arg0,arg1){var ordertype=arg1.val();this._setPriceProperties(ordertype);this._setStopPriceProperties(ordertype)},_setPriceProperties:function(ordertype){var priceField=$("#price",this.$el);if(ordertype===IFB.Trader.orderTypeOptions.LIMIT.value||ordertype===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){priceField.prop("disabled",false);this.setFieldValue("price",this.model.getPrice(3))}else{priceField.prop("disabled",true);this.setFieldValue("price","")}},_setStopPriceProperties:function(ordertype){var stopPriceLabelField=$("#stopPriceLabel",this.$el);var stopPriceField=$("#stopPrice",this.$el);if(ordertype===IFB.Trader.orderTypeOptions.STOP.value||ordertype===IFB.Trader.orderTypeOptions.STOP_MARKET.value||ordertype===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){stopPriceLabelField.removeClass("disable");stopPriceField.prop("disabled",false);stopPriceField.removeClass("disable")}else{stopPriceLabelField.addClass("disable");stopPriceField.prop("disabled",true);stopPriceField.addClass("disable")}},changeAmount:function(){var last=this.model.getRawValue("last");var volume=this.getUnformatFieldValue("volume");var amount=last*volume;if(_.isNumber(amount)&&!_.isNaN(amount)){this.model.set("volume",volume);$("#amount",this.$el).text(this.model.getAmount(2))}},getUnformatFieldValue:function(idField){var fieldValue=this.getFieldValue(idField);return accounting.unformat(fieldValue,accounting.settings.number.decimal)},getFieldValue:function(idField){return $("#"+idField,this.$el).val()||""},setFieldValue:function(idField,value){$("#"+idField,this.$el).val(value)},sendOrder:function(){var order=this.model.getOrderToTrader();var params={Order:order,callback:this.callbackNewOrder};IFB.Services.Trading.CONNECTION.newOrder(params,this)},callbackNewOrder:function(response,context){if(!response.status||!response.status.ok){IFB.Utils.Helper.showNotification("error","Se produjo un error al añadir la orden. Mensaje:<br/><b>'"+response.status.reason+"'</b>")}else{console.log("Orden añadida correctamente");window.history.back()}},onUpdateData:function(data){var self=this;_.each(data.V,function(msg){if(msg.D===IFB.Descriptors.Last.descriptor){self.model.set("last",msg.V);$("#last",self.$el).html(msg.V)}})},onCancelOrderClick:function(){window.history.back()},onRadioButtonConditionsClick:function(){var minVolumeField=$("#minQuantity",this.$el);minVolumeField.prop("disabled",true);minVolumeField.addClass("disable")},onRadioButtonMinQuantityCondition:function(){var minVolumeField=$("#minQuantity",this.$el);minVolumeField.prop("disabled",false);minVolumeField.removeClass("disable")},onCheckMaxFloorClick:function(arg0,arg1){var maxFloorField=$("#maxFloor",this.$el);maxFloorField.prop("disabled",!arg1.context.checked);maxFloorField.toggleClass("disable")},testDateInputFormatRaw:function(date){return/^\d{4}-\d{1,2}-\d{1,2}$/.test(date)}});IFB.Views.News=IFB.Views.Base.extend({heightScroll:200,initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments);if(this.options.initializeScrollOnInit!==false){this.on("rendered",this.initializeScroll)}},register:function(){if(!this.options.streaming){return}if(this.model.options.serviceParams.data.sources){sources=this.model.options.serviceParams.data.sources.replace(/;/g,",")}else if(this.model.options.serviceParams.data.source){sources=this.model.options.serviceParams.data.source.replace(/;/g,",")}else if(this.model.options.serviceParams.data.fuente){sources=this.model.options.serviceParams.data.fuente.replace(/;/g,",")}else if(this.model.options.serviceParams.data.fuentes){sources=this.model.options.serviceParams.data.fuentes.replace(/;/g,",")}if(this.lastRegisterCall){this.lastRegisterCall.sources=sources}else{this.lastRegisterCall={sources:sources}}if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.registerNot({wnd:this.cid,sources:this.lastRegisterCall.sources,context:this.options.component,callback:this.options.component.onUpdateNews})}},unregister:function(){this.domElementsMap={};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.unregisterNot({wnd:this.cid,sources:this.lastRegisterCall.sources,context:this.options.component,callback:this.options.component.onUpdateNews})}},onUpdateNews:function(){throw new Error("onUpdateNews: This method must be overrided")}});IFB.Views.OpenPositionList=IFB.Views.TraderBase.extend({initialize:function(){this.veces=3;IFB.Views.TraderBase.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeScroll);if(this.options.enableSort){if(this.options.sortConfig){this.sortConfig=_.defaults({},this.options.sortConfig,this.defaultSortConfig)}else{this.sortConfig=_.defaults({},this.defaultSortConfig)}this.subscribe("rendered",this.addSortCss,this)}if(this.options.streamingTrader){this.listenTo(this.model,"change:"+IFB.Descriptors.Trader.PortfolioBuyShares.descriptor,this.onChangePortfolioBuyShares);this.listenTo(this.model,"change:"+IFB.Descriptors.Trader.Assessment.descriptor,this.onChangeAssesment)}},createDescriptorsCalculated:function(){this.model.createDescriptorsCalculated()},onChangeAssesment:function(model){this.updateElementDOM(model,IFB.Descriptors.Trader.Assessment.descriptor)},onChangePortfolioBuyShares:function(model){this.updateElementDOM(model,IFB.Descriptors.Trader.PortfolioBuyShares.descriptor)},reset:function(){var self=this;var argumentsOrig=arguments;this.createDescriptorsCalculated();this._getInstrumentsPrice(function(dataInstruments){_.each(dataInstruments,function(data){if(data){self.model.setLastPrice(data.MV,data[IFB.Descriptors.Last.descriptor])}});IFB.Views.TraderBase.prototype.reset.apply(self,argumentsOrig)})},defaultSortConfig:{type:"string",direction:"asc",descriptor:IFB.Descriptors.Trader.PortfolioShortName.descriptor,css:{arrow:"sortArrow",asc:"activeUp",desc:"activeDown"}},getSortType:function(){try{return _.findWhere(IFB.Descriptors.Trader,{descriptor:this.sortConfig.descriptor}).sortType||"number"}catch(e){return"number"}},_getInstrumentsPrice:function(next){var self=this;self.options.component.dbService.loadDataLV({sesion:IFB.Services.Session,param:this.model.getInstrumentsList(),type:"4",header:"420",rt:"1"},function(result){var json=JSON.parse(result);if(json.answer&&json.answer.LV){var dataSet=json.answer.LV.V;if(!_.isArray(dataSet)){dataSet=[dataSet]}next(dataSet)}})},_registerInstrumentPrice:function(MV){var self=this;if(MV&&IFB.Services.Streaming.CONNECTION){this.lastRegisterCall.instruments=this.model.getInstrumentsArray();IFB.Services.Streaming.CONNECTION.register({wnd:self.cid,instruments:[MV],descriptors:[420],context:self,callback:self.onUpdateData,initload:1})}},onUpdateData:function(data){var self=this;if(data){if(data.MV&&data.V){_.each(data.V,function(descriptor){if(descriptor.D===IFB.Descriptors.Last.descriptor){self.model.setLastPrice(data.MV,descriptor.V)}});var model=self.model.getModelByMV(data.MV);if(model){this.updateInstrumentData(model.getInstrumentData(),data)}}}IFB.Views.TraderBase.prototype.onUpdateData.apply(this,arguments)},changeAccount:function(newAccountName){this.model.setSelectedAccount(IFB.Trader.getIdAccount(newAccountName));this.render()},updateElementDOM:function(element,descriptor){if(!descriptor||!element){return}var self=this;var key=element.getId();var keyDOM='[data-key="'+key+'"][data-descriptor="'+descriptor+'"]';if(!self.domElementsMap[keyDOM]){self.domElementsMap[keyDOM]=$(keyDOM,self.$el)}elements=self.domElementsMap[keyDOM];if(elements.length>0){self.updateTraderDOM(element,elements,element.getDescriptorValue(descriptor),[])}},onViewCollectionAddElement:function(elementModel){if(elementModel){elementModel.createDescriptorsCalculated();var MV=elementModel.getPortfolioMV();var mvExistsInArray=_.find(this.lastRegisterCall.instruments,function(mvInArray){return mvInArray===MV});if(!mvExistsInArray){this._registerInstrumentPrice(MV)}}IFB.Views.TraderBase.prototype.onViewCollectionAddElement.apply(this,arguments)}});IFB.Views.OrdersList=IFB.Views.TraderBase.extend({initialize:function(){IFB.Views.TraderBase.prototype.initialize.apply(this,arguments);this.on("rendered",this.initializeScroll);if(this.options.enableSort){if(this.options.sortConfig){this.sortConfig=_.defaults({},this.options.sortConfig,this.defaultSortConfig)}else{this.sortConfig=_.defaults({},this.defaultSortConfig)}this.subscribe("rendered",this.addSortCss,this)}},keyOrderToCancel:undefined,defaultSortConfig:{type:"string",direction:"asc",descriptor:IFB.Descriptors.Trader.ShortName.descriptor,css:{arrow:"sortArrow",asc:"activeUp",desc:"activeDown"}},getSortType:function(){try{return _.findWhere(IFB.Descriptors.Trader,{descriptor:this.sortConfig.descriptor}).sortType||"number"}catch(e){return"number"}},onCancellationOrderClick:function(params){this.keyOrderToCancel=params.key;if(IFB.Trader.showWindowConfirmationOrderBookCancel()){this.showCancelConfirmationDialog()}else{this.cancelOrder(this.keyOrderToCancel)}},showCancelConfirmationDialog:function(data){var self=this;var order=this.model.getElementById(this.keyOrderToCancel);var sideCls=order.getSideCls();var buttons=[{text:"Aceptar",cls:"btnOkConfirmationOrder "+sideCls,callback:function(){self.cancelOrder(self.keyOrderToCancel)}},{text:"Cancelar"}];var orderType=order.getOrderTypeFIX();var sideFIX=order.getSideFIX();var dataNotify={title:sideFIX==="C"?"CANCELAR COMPRA":"CANCELAR VENTA",account:order.getAccountFIX(),name:order.getShortName(),isin:order.getIsinFIX(),sideOrder:sideFIX==="C"?"COMPRA":"VENTA",qty:order.getQuantity(),orderType:IFB.Trader.getOrderTypeText(orderType),date:order.getExpireDateFIX(),sideCls:sideCls,currency:order.getCurrency()};if(orderType===IFB.Trader.orderTypeOptions.LIMIT.value||orderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){dataNotify.price=order.getPrice(3)}var execTypeText=order.getExceTypeText();if(execTypeText){dataNotify.execTypeText=execTypeText}if(orderType===IFB.Trader.orderTypeOptions.STOP.value||orderType===IFB.Trader.orderTypeOptions.STOP_MARKET.value||orderType===IFB.Trader.orderTypeOptions.STOP_LIMIT.value){dataNotify.stopPrice=order.getStopPriceFIX(3)}if(maxFloor!=="0"){dataNotify.maxFloor=maxFloor}var maxFloor=order.getMaxFloorFIX();if(maxFloor!=="0"){dataNotify.maxFloor=maxFloor}if(data&&data.commission){dataNotify.commission=data.commission}var intraday=order.isIntraday();if(typeof intraday!=="undefined"&&intraday.toLowerCase()!==""&&intraday.toLowerCase()!=="no"){dataNotify.intraday=true}IFB.Utils.Helper.showNotificationCancellationOrder(dataNotify,buttons)},cancelOrder:function(keyOrder){var order=this._getOrderToTrader(keyOrder);var params={orders:[order],callback:this.onOrderCancelled};IFB.Services.Trading.CONNECTION.cancelOrders(params,this);IFB.ActivityManager.notify(IFB.ActivityManager.COMPONENT.TRADING_ORDERS_BOOK,order.Side==IFB.Trader.sideOptions.BUY.value?IFB.ActivityManager.ACTION.CANCEL_BUY:Modulos.Comun.Actividad.GestorActividad.ACCION.CANCEL_SELL,order)},onOrderCancelled:function(response,context){responseJson=JSON.parse(response);if(!responseJson.status||!responseJson.status.ok){IFB.Utils.Helper.showNotification("error","Se produjo un error en la cancelación de la orden. Mensaje:<br/><b>'"+responseJson.status.reason+"'</b>")}else{var buttons=[{text:"Aceptar"}];IFB.Utils.Helper.showNotification("information","La cancelación de la orden ha sido enviada al mercado",true,buttons)}},_getOrderToTrader:function(keyOrder){var order=this.model.getElementById(keyOrder);var orderJson={OrderID:keyOrder,Side:order.getSideFIX()==="C"?IFB.Trader.sideOptions.BUY.value:IFB.Trader.sideOptions.SELL.value,ISIN:order.getIsinFIX(),Account:order.getAccountFIX(),Market:order.getMarketIB(),Value:order.getSymbolIB()};var userInfo=IFB.Utils.Helper.getUserInfo();if(userInfo&&userInfo.externalUser){orderJson.SenderLocationID=userInfo.externalUser}var intraday=order.isIntraday();if(typeof intraday!=="undefined"&&intraday.toLowerCase()!==""&&intraday.toLowerCase()!=="no"){orderJson.intradia=true}return orderJson}});IFB.Views.Positions=Backbone.View.extend({initialize:function(){_.extend(this,Backbone.Events);this.model.bind("reset",this.reset,this);this.lastRegisterCall=undefined;this.initializeStreamingConfiguration()},reconnectingRealTime:false,destroy:function(){if(this.options.streaming){if(this.lastRegisterCall){this.unregister()}IFB.Services.Streaming.CONNECTION.unsubscribe("RealTime_Reconnected")}this.undelegateEvents()},registerUnregister:function(){if(this.model.models.length>0){if(this.options.streaming){if(this.lastRegisterCall){this.unregister()}this.register()}}},reset:function(){var id=this.$el.attr("id");this.render();this.registerUnregister();this.publish("loaded",id)},render:function(){var self=this;var id=self.$el.attr("id");IFB.Utils.TemplateLoader.loadRemoteTemplate(this.options.templateId,this.options.templateFile,function(template){var compiled_template=_.template(template,{model:self.model,view:self});self.$el.html(compiled_template);self.publish("rendered",id)});this.clearDomElementsMap();return self},onFetchError:function(){},changeDataParam:function(){var self=this;return function(data){self.model.options.serviceParams.data.param=data;self.model.load()}},reload:function(serviceParams){this.model.load(serviceParams)},publish:function(topic,data){this.trigger(topic,data)},subscribe:function(topic,callback,context){this.on(topic,callback,context)},register:function(){if(!this.options.streaming){return}var instrumentsList=this.model.models?_.uniq(_.map(this.model.models,function(position){return position.getDescriptorValue("MV")})):[this.model.getDescriptorValue("MV")];this.lastRegisterCall={descriptors:(this.model.options.serviceParams.data.header||"").split(","),mv:instrumentsList.join(",")};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.registerPos({wnd:this.cid,mv:instrumentsList.join(","),descriptors:this.lastRegisterCall.descriptors,context:this,callback:this.onUpdateData})}},unregister:function(){this.domElementsMap={};if(IFB.Services.Streaming.CONNECTION){IFB.Services.Streaming.CONNECTION.unregisterPos({wnd:this.cid,mv:this.lastRegisterCall.mv,descriptors:this.lastRegisterCall.descriptors,callback:this.onUpdateData})}},onRender:function(){throw new Error("This method must be overrided")},initializeStreamingConfiguration:function(){if(!this.options.streaming){return}if(!this.options.topFlopCls||this.options.topFlopCls.length!==3){this.options.topFlopCls={top:"ifb-top",flop:"ifb-flop",equal:"ifb-equal"}}if(!this.options.hiEffectCls||this.options.hiEffectCls.length!==3){this.options.hiEffectCls={top:"ifb-highlight-top",flop:"ifb-highlight-flop",equal:"ifb-highlight-equal"}}if(!this.options.hiEffectMillis){this.options.hiEffectMillis=3e3}this.clearDomElementsMap();IFB.Services.Streaming.CONNECTION.subscribe("RealTime_Reconnected",this.realTimeReconnected,this)},realTimeReconnected:function(){this.reconnectingRealTime=true;this.reset()},clearDomElementsMap:function(){this.domElementsMap={}},onUpdateData:function(data){var self=this;var nPosition=data.C;var position=this.model.getElementById(nPosition);var key;var elements;if(!position){return}_.each(data.V,function(msg){var calculatedFields=[];key="[data-key='"+nPosition+"'][data-descriptor='"+msg.D+"']";if(!self.domElementsMap[key]){self.domElementsMap[key]=$(key,self.$el)}elements=self.domElementsMap[key];if(self.options.highlightUsesPrevLastTrend&&msg.D===IFB.Descriptors.Last.descriptor){self.storePrevLastTrend(position,msg.V)}if(elements.length>0){self.updateDOM(position,elements,msg.V,calculatedFields)}position.setDescriptorValue(msg.D,msg.V);self.updateCalculatedFields(position,calculatedFields)})},updateCalculatedFields:function(position,calculatedFields){},updateDOM:function(position,elements,value,calculatedFields){var self=this;_.each(elements,function(element){var el=$(element);var parent=$(el).parent();var dataType=el.attr("data-type");var dataDecimals=el.attr("data-decimals")||2;var dataDescriptor=el.attr("data-descriptor");var dataSuffix=el.attr("data-suffix")||"";var dataZeroValue=el.attr("data-zeroValue")||"";var dataPositiveSign=el.attr("data-positiveSign")||"";var difValue=self.getDifValue(position,$(el).attr("data-dif-reference")||IFB.Descriptors.Trend.descriptor,value);if(self.isColorizedElement(el)){self.updateColor(el,difValue)}else if(self.isColorizedElement(parent)){self.updateColor(parent,difValue)}if(dataType!=="silent"){var formatedValue=self.formatValue(value,dataType,Number(dataDecimals),dataZeroValue,dataPositiveSign,dataSuffix,position);el.html(formatedValue)}var descriptorNumber=dataDescriptor&&dataDescriptor.indexOf("D")===0?dataDescriptor.substring(1):dataDescriptor;if(!self.options.highlightDescriptors||self.options.highlightDescriptors.indexOf(descriptorNumber)!==-1){if(self.options.highlightUsesPrevLastTrend){var prevLastTrend=self.getDifValue(position,"PREV_LAST_TREND");self.highlight(el,prevLastTrend)}else{self.highlight(el,difValue)}}if(calculatedFields){var dataCalcTrigger=el.attr("data-calc-trigger");if(dataCalcTrigger){_.each(dataCalcTrigger.split(","),function(_field){var field=_field.toLowerCase();if(calculatedFields.indexOf(field)===-1){calculatedFields.push(field)}})}}})},formatValue:function(value,type,decimals,zeroValue,positiveSign,suffix,position){if(type==="number"){return position.formatValueAsNumber(value,decimals,zeroValue,positiveSign,suffix)}else if(type==="date"){return position.formatValueAsDate(value)}else if(type==="time"){return position.formatValueAsTime(value)}else if(type==="dateOrTime"){return position.formatValueAsDateOrTime(value)}return value},isColorizedElement:function(el){return $(el).hasClass(this.options.topFlopCls.top)||$(el).hasClass(this.options.topFlopCls.flop)||$(el).hasClass(this.options.topFlopCls.equal)},highlight:function(el,difValue){var self=this;var cls;if(difValue>0){cls=this.options.hiEffectCls.top}else if(difValue<0){cls=this.options.hiEffectCls.flop}else{cls=this.options.hiEffectCls.equal}el.addClass(cls);_.delay(function(el){el.removeClass(cls)},this.options.hiEffectMillis,el)},updateColor:function(el,difValue){el.removeClass(this.options.topFlopCls.top+" "+this.options.topFlopCls.flop+" "+this.options.topFlopCls.equal);if(difValue>0){el.addClass(this.options.topFlopCls.top)}else if(difValue<0){el.addClass(this.options.topFlopCls.flop)}else{el.addClass(this.options.topFlopCls.equal)}},getDifValue:function(position,descriptor,defaultValue){var value=descriptor?position.getDescriptorValue(descriptor)||defaultValue:defaultValue;if(descriptor===IFB.Descriptors.Trend.descriptor){return value==="1"?1:value==="2"?-1:0}return Number(value)},storePrevLastTrend:function(position,value){var decimals=position.getDescriptorValue(IFB.Descriptors.Decimals.descriptor)||4;var prevLast=position.getDescriptorValue(IFB.Descriptors.Last.descriptor)||0;var prevLastTrend=(value-prevLast).toFixed(decimals);position.setDescriptorValue("PREV_LAST_TREND",prevLastTrend)},initializeScroll:function(){if(IFB.Utils.Helper.isMobileWidth()){return}this.heightScroll=this.options.enableScroll?(this.options.heightScroll||this.heightScroll)+"px":"auto";if(this.options.enableScroll&&this.options.elScroll){$(this.options.elScroll.selector).parent().css("max-height",this.heightScroll);this.$el.find(this.options.elScroll.selector).scrollLayout()}},getNumber:function(value){if(value===undefined||value===""){return 0}else{return Number(value)}}});IFB.Views.SignificantFactNearby=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)}});IFB.Views.Static=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)}});IFB.Views.TopFlopActive=IFB.Views.Base.extend({initialize:function(){IFB.Views.Base.prototype.initialize.apply(this,arguments)}});IFB.Components.Accounts=IFB.Class(IFB.Components.Base,{create:function(){this.configure("Accounts","/WTServerTD/ServiceTrader.svc/GetAccountsJSON");this.setServiceParams();var model=new IFB.Collections.Accounts(this.config);var viewOptions=_.extend({model:model,component:this},this.config.viewOptions);var view=new IFB.Views.Accounts(viewOptions);this.registerView(view);this._addEvents(view);model.load();IFB.ActivityManager.notify(IFB.ActivityManager.COMPONENT.TRADING_POSITION,IFB.ActivityManager.ACTION.LOAD_ACCOUNTS,IFB.Trader.getAccountsArray())},setServiceParams:function(){},_addEvents:function(view){this.on("changeAccount",view.onAccountChange,view)},_changeAccountsParamValue:function(newAccountsParamValue){this.config.serviceParams.data.Accounts=newAccountsParamValue;this.destroyAllViews();this.create()}});IFB.Components.AlertList=IFB.Class(IFB.Components.Base,{LOADDATALV_HEADER:"40,10303,10305,10307",instrumentList:[],create:function(){var self=this;this.configure("AlertList","/wtmg/AlertaLista");self._doCreate()},_doCreate:function(){if(this.destroyRequested){this.destroyRequested=false;return}var self=this;this.model=new IFB.Collections.AlertList(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.AlertList(viewOptions);this.registerView(this.view);this.model.load();this._addEvents()},_addEvents:function(){var self=this;this.on("loaded",function(){var mvs=[];_.each(self.model.models,function(alert){mvs.push(alert.getUnderlyingMV())});mvs=_.uniq(mvs);self._loadInstrumentList(mvs)}).on("clickRemoveAlert",function(data,target,event){self._removeAlert(data)}).on("sortView",this.view.sortView,this.view)},_loadInstrumentList:function(arrayMVs){var self=this;var param=arrayMVs.join("");var config={serviceParams:{data:{header:this.LOADDATALV_HEADER,param:param,rt:0,type:4,sort:"10307"},reset:true,type:"GET",url:IFB.Services.baseURL+"/wtdb/LoadDataLV"}};this.instrumentList=new IFB.Collections.InstrumentList(config);this.instrumentList.load();this.instrumentList.on("reset",function(){self._mergeModels()})},_mergeModels:function(){var self=this;_.each(this.instrumentList.models,function(instrument){instrument.alerts=[];var name=instrument.getShortName();var mv=instrument.id;_.each(self.model.models,function(alert){if(alert.getUnderlyingMV()===mv){instrument.alerts.push(alert.id);alert.instrument=instrument}})});this.view.instruments=this.instrumentList.models;this.view.render()},_removeAlert:function(data){},getAlert:function(id){return this.model.get(id)},removeAlert:function(id,mv){this.model.remove(id);var instrument=this.instrumentList.get(mv);if(instrument){instrument.alerts=_(instrument.alerts).without(id)}this.view.render()}});IFB.Components.ChartColumnInstrumentList=IFB.Class(IFB.Components.Base,{initialize:function(options){this._templates=IFB.Defaults.Templates;IFB.Components.ChartColumnInstrumentList.parent.initialize.call(this,options)},create:function(){this.configure("InstrumentList","/wtdb/LoadDataLV");var model=new IFB.Collections.InstrumentList(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.ChartColumnInstrumentList(this.config.viewOptions);this.registerView(view);model.load()},refreshView:function(){if(this.views&&this.views[0]){this.views[0].view.refreshView()}}});IFB.Components.ChartDaily=IFB.Class(IFB.Components.ChartBase,{create:function(){var self=this;this.configure("ChartDaily","/wtdb/ChartDaily");self._getInstrumentSituation(this.config.serviceParams.data,function(data){self.config.serviceParams.data.mv=data.MV;self._doCreate(data)})},_doCreate:function(instrumentData){var model=new IFB.Collections.ChartDaily(this.config);this.config.viewOptions.model=model;var view=this._getView();var instrumentModel=new IFB.Models.Instrument(instrumentData);view.instrument=instrumentModel;this.registerView(view);model.load()},_getView:function(){return new IFB.Views.ChartDaily(this.config.viewOptions)},changeFrequencyChart:function(frequency,reload){var _reload=reload||true;try{this.config.serviceParams.data.frequency=frequency;if(_reload){this.reload()}}catch(e){}},changePeriodChart:function(period,reload){var _reload=_.isUndefined(reload)?true:reload;var amountPeriod=Number(period.substring(0,1));var typePeriod=period.substring(1);if(_reload){this.config.serviceParams.data.dateStart=moment().add(typePeriod,-amountPeriod).format("YYYYMMDD");this.config.serviceParams.data.dateEnd=moment().format("YYYYMMDD");this.reload()}else{this.zoom(moment().subtract(amountPeriod,typePeriod).utc(),moment().utc())}}});IFB.Components.ChartIntraday=IFB.Class(IFB.Components.ChartBase,{create:function(){var self=this;this.configure("ChartIntraday","/wtdb/ChartIntraday");this.originalConfig=IFB.Utils.Helper.clone(this.config);self._getInstrumentSituation(this.config.serviceParams.data,function(data){self.config.serviceParams.data.mv=data.MV;var gapAllowed=IFB.Utils.Helper.getPreOpeningDiffMinutes();var tradingHours=self.config.viewOptions.openingTime||data.D611;self.config.viewOptions.close=data.D370;if(!self._shouldBeSessionRequest(tradingHours,data.D60,data.D70,data.D10060,gapAllowed)){self._changeViewOptionsNotSessionRequest(data,self.config.serviceParams,self.config.viewOptions,2)}else{self._restoreViewOptions()}self._doCreate()})},_changeViewOptionsNotSessionRequest:function(data,serviceParams,viewOptions,isSession){serviceParams.data.isSession=isSession;var sessionDate=data.D60;if(sessionDate===moment().format("YYYYMMDD")){viewOptions.close=data.D10370;sessionDate=data.D10060;if(data.D10240>0){viewOptions.trend=1}else if(data.D10240<0){viewOptions.trend=2}}serviceParams.data.date=sessionDate},_restoreViewOptions:function(serviceParams){this.config.serviceParams.data.date=this.originalConfig.serviceParams.data.date;this.config.serviceParams.data.isSession=this.originalConfig.serviceParams.data.isSession},_doCreate:function(serviceParams){var model=new IFB.Collections.ChartIntraday(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.ChartIntraday(this.config.viewOptions);this.registerView(view);model.load()},update:function(){var self=this;this.dbService.chartIntraday({sesion:IFB.Services.Session,mv:this.config.serviceParams.data.mv,compressionMult:this.config.serviceParams.data.compressionMult,isSession:this.config.serviceParams.data.isSession,date:this.config.serviceParams.data.date,time:this.config.viewOptions.model.getLastTime()},function(result){var message=JSON.parse(result);if(message.status.ok&&message.answer.LST&&message.answer.LST.TV){var points=$.isArray(message.answer.LST.TV.T09)?message.answer.LST.TV.T09:[message.answer.LST.TV.T09];var view=self.views[0].view;if(points.length&&!view.chart.series[0].data.length){console.log("destruimos el gráfico")}var hasPreviousPoints=view.chart.series[0].data.length;_(points).each(function(point){var model=new IFB.Models.ChartIntradayPoint(point);self.config.viewOptions.model.add(model);if(hasPreviousPoints){var dataPoint=view.getHighchartPoint(self.config.serviceParams.data.date,model);view.chart.series[0].addPoint(dataPoint)}});if(!hasPreviousPoints){view.destroyAndRenderChart()}}})},changeFrequencyChart:function(frequency,reload){var _reload=reload||true;this.config.serviceParams.data.compressionMult=frequency;if(_reload){this.reload()}}});IFB.Components.ClickOn=IFB.Class(IFB.Components.Base,{codInstall:"",codCompany:"",codProduct:"",codSeller:"",company:"",product:"",codDoc:"",refuseEmailList:"",create:function(){var self=this;this.getFixedParams();this.getClickOnDocuments();this.on("rendered",function(){$("#clickOnDocument").html(self.htmlContent)});this.on("acceptClickOn",this.onAcceptClickOn,this);this.on("refuseClickOn",this.onRefuseClickOn,this);this.on("checkConditions",this.onCheckConditions,this)},getFixedParams:function(){var fixedParams=IFB.Utils.Helper.getClickOnDocumentsFixedParams();if(fixedParams){this.codCompany=fixedParams.CLICKON_CODCOMPANY;this.codProduct=fixedParams.CLICKON_CODPRODUCT;this.codSeller=fixedParams.CLICKON_CODSELLER;this.refuseEmailList=fixedParams.CLICKON_EMAILLIST}},getClickOnDocuments:function(){var si3Service=new IFB.Services.SI3({});var params={codUsr:this.options.params.Usr,codCompany:this.codCompany,codProduct:this.codProduct,codSeller:this.codSeller};si3Service.getClickOnDocuments(params,this.onClickOnDocuments,this)},onClickOnDocuments:function(response,scope){var clickOnDocument;response=JSON.parse(response);if(response.status.ok&&response.answer.DOCUMENTOS&&response.answer.DOCUMENTOS.DOCUMENTO){clickOnDocument=_.isArray(response.answer.DOCUMENTOS.DOCUMENTO)?response.answer.DOCUMENTOS.DOCUMENTO[0]:response.answer.DOCUMENTOS.DOCUMENTO;scope.codDoc=clickOnDocument.CODDOC;scope.htmlContent=clickOnDocument.CONTENT;scope.createComponent()}else{scope.trigger("clikcOnNoDocuments")}},createComponent:function(){this.configure();var model=new Backbone.Model(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.Static(this.config.viewOptions);this.registerView(view);view.reset()},onAcceptClickOn:function(){var self=this;var si3Service=new IFB.Services.SI3({});var params={codCompany:self.codCompany,codDoc:self.codDoc,codUser:self.options.params.Usr,codProduct:self.codProduct,codInstal:self.options.params.CodInstalacion,signDate:"",clientid:self.options.params.clientid,product:self.options.params.profileid};si3Service.signDocument(params,function(){self.trigger("clikcOnAccepted");self.destroy()})},onRefuseClickOn:function(){var self=this;var si3Service=new IFB.Services.SI3({});var mgService=new IFB.Services.Management({});var params={codCompany:self.codCompany,codUser:self.options.params.Usr,emailList:self.refuseEmailList,clientid:self.options.params.clientid,product:self.options.params.profileid};si3Service.notifyDeleteUser(params,function(){mgService.deleteExternalUser({entidad:self.options.params.appname,usuarioEntidad:self.options.params.clientid,producto:self.options.params.profileid},function(){self.destroy()})});this.trigger("clikcOnRefused")},onCheckConditions:function(data,eventTarget){$("#btnRefuse").toggleClass("disable");$("#btnAccept").toggleClass("disable");if(eventTarget.is(":checked")){$("#btnAccept").prop("disabled",false);$("#btnRefuse").prop("disabled",true)}else{$("#btnAccept").prop("disabled",true);$("#btnRefuse").prop("disabled",false)}}});IFB.Components.Dividends=IFB.Class(IFB.Components.Base,{create:function(){var self=this;this.configure("Dividends","/wtdb/LoadDividends");this.setServiceParams();this._doCreate()},_doCreate:function(){if(this.destroyRequested){this.destroyRequested=false;return}var self=this;this.model=new IFB.Collections.InstrumentList(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.InstrumentList(viewOptions);this.registerView(this.view);this.model.load()},setServiceParams:function(){this.setServiceParamSort();if(this.config.serviceParams.data.param&&this.config.serviceParams.data.param.indexOf(";")===-1){this.config.serviceParams.data.param=IFB.Utils.Helper.getConstituentsCode(this.config.serviceParams.data.param)}},setServiceParamSort:function(){var viewOptions=this.config.viewOptions;var sortConfig=viewOptions.sortConfig;if(viewOptions.enableSort&&sortConfig&&sortConfig.descriptor){var descriptor=sortConfig.descriptor.replace("D","");this.config.serviceParams.data.sort=sortConfig.direction&&sortConfig.direction==="desc"?"-"+descriptor:descriptor}}});IFB.Components.Events=IFB.Class(IFB.Components.InstrumentList,{defaultEventsQueryType:"1",create:function(){var self=this;this.configure("InstrumentList","/wtdb/LoadDataLV");this.setServiceParams();self._getEvents(function(){self._doCreate()})},_getEvents:function(next){var self=this;var mgService=new IFB.Services.Management({});var eventsParams=_.extend({sesion:IFB.Services.Session,consulta:this.eventsQueryType||this.defaultEventsQueryType},this.config.events);var callback={_function:self._parseEvents,params:function(){return next()}};mgService.getEvents(eventsParams,callback,self)},_parseEvents:function(response,context,next){throw new Error(200,"_parseEvents: This method must be overrided")}});IFB.Components.Form=IFB.Class(IFB.Components.Base,{create:function(){var self=this;this.configure();var model=new Backbone.Model(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.Static(this.config.viewOptions);this.registerView(view);view.reset();this.on("onSubmit",function(data,target){self._onSubmit(data,target)})},_onSubmit:function(data,target){var params=this._readFormParameters();this.trigger("sendForm",params)},_deletePrefix:function(str){var result="";var className=str;if(str){result=str.replace(/field-/g,"")}return result},_readFormParameters:function(){var self=this;var fields=$("[class*='field-']");var result={};var key="";var value="";var classes;_.each(fields,function(field,index){classes=$(field).attr("class").match(/field-\w+/);key=self._deletePrefix(classes[0]);var value=$(field).val();if(key){result[key]=value}});return result}});IFB.Components.HeaderSelector=IFB.Class(IFB.Components.Base,{fileType:"HDU",fileTransform:"0",create:function(){var self=this;this.configure("Columnado","/wtdb/Columnado");this.mgService=new IFB.Services.Management({});this.dbService=new IFB.Services.Database({});this.model=new IFB.Collections.Columnado(this.config);this.model.title=this.options.title;this.model.bind("reset",this.onColumnadoLoaded,this);this.model.load();this.addEvents()},addEvents:function(){this.on("saveUserHeader",this.saveUserHeader,this)},onColumnadoLoaded:function(){var self=this;this.model.groupedHeader=_.groupBy(this.model.models,function(col){return col.attributes.groupName});this.model.userHeader=this.options.userHeader||undefined;if(_.isUndefined(this.model.userHeader)){self.loadUserHeader(function(dataHeader){var jsonDataHeader=JSON.parse(dataHeader);if(jsonDataHeader.status&&jsonDataHeader.status.ok&&jsonDataHeader.answer[self.fileType]){self.model.userHeader=self.createUserHeader(jsonDataHeader.answer[self.fileType].Data.Header);self.createView()}else{self.loadColumnadoDefault(function(dataHeader){jsonDataHeader=JSON.parse(dataHeader);self.model.userHeader=self.createUserHeader(jsonDataHeader.answer.Header);self.createView()})}})}else{self.createView()}},getNumLeftFixedColumns:function(){var numberOfLeftFixedColumns=0;var checkLeftColumns=true;_.each(this.model.userHeader.models,function(col){if(checkLeftColumns&&col.isFixed()){numberOfLeftFixedColumns++}else{checkLeftColumns=false}});return numberOfLeftFixedColumns},createUserHeader:function(userHeader){var headerModelList=[];_.each(userHeader.Col,function(header){headerModelList.push(new IFB.Models.Columnado(header))});var header=new IFB.Collections.Header(headerModelList);header.numLeftFixedColumns=userHeader.numLeftFixedColumns;return new IFB.Collections.Header(headerModelList)},loadUserHeader:function(next){this.mgService.loadFile({session:this.session||IFB.Services.Session,file:this.options.file,type:this.fileType,transform:this.fileTransform},function(response){next(IFB.Utils.Helper.UTF8_decode(response))})},loadColumnadoDefault:function(next){this.dbService.columnado({session:this.session||IFB.Services.Session,columnado:this.options.service.columnado,tipo:"1",defecto:"1",agrupado:"0"},function(response){next(response)})},saveUserHeader:function(){var content=this.serializeHeader();var self=this;this.mgService.saveFile({session:this.session||IFB.Services.Session,file:this.options.file,type:this.fileType,transform:"0",content:content,replace:"1"},function(response){self.trigger("userHeaderSaved",{file:self.options.file},self)})},serializeHeader:function(){throw new Error("This method must be overrided")},createView:function(){var self=this;var viewOptions=_.extend({model:self.model},self.config.viewOptions);this.model.userHeader.numLeftFixedColumns=this.model.userHeader.numLeftFixedColumns||this.getNumLeftFixedColumns();view=new IFB.Views.HeaderSelector(viewOptions);self.registerView(view);view.reset()}});IFB.Components.HistoricalPrices=IFB.Class(IFB.Components.ChartDaily,{initialize:function(options){IFB.Components.HistoricalPrices.parent.initialize.call(this,options)},_doCreate:function(instrumentData){var model=new IFB.Collections.ChartDaily(this.config);this.config.viewOptions.model=model;var view=this._getView();var instrumentModel=new IFB.Models.Instrument(instrumentData);view.instrument=instrumentModel;this.registerView(view);model.load()},_getView:function(){return new IFB.Views.HistoricalPrices(this.config.viewOptions)}});IFB.Components.InstrumentBase=IFB.Class(IFB.Components.Base,{create:function(){throw new Error(200,"create must be implemented")},_doCreate:function(serviceParams){throw new Error(200,"_doCreate must be implemented")},changeDataParam:function(param){var self=this;if(_.isArray(this.views)){var data=self.config.serviceParams.data;data.param=self.translateMarket(param);self._getInstrumentSituation(data,function(mv){self.views.forEach(function(viewDef){if(viewDef.options.updatable){viewDef.view.changeDataMvParam()(mv,self.config.viewOptions)}})})}},_preloadTimeStatus:function(options,next){var self=this;var data=_.defaults(options,{type:"1",header:"611,60,70"});this._getInstrumentSituation(data,function(result){var instruments=result&&result.V?_.isArray(result.V)?result.V:[result.V]:undefined;if(instruments&&instruments.length>0&&self.historicDescriptorsConverter){self.tradeTimeStatus=IFB.Utils.TradeTimeUtils.getTradeTimeStatusFromList(instruments,self.config.viewOptions.openingTime);if(self.tradeTimeStatus.getStatus()==="preopening"){self.config.serviceParams.data.header=self.historicDescriptorsConverter.convertDescriptors(self.config.serviceParams.data.header,"current_to_historic")}else{self.config.serviceParams.data.header=self.historicDescriptorsConverter.convertDescriptors(self.config.serviceParams.data.header,"historic_to_current")}}next(result)})},_parseDataPreopeningState:function(data){var self=this;if(this.historicDescriptorsConverter&&this.tradeTimeStatus&&this.tradeTimeStatus.getStatus()==="preopening"){var result=[];_.each(_.isArray(data)?data:[data],function(original){var instrument=self.historicDescriptorsConverter.convertData(original,"historic_to_current");instrument.PREOPENING_STATUS=self.tradeTimeStatus.getStatus();if(instrument[IFB.Descriptors.Date.descriptor]){var dateOrTime="F"+instrument[IFB.Descriptors.Date.descriptor];instrument[IFB.Descriptors.DateOrTime.descriptor]=dateOrTime;instrument[IFB.Descriptors.DateOrTimeSituationMessage.descriptor]=dateOrTime}if(!instrument[IFB.Descriptors.Trend.descriptor]){var value=Number(instrument[IFB.Descriptors.Change.descriptor]||instrument[IFB.Descriptors.ChangePercent.descriptor]);instrument[IFB.Descriptors.Trend.descriptor]=value>0?"1":value<0?"2":"0"}result.push(instrument)});return result}return data}});IFB.Components.InstrumentDetail=IFB.Class(IFB.Components.InstrumentBase,{model:undefined,view:undefined,create:function(){var self=this;this.configure("InstrumentDetail","/wtdb/LoadDataLV");this._configureComponent(undefined,function(){self._doCreate()})},changeDataParam:function(param){this.config.serviceParams.data.param=param;this.destroyAllViews();this.create()},reload:function(param){var self=this;this._configureComponent(undefined,function(){IFB.Components.InstrumentBase.prototype.reload.apply(self,arguments)})},_doCreate:function(){var self=this;this.model=new(IFB.Collections.InstrumentList.extend({parse:function(){return self._parseDataPreopeningState(IFB.Collections.InstrumentList.prototype.parse.apply(this,arguments))}}))(this.config);this.config.viewOptions.model=this.model;this.view=new IFB.Views.InstrumentDetail(this.config.viewOptions);this.registerView(this.view);this.model.load()},_getCurrentModel:function(){return this.model&&_.isArray(this.model.models)&&this.model.models.length>0?this.model.models[0]:undefined},get:function(param){var currentModel=this._getCurrentModel();if(!currentModel){return undefined}return typeof currentModel.getDescriptorValue==="function"?currentModel.getDescriptorValue(param):undefined},_checkInstrumentInGroup:function(mv,groups,next){var self=this;this.dbService.instrumentInGroup({sesion:IFB.Services.Session,mv:mv,agrupaciones:groups},function(result){var json=JSON.parse(result);if(json.answer&&json.answer.Respuesta&&json.answer.Respuesta.Datos){next(json.answer.Respuesta.Datos.Existe==="1")}})},_configureComponent:function(param,next){var self=this;this.historicDescriptorsConverter=IFB.Utils.Helper.getHistoricDescriptorsConverter();this.FACTSETDescriptorsManager=IFB.Utils.Helper.getFACTSETDescriptorsManager();if(this.historicDescriptorsConverter||this.FACTSETDescriptorsManager){var data={type:this.config.serviceParams.data.type||"6",param:param||this.config.serviceParams.data.param};this._preloadTimeStatus(data,function(instrument){self._checkFACSETDescriptors(instrument,next)})}else{next()}},_checkFACSETDescriptors:function(result,next){var self=this;var instrument=result&&result.V?_.isArray(result.V)?result.V[0]:result.V:undefined;if(instrument){if(this.FACTSETDescriptorsManager){var groups=this.FACTSETDescriptorsManager.getValidGroups(self.config.serviceParams.data.header);if(groups){self._checkInstrumentInGroup(instrument.MV,groups,function(enabled){if(!enabled){self.config.serviceParams.data.header=self.FACTSETDescriptorsManager.removeDescriptors(self.config.serviceParams.data.header)}next(result)})}else{next(result)}}else{next(result)}}else{next(result)}}});IFB.Components.InstrumentList=IFB.Class(IFB.Components.InstrumentBase,{create:function(){var self=this;this.configure("InstrumentList","/wtdb/LoadDataLV");this.setServiceParams();this._configureComponent(undefined,function(){self._doCreate()})},changeDataParam:function(param){this.config.serviceParams.data.param=param;this.destroyAllViews();this.create()},reload:function(param){var self=this;this._configureComponent(undefined,function(){IFB.Components.InstrumentBase.prototype.reload.apply(self,arguments)})},_doCreate:function(){if(this.destroyRequested){this.destroyRequested=false;return}var self=this;this.model=new(IFB.Collections.InstrumentList.extend({parse:function(){return self._parseDataPreopeningState(IFB.Collections.InstrumentList.prototype.parse.apply(this,arguments))}}))(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.InstrumentList(viewOptions);this.registerView(this.view);this.on("sortView",this.view.sortView,this.view);this.model.load()},setServiceParams:function(){this.setServiceParamSort();if(this.config.serviceParams.data.param&&this.config.serviceParams.data.param.indexOf(";")===-1){this.config.serviceParams.data.param=IFB.Utils.Helper.getConstituentsCode(this.config.serviceParams.data.param)}},setServiceParamSort:function(){var viewOptions=this.config.viewOptions;var sortConfig=viewOptions.sortConfig;if(viewOptions.enableSort&&sortConfig&&sortConfig.descriptor){var descriptor=sortConfig.descriptor.replace("D","");this.config.serviceParams.data.sort=sortConfig.direction&&sortConfig.direction==="desc"?"-"+descriptor:descriptor}},showChartIntraday:function(chartEl,ticker){var chartComponent=new IFB.Components.ChartIntraday({config:"portfolioOverview_Detail_chartIntraday",view:{el:chartEl,closeLine:true},service:{param:ticker,type:4}})},isInstrumentInPortfolio:function(marketCod,isin){var portfolioData=this.options.portfolioData;if(portfolioData){var portfolios=_.isArray(portfolioData)?portfolioData:[portfolioData];return _.any(portfolios,function(portfolio){if(_.isArray(portfolio)){return _.any(portfolio,function(portfolioAsset){return portfolioAsset.marketCod===marketCod&&portfolioAsset.isin===isin})}else{return portfolio.marketCod===marketCod&&portfolio.isin===isin}})}return false},_configureComponent:function(param,next){var self=this;this.historicDescriptorsConverter=IFB.Utils.Helper.getHistoricDescriptorsConverter();this.FACTSETDescriptorsManager=IFB.Utils.Helper.getFACTSETDescriptorsManager();if(this.historicDescriptorsConverter||this.FACTSETDescriptorsManager){var data={type:this.config.serviceParams.data.type,param:param||this.config.serviceParams.data.param};this._preloadTimeStatus(data,function(){next()})}else{next()}}});IFB.Components.InstrumentListDynamicHeader=IFB.Class(IFB.Components.InstrumentList,{_doCreate:function(){var self=this;var viewOptions;this.model=new(IFB.Collections.InstrumentList.extend({parse:function(){return self._parseDataPreopeningState(IFB.Collections.InstrumentList.prototype.parse.apply(this,arguments))}}))(this.config);viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.InstrumentListDynamicHeader(viewOptions);this.registerView(this.view);this.on("sortView",this.view.sortView,this.view);this.on("showDynamicHeaderToolTip",this.showDynamicHeaderToolTip);this.model.load();this.model.headerList=this.createHeaderCollection(this.options.header);this.model.headerToolTipList=this.createHeaderCollection(this.options.headerToolTip)},setServiceParams:function(){this.setServiceParamSort();this.setHeaderParam();this.config.serviceParams.data.param=IFB.Utils.Helper.getConstituentsCode(this.config.serviceParams.data.param)},setHeaderParam:function(){this.config.serviceParams.data.header=_.map(this.options.header,function(header){return header.descriptor.replace("D","")}).join()},createHeaderCollection:function(source){var headerList=[];_.each(source,function(header){headerList.push(new IFB.Models.Header(header))});return new IFB.Collections.Header(headerList)},showDynamicHeaderToolTip:function(){throw new Error(200,"showDynamicHeaderToolTip: This method must be overrided")},changeColumns:function(oldField,newField){var header=this.options.header;var indexOfOldField=this.arrayObjectIndexOf(this.options.header,"descriptor",oldField);header[indexOfOldField]={descriptor:newField,dynamic:true};this.changeHeader();this.reload()},changeHeader:function(){var header=this.options.header;this.setHeaderParam();this.model.headerList=this.createHeaderCollection(header)},changeHeaderToolTip:function(){var header=this.options.headerToolTip;this.model.headerToolTipList=this.createHeaderCollection(header)},arrayObjectIndexOf:function(myArray,property,searchTerm){var i;for(i=0,len=myArray.length;i<len;i++){if(myArray[i][property]===searchTerm){return i}}return-1}});IFB.Components.InstrumentListHeader=IFB.Class(IFB.Components.InstrumentList,{userHeader:undefined,create:function(){var self=this;this.configure("InstrumentList","/wtdb/LoadDataLV");this.setServiceParams();this._configureComponent(undefined,function(){self.loadDataFromHeader(function(){self._doCreate()})})},_doCreate:function(){if(this.destroyRequested){this.destroyRequested=false;return}var self=this;this.model=new(IFB.Collections.InstrumentList.extend({parse:function(){return self._parseDataPreopeningState(IFB.Collections.InstrumentList.prototype.parse.apply(this,arguments))}}))(this.config);this.model.userHeader=this.userHeader;var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.InstrumentList(viewOptions);this.registerView(this.view);this.on("sortView",this.view.sortView,this.view);this.model.load()},loadDataFromHeader:function(next){var self=this;var jsonDataHeader;self.loadUserHeader(function(dataHeader){jsonDataHeader=JSON.parse(dataHeader);if(jsonDataHeader.status&&jsonDataHeader.status.ok&&jsonDataHeader.answer.HDU){self.createUserColumnado(jsonDataHeader.answer.HDU.Data.Header);self.config.serviceParams.data.header=_.pluck(jsonDataHeader.answer.HDU.Data.Header.Col,"ID").join(",");self.config.headerRT=_.pluck(_.where(jsonDataHeader.answer.HDU.Data.Header.Col,{RT:"1"}),"ID").join(",");next()}else{self.loadDefaultHeader(function(dataHeader){jsonDataHeader=JSON.parse(dataHeader);if(jsonDataHeader.status&&jsonDataHeader.status.ok&&jsonDataHeader.answer.Header){self.createUserColumnado(jsonDataHeader.answer.Header);self.config.serviceParams.data.header=_.pluck(jsonDataHeader.answer.Header.Col,"ID").join(",");self.config.headerRT=_.pluck(_.where(jsonDataHeader.answer.Header.Col,{RT:"1"}),"ID").join(",")}next()})}})},createUserColumnado:function(userHeaderData){var headerModelList=[];_.each(userHeaderData.Col,function(header,index){headerModelList.push(new IFB.Models.Columnado(header))});this.userHeader=new IFB.Collections.Header(headerModelList);this.userHeader.numLeftFixedColumns=userHeaderData.numLeftFixedColumns},loadDefaultHeader:function(next){var dbService=new IFB.Services.Database({});dbService.columnado({session:this.session||IFB.Services.Session,columnado:this.config.serviceParams.header.columnado,tipo:"1",defecto:"1",agrupado:"0",descriptoresAdicionales:this.config.serviceParams.header.descriptoresAdicionales||""},function(response){next(response)})},loadUserHeader:function(next){var mgService=new IFB.Services.Management({});var file=this.config.configHeaderSelector&&this.config.configHeaderSelector.file?this.config.configHeaderSelector.file:this.options.configHeaderSelector&&this.options.configHeaderSelector.file?this.options.configHeaderSelector.file:this.options.config;mgService.loadFile({session:this.session||IFB.Services.Session,file:escape(file),type:"HDU",transform:"0"},function(response){next(IFB.Utils.Helper.UTF8_decode(response))})},openSelectorHeader:function(){var self=this;var component=this.getComponentHeaderSelector();component.on("closeClick",function(){self.trigger("componentSelectorHeaderClose")});component.on("userHeaderSaved",function(){self.trigger("componentSelectorHeaderSave");self.onSaveUserHeader()});component.on("rendered",function(){self.trigger("componentSelectorHeaderRendered")});this.componentSelectorHeader=component},getComponentHeaderSelector:function(){throw new Error("This method must be overriden")},reload:function(param){var self=this;this._configureComponent(undefined,function(){self.loadDataFromHeader(function(){self.model.userHeader=self.userHeader;IFB.Components.InstrumentBase.prototype.reload.apply(self,arguments)})})},onSaveUserHeader:function(param){this.reload()}});IFB.Components.InstrumentVsIndex=IFB.Class(IFB.Components.Base,{create:function(){var self=this;this.configure("InstrumentDetail","/wtdb/LoadDataLV");var model=new IFB.Collections.InstrumentList(this.config);model.bind("reset",function(model){self.loadReferenceIndex(model)});model.load()},loadReferenceIndex:function(instrumentModel){var self=this;var instrument=instrumentModel.models[0];var referenceIndex=instrument?instrument.get(IFB.Descriptors.ReferenceIndex.descriptor):undefined;if(referenceIndex){var referenceIndexModel=new IFB.Collections.InstrumentList(this.config);referenceIndexModel.bind("reset",function(_referenceIndexModel){self.createViewFromModels(instrumentModel,_referenceIndexModel)});referenceIndexModel.load({param:referenceIndex,type:4})}else{self.createViewFromModels(instrumentModel)}},createViewFromModels:function(instrumentModel,indexModel){if(indexModel&&indexModel.models&&indexModel.models.length>0){instrumentModel.models.push(indexModel.models[0])}this.config.viewOptions.model=instrumentModel;var view=new IFB.Views.InstrumentList(this.config.viewOptions);this.registerView(view);view.reset()}});IFB.Components.InteractiveChart=IFB.Class(IFB.Components.Base,{create:function(){_.extend(IFB.Events,Backbone.Events);this.configure();this.config.MV=this.config.viewOptions.mv;var model=new IFB.Models.Instrument(this.config);model.options={serviceParams:{data:{header:this.config.serviceParams.data.header}}};this.config.viewOptions.model=model;var view=new IFB.Views.InteractiveChart(this.config.viewOptions);this.registerView(view);this.view=view;view.reset();this.addEvents()},initialize:function(options){IFB.Components.InteractiveChart.parent.initialize.call(this,options)},changeDataParam:function(param){this.view.changeDataParam(param)},addEvents:function(){this.on("iconCloseClick",this.onIconCloseClick,this);this.on("iconResizeClick",this.onIconResizeClick,this);this.on("addIndicator",this.view.addIndicator,this.view);this.on("addInstrument",this.view.addInstrument,this.view);this.on("changeChartType",this.view.changeChartType,this.view);this.on("addDrawTool",this.view.addDrawTool,this.view);this.on("changeSerieChart",this.view.changeSerieChart,this.view);IFB.Events.on("OPEN_LIGHTBOX",this.view.onOpenLightBox,this.view);IFB.Events.on("CLOSE_LIGHTBOX",this.view.onCloseLightBox,this.view);IFB.Events.on("interactiveChart_initializeComplete",this.onInteractiveChartInitializeComplete,this)},onIconResizeClick:function(data){},onIconCloseClick:function(data){}});IFB.Components.NewsCriteria=IFB.Class(IFB.Components.News,{callConfigure:function(){this.configure("NewsCriteria","/wtdb/NoticiasCriterios");this.config.serviceParams.data.param=this._configureParam(this.config)},_configureParam:function(config){var serviceParams=config.serviceParams;return"0;"+serviceParams.searchFunc+";"+serviceParams.data.sources+","+serviceParams.data.fromDate+",,"+(serviceParams.data.toDate||serviceParams.data.fromDate)+",,,"+(serviceParams.data.isin||"")+","+(serviceParams.numberOfItems||"")+",,,"+(serviceParams.data.detailFormat||"")}});IFB.Components.NewsDetail=IFB.Class(IFB.Components.Base,{callConfigure:function(){this.configure("News","/wtdb/News")},create:function(){this.callConfigure();var model=new IFB.Collections.NewsDetail(this.config);var viewOptions=_.extend({model:model,component:this},this.config.viewOptions);var view=new IFB.Views.News(viewOptions);this.registerView(view);model.load()}});IFB.Components.OpenPosition=IFB.Class(IFB.Components.Base,{create:function(){this.configure("OpenPosition","GetOpenPositionJSON");this.setServiceParams();this.model=new IFB.Collections.OpenPositionList(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);var view=new IFB.Views.OpenPositionList(viewOptions);this.registerView(view);this._addEvents(view);this.model.load();IFB.ActivityManager.notify(IFB.ActivityManager.COMPONENT.TRADING_POSITION,IFB.ActivityManager.ACTION.LOAD_OPEN_POSITION,IFB.Trader.getAccountsArray())},setServiceParams:function(){this.setServiceParamSort()},setServiceParamSort:function(){var viewOptions=this.config.viewOptions;var sortConfig=viewOptions.sortConfig;if(viewOptions.enableSort&&sortConfig&&sortConfig.descriptor){var descriptor=sortConfig.descriptor.replace("D","");this.config.serviceParams.data.sort=sortConfig.direction&&sortConfig.direction==="desc"?"-"+descriptor:descriptor}},_addEvents:function(view){this.on("sortView",view.sortView,view);this.on("openDetailClick",view.onOpenDetail,view)}});IFB.Components.OrdersBook=IFB.Class(IFB.Components.Base,{create:function(){this.configure("OrdersBook","/WTServerTD/ServiceTrader.svc/GetOrderBookJSON");this.setServiceParams();var model=new IFB.Collections.OrdersList(this.config);var viewOptions=_.extend({model:model,component:this},this.config.viewOptions);this.view=new IFB.Views.OrdersList(viewOptions);this.registerView(this.view);this._addEvents(this.view);model.load();IFB.ActivityManager.notify(IFB.ActivityManager.COMPONENT.TRADING_ORDERS_BOOK,IFB.ActivityManager.ACTION.LOAD_ORDER_BOOK,IFB.Trader.getAccountsArray())},setServiceParams:function(){this.setServiceParamSort()},setServiceParamSort:function(){var viewOptions=this.config.viewOptions;var sortConfig=viewOptions.sortConfig;if(viewOptions.enableSort&&sortConfig&&sortConfig.descriptor){var descriptor=sortConfig.descriptor.replace("D","");this.config.serviceParams.data.sort=sortConfig.direction&&sortConfig.direction==="desc"?"-"+descriptor:descriptor}},_addEvents:function(view){this.on("sortView",view.sortView,view);this.on("cancellationOrderClick",view.onCancellationOrderClick,view);this.on("openDetailClick",view.onOpenDetail,view)}});IFB.Components.Positions=IFB.Class(IFB.Components.Base,{create:function(){var self=this;this.configure("Positions","/wtdb/LoadDataPosiciones");this.setServiceParams();self._doCreate()},changeDataParam:function(param){this.config.serviceParams.data.param=param;this.destroyAllViews();this.create()},reload:function(param){var self=this;IFB.Components.Base.prototype.reload.apply(self,arguments)},_doCreate:function(){if(this.destroyRequested){this.destroyRequested=false;return}var self=this;this.model=new IFB.Collections.Positions(this.config);var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.Positions(viewOptions);this.registerView(this.view);this.model.load()},setServiceParams:function(){this.config.serviceParams.data.param=IFB.Utils.Helper.getConstituentsCode(this.config.serviceParams.data.param)}});IFB.Components.Search=IFB.Class(IFB.Components.Base,{model:undefined,view:undefined,searchPattern:undefined,create:function(){this.configure("InstrumentList","/wtdb/LoadDataLV");this.model=new IFB.Collections.InstrumentList(this.config);this.model.bind("reset",this._onSearchReady,this);this.searchPattern=IFB.Utils.ProductConfig.getBuscadorHTPattern();if(IFB.Components.Search.lastCall){this.search(IFB.Components.Search.lastCall)}},search:function(stringToSearch){IFB.Components.Search.lastCall=stringToSearch;if(this.view){this.destroy()}var searchParam=this.searchPattern.replace("{0}",stringToSearch.trim());searchParam=searchParam.replace("{1}","");this.model.load({param:searchParam,type:"2"})},_onSearchReady:function(model){if(!this.view){var viewOptions=_.extend({model:this.model,component:this},this.config.viewOptions);this.view=new IFB.Views.InstrumentList(viewOptions);this.registerView(this.view)}else{this.view.$el.scrollTop(0)}this.view.reset()}});IFB.Components.Search.lastCall=undefined;IFB.Components.SignificantFactNearby=IFB.Class(IFB.Components.InstrumentBase,{create:function(){var self=this;this.configure("SignificantFactNearby","/wtdb/HechoRelevanteCercano");_.extend(this.config.viewOptions,this.getMarketCodIsinFromParam(this.config.requestedParam));var dataParams={type:this.config.serviceParams.data.type,header:"611",param:this.config.serviceParams.data.param};this._getInstrumentSituation(dataParams,function(data){if(data&&data.V&&data.V.MV){self.config.serviceParams.data.type="4";self.config.serviceParams.data.param=data.V.MV;self._doCreate()}else{self._doCreate()}})},_doCreate:function(serviceParams){var model=new IFB.Collections.SignificantFacts(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.SignificantFactNearby(this.config.viewOptions);this.registerView(view);model.load()},getMarketCodIsinFromParam:function(param){if(param&&param.length>12){return{marketCod:param.substring(12),isin:param.substring(0,12)}}},showNoData:function(){$(this.config.viewOptions.el).append("<p>No hay información</p>")}});IFB.Components.Static=IFB.Class(IFB.Components.Base,{create:function(){this.configure();var model=new Backbone.Model(this.config);this.config.viewOptions.model=model;var view=new IFB.Views.Static(this.config.viewOptions);this.registerView(view);view.reset()}});IFB.Components.TopFlopActive=IFB.Class(IFB.Components.Base,{view:undefined,create:function(){this.configure("TopFlopActive","/wtdb/LoadDataMasSubenBajanContratan");this.config.serviceParams.data.param=IFB.Utils.Helper.getConstituentsCode(this.config.serviceParams.data.param);var model=new IFB.Collections.InstrumentList(this.config);this.config.viewOptions.model=model;this.view=new IFB.Views.TopFlopActive(this.config.viewOptions);this.registerView(this.view);model.load()}});
